Constituents are referred to any chemical compound or a group of chemical compounds with assumed effective transport parameters that can present in aqueous phase or be sorbed to soil matrix or particles. In addition some biological agents such as bacteria or algae can also be treated as constituents. There is no pre-defined constituents in GIFMod and the user should introduce them and assign transformation processes to them. In this section the governing equations and different processes that can be assigned to constituents in GIFMod will be described. The general mass balance equation for fate and transport of constituents in GIFMod is:
\begin{equation}
\label{eq:26}
\begin{split}
\frac{d\Gamma_{i,p,l} C_{p,l,i,k}}{dt} =\\ \beta_{p,l} \sum_{j=1}^{nj} pos \big(Q_{ij}+(v_{s,p,ij}+v_{c,k,ij})A_{ij}\big)\tilde G_{p,l,j}C_{p,l,j,k} \\ -\beta_{p,l} \sum_{j=1}^{nj} pos \big(-Q_{ij}-(v_{s,p,ij}+v_{c,p,ij})A_{ij}\big)\tilde G_{p,l,j}C_{p,l,j,k}\bigg]\\
-S_i \big(\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}\tilde G_{p,l,i}C_{p,l,i,k}-\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}\tilde G_{p,l',i}C_{p,l',i,k}\big)\\
+ \beta_{p,l} \sum_{j=1}^{nj} A_{ij}\frac{D_{p,ij,k}}{d_{ij}}(\tilde G_{p,l,j}C_{p,l,j,k}-\tilde G_{p,l,i}C_{p,l,i,k}) \\
+ S_i \sum_{p=-1}^{np} \sum_{l'=1}^{nl_p}\kappa_{k,p,p'}\bigg(\frac{C_{p',l',i,k}}{\phi_{k,p'}}-\frac{C_{p,l,i,k}}{\phi_{k,p}}\bigg)  \\ +S_i \sum_{r=1}^{nr} \psi_{r,k}R_r + S_i \xi_{p,l,i,k} \\
+ \sum_j^{ns} pos(Q_{s,j} \tilde G_{p,l,j,in} C_{p,l,j,k,in}) - \sum_j^{ns} pos(-\omega_{p,l,j} Q_{s,j} \tilde G_{p,l,j,in} C_{p,l,j,k,in}) + \dot{m}_{i,p,l,k}
\end{split}
\end{equation}
In Eq. \ref{eq:26}, the first two terms of the right hand side represent dissolved and particle-bound advective transport due to flux and settling, the third term is the mass exchange of constituents between phases due to exchange of particles, the forth term is dispersion due to the dispersion due to both dispersion of particle-bound and dissolved constituents, the fifth term is the mass exchange through adsorption and desroption, the six term represents biogeochemical transformation, the seventh term is external flux (such as aeration), and eight and night terms are respectively sources or sinks due to inflow and outflow or plant uptake. Subscript $p=-1$ represent the solid matrix and $p=0$ represent the aqueous phase while a $p>0$ refer to the particle class. $\tilde G_{p,l,j}$ is the same as $G_{p,l,j}$ in Eq. \ref{eq:20} for $p>0$, is equal to $1$ for $p=0$ (dissolved species) and equal to bulk density, $\rho_i$ for $p=-1$ (soil matrix). Subscript $in$ indicate the values in the inflow. Also in this equation $D_{p,ij,k}$ is the dispersion/diffusion coefficient for particles when $p>0$ (particles) and constituent's dispersion/diffusion coefficient when $p=0$ (dissolved species). Also Sorption capacity, $\phi_{k,p}$, is equal to partitioning coefficient $K_D$ for soil and particles ($p=-1$ and $p>0$ respectively) and equal to 1 for dissolved species ($p=0$).  

\subsection{Constituent properties}
In this section the properties of constituents are described. To  add a new constituent right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Constituents} and click on \textbf{Add Constituent}. \\
Below the properties of constituents are described.
\begin{itemize}
\item %help:100086
\textbf{Name: } This is the name of the constituent. Names of constituents should be unique. Constituent names will be used in producing outputs and also when entering the reaction network. 
\item \textbf{Diffusion coefficient: } This specifies the molecular diffusion coefficient of the constituent. When calculating the mechanical dispersion, this value will be added to the dispersion coefficient calculated based on the dispersivity value entered for each connector. %help:end
\item %help:100112
\textbf{Exchange rate factor: } This bring a window where the user can enter the solid-aqueous phase rate $\kappa_{k,p,p'}$ in Eq. \ref{eq:26} and partitioning coefficient $K_D$ with respect to soil matrix and each particle class. %help:end
\item %help:100128
\textbf{Partitioning coefficient: } This bring a window where the user can enter the solid-aqueous phase rate $\kappa_{k,p,p'}$ in Eq. \ref{eq:26} and partitioning coefficient $K_D$ with respect to soil matrix and each particle class. %help:end
\item %help:100250
\textbf{Settling velocity: } The settling velocity of the constituent, $v_c$. %help:end
\end{itemize}

\subsection{Reactions}
In order to define reactions two steps are needed. First some reaction parameters will be defined that can represent reaction rate constants, half-saturation coefficients, stoichiometric constants and other parameters needed in defining the reaction process. It shoule be noted that a user can define reactions by explicitly entering parameter values into reaction expressions however this approach is not advised. The second step is to enter reaction rate expressions and stoichiometric constants into a Petersen matrix \citep{russell2006}. 

\textit{Reactions Parameters: }\\
To add a reaction parameter right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction Parameters} and click on \textbf{Add Reaction Parameter} from the drop down menu. Select the reaction parameter that was added to change its properties.
\begin{itemize}
\item %help:100092
\textbf{Name: } Name of the reaction parameter to be used in defining reaction expressions. %help:end
\item %help:100152
\textbf{Temperature correction factor: } Specifies the dependency of the value of the reaction rate parameter to temperature. Under variable temperature condition the value of the reaction parameter entered in the \textbf{Value} field represent the value of the parameter in $20^oC$. The value at other temperatures is calculated as: 
\begin{equation}
\label{eq:27}
k_T = k_{20} \Theta^{T-20}
\end{equation}%help:end
\item %help:100157
\textbf{Value: } The value of the parameter. Please note that the unit used for the parameter value should be consistent with other units used in the model. The time dimension of the value is always days. %help:end
\end{itemize}
\textit{Reactions: }\\
In order to enter reaction rate expressions and stoichiometric constants right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction Parameters} and click on \textbf{Open Reaction Network Window} from the drop down menu. A window as shown in Figure \ref{fig:20}. The headings of this table consists of a process name, a process rate and columns each representing the stoichiometric constants for each of the constituents defined in the model. Additional processes (reactions) can be added using the \textbf{Add Processes} at the bottom of the window and existing processes can be removed using the \textbf{Remove Process} bottom. \textbf{Process Name} is were the user-assigned name of the process is entered. In the process rate column the user can enter the rate expression of the process. The rate expression can include concentrations of constituents, reaction parameters and also physical parameters such as light, temperature or even velocity. The values entered under the columns identified by name of constituents indicate how much of a constituent is produced or consumed as a result of a unit progress in the reaction. A negative stoichiometric constant is indicative of consumption of the constituent as a result of the reaction while a positive value results in production of the constituent. The following example shows how to set up a simple reaction in GIFMod. 
\begin{figure}[!ht]\label{fig:20}
\begin{center}
\includegraphics[width=8cm]{Images/Figure20.png} \\
\caption{Reaction window} 
\end{center}
\end{figure}

\input{ASM_ex.tex}In this section it is explained how to impose an external flux or atmospheric exchange of one or a few constituents into the model. This feature can be used to for example incorporate the flux of dissolved oxygen as a result of aeration in a water quality model or to model the influx of contaminant, organic matter and nutrients separate from the inflows. Several influx models are provided in GIFMod as described below: 
\begin{itemize}
\item \textbf{Constant influx model: } In this model the flux is assumed to be constant: 
\begin{equation}
\label{eq:28}
J_{ext} = k_{ext}
\end{equation}
So the external influx of a constituent will be calculated as: 
\begin{equation}
\label{eq:29}
\dot{m} = A_s k_{ext}
\end{equation}

\item \textbf{Constant rate model: } In this model the flux is assumed to be proportional to the difference between the concentration of a constituent and a saturation concentration $C_s$: 
\begin{equation}
\label{eq:30}
J_{ext} = k_{ext}(C_s-C)
\end{equation}
Which is applied volumetrically. So the external influx of a constituent will be calculated as: 
 \begin{equation}
\label{eq:30a}
\dot{m} = k_{ext}(C_s-C) \sout{V}
\end{equation}

\item \textbf{Free surface model: } The free surface model is used for open-channel reaeration where the flow depth and velocity affect the rate of aeration. The for of the flux equation is consistent with the forms suggested by \citep{oconnor1956,churchill1964,owens1964some,isaacs1968,langbein1967}:
\begin{equation}
\label{eq:31}
J_{ext} = k_{ext}v^{\alpha_{ext}}H^{\beta_{ext}}(C_s-C)
\end{equation}


\item \textbf{Soil model: } Aeration in soils is expected to be limited by the area of air-water interface. In this model it is assumed that the area of the air-water interface is proportional to the moisture content and air content of the soil. The external flux equation for soils is therefore considered as: 

\begin{equation}
\label{eq:32}
J_{ext} = k_{ext}\theta (\theta_s-\theta) (C_s-C)
\end{equation}
Which is applied volumetrically. So the external influx of a constituent will be calculated as: 
 \begin{equation}
\label{eq:33}
\dot{m} = k_{ext}\theta (\theta_s-\theta) (C_s-C) \sout{V}
\end{equation}
\end{itemize}
\subsubsection{External Flux Properties: }
An external flux model must be added by right-clicking \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{External Fluxes} and clicking on \textbf{Add External Flux} and then be assigned to individual blocks through the \textbf{External Flux} property of the block. 

Below properties that can be assigned to a \textbf{External flux} model are described: 

\begin{itemize}
\item %help:100087
\textbf{Name: } This is the name of the external flux model. The name is used to assign the model to individual blocks. %help:end
\item %help:100100
\textbf{Coefficient: } Here the value of $k_{ext}$ in Eqs. (\ref{eq:28}, \ref{eq:30}, \ref{eq:31}, \ref{eq:32}) can be entered. This is needed for all external flux models. %help:end
\item %help:100103
\textbf{Constituent: } This indicate the constituent that will be released as a result of the external flux. %help:end
\item %help:100106
\textbf{Depth exponent: } The value of $\beta_{ext}$ in the free surface model. %help:end
\item %help:100123
\textbf{Model: } Here the type of the model to be used for the external flux will be selected. %help:end
\item %help:100141
\textbf{Saturation: } The value of saturation concentration $C_s$ used in the \textbf{constant rate}, \textbf{free surface}, \textbf{soil} will be entered here. %help:end
\item %help:100146
{Solid: } Indicates the solid phase (soil or particles) that the external flux will be assigned to. If left empty the influx occur as dissolved. %help:end
\item %help:100155
\textbf{Transfer Rate Expression: } This property allows the user to type in an expression to be used for the calculation of the external flux rates. %help:end
\item %help:100158
\textbf{Velocity Exponent: } The value of $\alpha_{ext}$ in free surface model (Eq. \ref{eq:31}). %help:end
\end{itemize}

\input{Aeration_ex.tex}\section{Some theoretical background: } 

GIFMOD is equipped with two inverse modeling modules including a maximum-likelihood (deterministic) parameter estimation and a Bayesian probabilistic parameter estimation. The deterministic parameter estimation approach uses a Hybrid Genetic Algorithm to find combination of model parameters maximizing the likelihood of observing the measured data which the Bayesian approach uses Markov Chain Monte Carlo (MCMC) algorithm to produce samples of parameters representing the joint posterior distribution of model parameters designated to be estimated by the program. 

GIFMOD allows for any of the parameters in the model to be treated as unknown parameters and be estimated by providing their prior distributions while allowing the user to choose between three types of prior distributions: including normal, log-normal, and uniform. 
The observed data can be specified to represent any of the state variables in the model including hydraulic (i.e.  flow rates, head, cross- sectional areas), as well as particle and constituent concentrations at each block. As is typically done in Bayesian inference, the error here is defined as a quantity encompassing measurement error, model structural error, and all other errors resulting from the uncertainties associated with the external forcing (input data) such as weather data, inflow rates, and concentrations, etc. The general form of the model error structure can be expressed using the following equation: 

\begin{equation}
\label{eq:im1}
\tilde Y(t) = \xi^{-1}[\xi[Y(t)]+\epsilon]
\end{equation}
where $Y$ is the vector containing the model’s observed constituents, $\tilde Y(t)$ represents the observed data vector, $\xi$ represents the error structure function (e.g., for log-normal error structure, $\xi$ is the natural logarithm function, while for Gaussian error structure, $\xi$ is the identity function), and $\epsilon$ is a random vector containing transformed measurement, structural and external forcing errors, which is assumed to collectively follow a multivariate normal distribution. 
The Bayes’ theorem \citep{kaipio2006} can be used to obtain the joint probability distribution of parameters given the observed data, namely, the posterior distribution of the parameters as:
\begin{equation}
\label{eq:im2}
p(\vec{\Psi}|\vec{\tilde Y})=\frac{p(\vec{\tilde Y}|\vec{\Psi}) p(\vec{\Psi})}{p(\vec{\tilde Y})}
\end{equation}

where $p(\vec{\tilde Y}|\Psi)$ is the likelihood function that is the probability of observing the measured data $\vec{\tilde Y}$ given a parameter set $\vec{\Psi}$, $p(\vec{\Psi})$ represents the prior knowledge about the parameters and error structure, and $p(\vec{\tilde Y})$ is a normalizing factor. $\vec{\Psi}$ in Eq. (\ref{eq:im2}) contains all the parameters that are intended to be estimated using the observed data and the elements of the variance-covariance matrix for the random error term $\epsilon$ in eq. (\ref{eq:im1}). The likelihood of observing $\vec{\tilde Y}(t)$ given a parameter set $\vec{\Psi}$ or simply the likelihood function $p(\vec{\tilde Y}|\Psi) = p(\vec{\tilde Y}|\vec{Y},\vec{\Gamma})$ can be theoretically calculated based on the error structure. If the errors due to the uncertainties associated with the external forcing are considered part of the observation error, then the external forcing can be considered deterministically, and thus the model outputs become a function of only model parameters. In this case, the error function can be re-written as $p(\vec{\tilde Y}|\vec{\Phi},\vec{\Gamma})$. In theory, each element of the variance-covariance matrix $\vec{\Gamma}$ should be estimated as part of the parameter estimation. However, this makes the total number of parameters to be estimated very large and imposes a large computational burden. Therefore, observation errors of different constituents are typically assumed to be independent, and the correlations between observed concentration errors of different constituents are ignored \citep{walsh2012}. By making this assumption, the variance-covariance matrix becomes diagonal. If it is also assumed that errors of consecutive observations of individual data-sets used in parameter estimation are independent of each other, then the likelihood function of the observed vector can be computed as a function of the model parameters:
\begin{equation}
\label{eq:im3}
p(\vec{\tilde Y}|\vec{\Psi})=\frac{\prod_{i=1}^{NT} \prod_{j=1}^{NS_i} \xi'(\tilde y_{ij})}{(2 \pi \prod_{i=1}^{NT} \sigma_i^2)^{NS_i/2}}exp\bigg[-\sum_{i=1}^{NT} \sum_{j=1}^{NS_i} \frac{(y_{ij}-\tilde y_{ij})^2}{2 \sigma_i^2}\bigg]
\end{equation}

where $\tilde y_{ij}\in \vec{\tilde Y}$ is the $j^{th}$ data point of observed concentration of observed state variable $i$, $NT$ is the total number of different measured state variables, $j$ indicates the time and location of the measurement. $NS_i$ is the number of total samples (in time or location) of observed state variable $i$. The mapping function $\xi$ in the likelihood function can be assumed to be any transformation depending on the distribution of the observed data or by performing trial and error to find the best transformation by comparing the posterior residuals with the presumed error structure, and $\xi'$ is its derivative. For example, considering $\xi$ to be the identity function implies a normally distributed and additive error structure, while assuming $\xi$ to be the logarithm function results in a log-normally distributed and multiplicative error structure. Other error structures can be obtained by selecting a corresponding mapping function. $y_{ij}\in \vec{Y}$  is the predicted concentration of constituent $i$ at time/location $j$. $\sigma_i$ is the standard deviation of observed constituent $i$. When the deterministic parameter estimation approach based on maximum likelihood approach is to be applied to estimate the parameters, the values of parameters that maximize Eq. \ref{eq:im3} \citep{montgomery2010} are found  using a hybrid genetic algorithm. 
The second term in the numerator of Eq. \ref{eq:im2} represents the prior knowledge about the probability density of the parameters. This information can be obtained from literature reviews, experts’ experience, or independently performed experimental results.
In the probabilistic parameter estimation module, the MCMC algorithm \citep{gamerman2006} is used to generate random samples according to the posterior distribution in Eq. \ref{eq:im2}. The MCMC algorithm implemented in the program is based on the Metropolis-Hasting method \citep{metropolis1953}. MCMC algorithm that is implemented into GIFMOD automatically adjusts the perturbation factors to achieve an acceptance rate provided by the user. In the next section the way to set up an inverse problem in GIFMOD and the parameters adjusted by the user in order to do so are described.  
\section{Defining parameters and observed data}
In order to perform an inverse modeling, parameters and observed data should first be introduced. Parameters should be assigned to the specific properties of the model and each set of observed data should be attributed to a specific output of the model. 
\subsection{Defining parameters and adjusting their properties: }
In order to add a parameter to the model right click on \textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and then click on \textbf{Add parameters}. Each parameter has the following properties: 

\begin{itemize}
    \item \textbf{Name: } This indicates the name that is assigned to a parameter. The name of the parameter will be used to assign the parameter to specific properties of the model and when generating the results of inverse modeling.
    \item \textbf{Value: } This is the value that will be assigned to the parameter if the modeling is conducted in forward mode. 
    \item \textbf{Maximum Value: } In deterministic inverse modeling, this indicates the upper bound for the parameter (search domain). In probabilistic inverse modeling, it indicates the 97.5 percentile of the prior distribution for this parameter. 
    \item \textbf{Minimum Value: } In deterministic inverse modeling, this indicates the lower bound for the parameter (search domain). In probabilistic inverse modeling, it indicates the 2.5 percentile of the prior distribution for this parameter.
    \item \textbf{Prior distribution: } Indicates the mathematical form of the prior distribution of the parameters. The choices provided include \textbf{Normal}, and \textbf{Lognormal}. The mean and standard deviation of the prior distributions are calculated based on the maximum and minimum values. 
\end{itemize}

\subsection{Defining observed data and assigning their properties: }
Observed data can be added by right-clicking on \textbf{Inverse Modeling}$\rightarrow$\textbf{Observations} and then clicking on \textbf{Add observation}. Each observation includes a time-series representing an state variable of the model. Each observation has the following properties: 

\begin{itemize}
    \item \textbf{Name: } The name of an observation is used when generating results in deterministic and probabilistic inverse modeling. 
    \item \textbf{Standard Deviation ID: } This is an identification that is used to group observations that will be assigned the same standard deviation. The total number of groups of observations is equivalent to the parameter $NT$ in Eq. \ref{eq:im3}. The observations having the same \textbf{Standard Deviation ID} will be grouped together and a single observation error standard deviation, $\sigma_i$ will be assigned to them. 
    \item \textbf{Block/connector: } This indicates whether the state variable to the observation correspond to is a block or a connector state variable. Concentrations, storages, hydraulic heads are always block state variables, while flow rates and interface areas are connector state variables. 
    \item \textbf{Error distribution: } This indicates the error structure ($\xi$) in Eq. \ref{eq:im1} that is used when computing the likelihood value.
    \item \textbf{Location: } Indicate the block or the connector that this observed data corresponds to. 
    \item \textbf{Observed data: } This field allows loading the observed data time-series. The observed data time series is a .csv text file that should consist of two columns first representing times of measurement and the second the observed values. 
    \item \textbf{Quantity: } This field allows selecting the state variable that the observed data corresponds to. As for water quality and particles the drop-down menu containing the selectable state variables is populated depending on the constituents, phases, and particle types available. 
    
\end{itemize}
\subsection{Example: Estimation of bio-kinetic parameters of nitrification processes from an batch test: }
This case represent interpretation of an actual experiment to determine the rates of microbial activities during ammonia and nitrite oxidation. Four experiments were conducted using the same sludge sample. The variation of dissolved oxygen with respect to time was measured for each of the four experiments. The initial conditions for each of the experiments is shown in Table \ref{table:inverse_example} and the observed variation of DO for the four cases are shown in Figure \ref{fig:inverse_example1}. 

\begin{table}[]
    \centering
    \begin{tabular}{c|c c c c}
       Experiment  & $NO_3^{-1}(mg/L) $ & $NH_3(mg/L)$ & $DO(mg/L)$ & $VSS(mg/L)$ \\
    \hline
        No Spike & 0 & 0 & UK* &  730  \\
        $NO_2^{-1}$ Spike & 50 & 0 & UK & 695 \\
        $NH_3$ Spike & 0 & 50 & UK & 645 \\
        $NO_2^{-1}$ and $NH_3$ & 50 & 50 & UK & 660\\ 
    \end{tabular}
    \caption{Initial condition for the declining DO test aimed at estimating AOB and NOB biokinetics. *- UK: The initial condition for DO is treated as a parameter to be estimated by the model}
    \label{table:inverse_example}
\end{table}

The processes considered in the model are shown in table \ref{table:inverse_example2}. The only constituents that will be explicitly considered in the model include $DO$, $NH_3$, $NO_2^{-1}$, and $VSS$. $VSS$ is used as a surrogate for biomass (i.e. it is assumed to be proportional to AOB, NOB and OHO) and it is also assumed to stay unchanged throughout each experiment. the Petersen matrix is shown in table \ref{table:inverse_example3}.

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure35.png} \\
\caption{Temporal variation of DO for the four different experiments used to estimate nitrification bio-kinetics parameters}\label{fig:inverse_example1}
\end{center}
\end{figure}

\begin{table}[]
    \centering
    \begin{tabular}{l l}
       Process & Reaction Expression \\
    \hline
        Ammonia oxidation (AO) & $21.9O_2 + \frac{21.9}{3.43}NH_3 \rightarrow \frac{21.9}{3.43}NO_2^{-1}$  \\
        Nitrite oxidation (NO) & $11.7O_2 + \frac{11.7}{1.14}NO_2^{-1} \rightarrow \frac{11.7}{1.14}NO_3^{-1}$ \\
        Ordinary heterotrophic growth (OHO) & $BOD + O_2 \rightarrow CO_2$ \\
    \end{tabular}
    \caption{Reactions considered in the nitrification bio-kinetics parameter estimation example}
    \label{table:inverse_example2}
\end{table}


\begin{table}[]
    \centering
    \begin{tabular}{l|c |c c c c}
       Process & Rate Expression & $O_2$ & $NH_3$ & $NO_2^{-1}$ & VSS  \\
    \hline
        AO & $VSS \mu_{AOB} \frac{[O_2]}{(k_{OA} + [O_2]}\frac{[NH_3]}{[NH_3]+k_{NH3}}$ & -21.9 & $-\frac{21.9}{3.43}$ & $\frac{21.9}{3.43}$ &   \\
        NO & $VSS \mu_{NOB} \frac{[O_2]}{k_{ON} + [O_2]}\frac{[NO_2^{-1}]}{[NO_2^{-1}]+k_{NO2}}$ & $-11.7$ &  & $-\frac{11.7}{1.14}$ &   \\
        OHO & $VSS \mu_{OHO} \frac{[O_2]}{k_{OH}+[O_2]}$ & $-\frac{1-0.52}{0.52}$ & & &  \\
    \end{tabular}
    \caption{Petersen matrix for the nitrification bio-kinetics parameter estimation example}
    \label{table:inverse_example3}
\end{table}

\begin{table}[]
    \centering
    \begin{tabular}{l|c c c}
       Parameter & 2.5\% & 97.5\% & Distribution  \\
    \hline
        $\mu_{AOB}$ & 0.005 & 0.5 & lognormal \\
        $k_{OA}$ & 0.05 & 2.0 & lognormal \\
        $\mu_{NOB}$ & 0.005 & 0.5 & lognormal \\
        $k_{ON}$ & 0.05 & 2.0 & lognormal \\
        $k_{NH3}$ & & FIXED = 0.5 & \\
        $k_{NO2}$ & & FIXED = 0.5 & \\
        $\mu_{OHO}$ & 0.0001 & 0.1 & lognormal \\
        $k_{OH}$ & 0.00125 & 10 & lognormal \\
    \end{tabular}
    \caption{Prior range of parameters used in nitrification bio-kinetics example}
    \label{table:inverse_example4}
\end{table}

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=12cm]{Images/Figure36.png} \\
\caption{Reaction network for the nitrification parameter estimation example}\label{fig:inverse_example2}
\end{center}
\end{figure}    


Table \ref{table:inverse_example4} shows the prior 95\% ranges and the prior distributions of each of the parameters. In this particular case due to lack of information about $NH_3$ and $NO_2^{-1}$ concentration variation with time if $k_{NH3}$, and $k_{NO2}$ are considered unknown, there is a risk of problem becoming over-parametrized and therefore, we here assume the values of these two parameters to be fixed.   

\subsubsection{Steps to set-up the model: }
To construct the model in GIFMod follow the following steps: 
\begin{itemize}
    \item \textbf{Add a pond: } We will simulate the reactor using a \textbf{Pond} block. Other media types can also be used. Add a pond by clicking on the pond icon \includegraphics[width=0.5cm]{Icons/pond_icon.png} on the top tool bar. Set the following properties for the pond: \\
    - \textbf{Area: } 1$m^2$\\
    - \textbf{Initial water depth: } 1m\\
    \item \textbf{Add the constituents: } Add constituents ($DO$, $NH_3$, $NO_2^{-1}$, $VSS$) by right-clicking on \textbf{Water quality}$\rightarrow$\textbf{Constituents}. \item \textbf{Adding experiments: } The goal of this example is to infer the values of reaction parameters using four experiments in a holistic way. This means that the best parameter set that can collectively explain the results from the four experiments in sought for. There are two ways to consider four experiments in the model. The first way is to define four independent ponds with different initial conditions and the second way is to use \textbf{Experiments}. Here we will use the second approach. \\ To add experiments click on the \textbf{Add new experiment} button \includegraphics[width=0.3cm]{Icons/newexperiment_icon.png} three times to add three new experiments. 
    
    \item \textbf{Setting the duration of the simulation: } The duration of the experiments are all below 0.2 days. First from the experiment menu on the top tool bar select \textbf{All experiments}. This forces the program to apply any changes in the properties to all the experiments. To set the simulation duration to 0.2 from \textbf{Settings}$\rightarrow$\textbf{Project settings} and from the \textbf{Properties} window right-click on the label for \textbf{Simulation end time} and click on \textbf{Enter number} from the drop-down menu that appears. Enter 0.2 in the dialog box that appears. 
    
    \item \textbf{Adding reaction parameters: } Add the eight reaction parameters by right-clicking on \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction parameters} according to table \ref{table:inverse_example4}. For the two fixed parameters $k_{NH3}$ and $k_{NO2}$, enter a value of 0.5. 
    \textbf{Add reaction network: } Right click on reaction  \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction network}. Enter the processes according to the Petersen matrix shown in table \ref{table:inverse_example3}. The finished reaction network window should look like figure \ref{fig:inverse_example2}.\\
    \item \textbf{Setting initial conditions: } From the \textbf{Experiments} drop-down menu on the top tool bar, select \textbf{Experiment1}. Click on the pond block and then from the \textbf{Properties} window choose \textbf{Constituent initial conditions}. Enter the initial conditions for experiment 1 according to Table \ref{tab:inv_ini_cond}.
   \begin{table}[]
    \centering
    \begin{tabular}{l|c c c c}
       Experiment & $DO(mg/L)$ & $NH_3(mg/L)$ & $NO_2^{-1}(mg/L)$ & VSS (mg/L) \\
    \hline
        1 & 7.78 & 0 & 0 & 730 \\
        2 & 7.76 & 50 & 0 & 645 \\
        3 & 8.02 & 0 & 50 & 695 \\
        4 & 7.8 & 50 & 50 & 660 \\
    \end{tabular}
    \caption{Initial conditions for the four experiments used for estimation of bio-kinetics and stoichiometric parameters of nitrification}
    \label{tab:inv_ini_cond}
\end{table} 
    
    The initial condition window for the first experiment should look like Figure \ref{fig:42}. 
    
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure42.png} \\
\caption{Initial conditions for the nitrification inverse modeling example}\label{fig:42}
\end{center}
\end{figure}  

Change the experiment to experiment2 from the \textbf{experiments} drop down menu and similarly set the initial condition according to the second row of table \ref{tab:inv_ini_cond}. 

Similarly assign the initial conditions for experiment 3 and 4. 
    
    \item \textbf{Setting up parameters to be estimated: } Add a parameter representing $\mu_{AOB}$ by right-clicking of \textbf{Inverse modeling}$\rightarrow$\textbf{Parameters} and clicking on \textbf{Add parameters} from the drop-down menu. Assign the following parameter to the newly added parameter:\\
    - \textbf{Name:} $\mu_{AOB}$\\
    - \textbf{Maximum value: } \textit{0.5}\\
    - \textbf{Minimum value: } \textit{0.005}\\
    - \textbf{Distribution: } \textit{Log-Normal}\\
    Repeat for the other parameters to be estimated including $k_{OA}$, $\mu_{NOB}$, $k_{ON}$, $\mu_{OHO}$,
and $k_{OH}$ and assign the ranges and the distribution according to table \ref{table:inverse_example4}. As for the \textbf{Value} of the parameters respectively use $\mu_{AOB}=0.05$, $k_{OA}=0.31$, $\mu_{NOB}=0.05$, $k_{ON}=0.31$, $\mu_{OHO}=0.003162$, $k_{OH}=0.111$. These values are used when the model is run in forward mode. \\Please note that the name of the parameters should not be identical to their corresponding reaction parameters. \\


\item \textbf{Assigning the parameters to the corresponding model properties: } The parameters defined in the previous step should not be assigned to their corresponding properties in the model. Choose the reaction parameter $\mu_{AOB}$ from \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction parameters}, and the right click on the label of \textbf{Value} property and from the drop-down menu select \textbf{Parameters}$\rightarrow$\textbf{$\mu_{AOB}$} figure \ref{fig:inverse_example3}.

\item \textbf{Setting observations: } Here we specify the properties of the observed data used to perform the parameter estimation. \\ Right-click on \textbf{Project explorer}$\rightarrow$\textbf{Inverse modeling}$\rightarrow$\textbf{Observations} and click on \textbf{Add Observation}.\\ 
Set the following properties for the first observation: \\
\underline{observation 1:} \\
- \textbf{Name: } \textit{DO\_no\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment1} \\
- \textbf{Observed data: }  \textit{Obs\_nospike.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

Add three more observation and set the properties as follows: 

\underline{observation 2:} \\
- \textbf{Name: } \textit{DO\_NH3\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment2} \\
- \textbf{Observed data: }  \textit{Obs\_NH3.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\underline{observation 3:} \\
- \textbf{Name: } \textit{DO\_NO2\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment3} \\
- \textbf{Observed data: }  \textit{Obs\_NO2.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\underline{observation 4:} \\
- \textbf{Name: } \textit{DO\_both}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment3} \\
- \textbf{Observed data: }  \textit{Obs\_both.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\textbf{Note: } Entering the same \textbf{Standard deviation ID} for all the observation forces the program to find a single observation error standard deviation for all the observation. In this case because the measured quantity for all observations is dissolved oxygen it is expected that the measurement error for all observation to have the same statistical distribution. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure37.png} \\
\caption{Assigning parameters to model properties}\label{fig:inverse_example3}
\end{center}
\end{figure}    

Repeat for the other parameters to be estimated including $k_{OA}$, $\mu_{NOB}$, $k_{ON}$, $\mu_{OHO}$,
and $k_{OH}$. 

\item \textbf{Running in forward mode: } When the model is run in forward mode, the values of the parameters as specified in the \textbf{Value} field are used and a single simulation is performed. Click on the forward run icon \includegraphics[width=0.3cm]{Icons/run_icon.png} and wait for the simulation to end. Choose an experiment from the \textbf{Experiments} drop-down menu and then right click on the block and choose \textbf{Plot water quality results}$\rightarrow$\textbf{DO}. \\

- Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse modeling}$\rightarrow$ \textbf{Observations}$\rightarrow$ \textit{DO\_NH3\_spike} and then click on \textbf{Plot modeled data}. This shows the corresponding model prediction to observations for experiment 2. You can also check the agreement plot. 

\item \textbf{Change the initial time-step: } The model results that are used to calculate the likelihood are interpolated at time-intervals specified in the \textbf{initial time-step field}. Because the experiments in this example are short (0.1 day), the default initial time-step of 0.01 day is not adequate. From the project exploder choose \textbf{Settings}$\rightarrow$\textbf{Solver Settings} and then from the \textbf{Properties} window find \textbf{Initial time step size} and change the value to 0.001 day. 

\item{Inverse modeling: }\\ - Choose \textbf{number of generations} from \textbf{Inverse modeling}$\rightarrow$\textbf{Genetic Algorithm} and change the value to 100. This makes the number of generations in the Genetic Algorithm to 100. Keep the rest of the parameters unchanged.

 - Choose \textbf{number of realizations} from \textbf{Inverse modeling}$\rightarrow$\textbf{Markov chain Monte Carlo} and change the value to 1000. This makes the number of posterior prediction realizations to 1000. Keep the rest of the parameters unchanged. 

- Click on the inverse modeling icon \includegraphics[width=0.5cm]{Icons/inverse_icon.png} on the left side tool bar. Inverse simulation can take up to one hour depending on the number and speed of the CPUs of the computer being used for the simulation. Wait until the deterministic inverse modeling and the MCMC is finished. The progress bars on the \textbf{Simulation} window shows the percentage of each stage on inverse modeling being completed (Figures \ref{fig:43} and \ref{fig:44}). 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure43.png} \\
\caption{Inverse modeling progress window during deterministic parameter estimation stage}\label{fig:43}
\end{center}
\end{figure}  

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure44.png} \\
\caption{Inverse modeling progress window during probabilistic parameter estimation}\label{fig:44}
\end{center}
\end{figure}  



\item \textbf{Estimated values of the parameters: } To see the estimated values of the parameters select a parameter from \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and look at the \textbf{Value} field. The value should be replaced by the estimated parameter value. 

\item \textbf{Checking the model vs. observed agreement: } Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Observations}$\rightarrow$\textit{DO\_nospike} and the choose \textbf{Plot modeled data}. A graph will appear that will show observed data and the model prediction based on the estimated parameters. Do the same for other observation data (Figure \ref{fig:48}).

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=10cm]{Images/Figure48.png} \\
\caption{Observed and predicted DO variation in all four experiments}\label{fig:48}
\end{center}
\end{figure}  



\item \textbf{Checking the posterior distributions of the parameters: }\\ - From \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} right-click on $\mu_{NOB}$ and select \textbf{Plot posterior distribution histogram}. A graph will appear that shows the posterior distribution of parameter $\mu_{NOB}$ (Figure \ref{fig:45}). Similarly inspect the posterior distribution for other parameters. (Figure \ref{fig:46}). In this figure the box plot shows the 95\% credible interval for the parameter while the solid line shows the median and the dot shows the expected value of the parameter. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=11cm]{Images/Figure45.png} \\
\caption{Posterior distribution of $k_{OH}$,  $\mu_{OHO}$, $k_{ON}$,  $\mu_{NOB}$}\label{fig:45}
\end{center}
\end{figure}  


\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure46.png} \\
\caption{Posterior credible interval for }\label{fig:46}
\end{center}
\end{figure}  


- To see the 95\% credible intervals for all the parameters right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and select \textbf{Plot Percentile data} (Figure \ref{fig:47}). 


-  From \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} right-click on $\mu_{NOB}$ and select \textbf{Plot percentiles}. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure47.png} \\
\caption{Posterior credible interval for all parameters}\label{fig:47}
\end{center}
\end{figure} 

\end{itemize}
\section{Maximum-likelihood Inverse Modeling Control Parameters}

This section describes the control parameters for the maximum-likelihood (deterministic) inverse modeling feature of GIFMod. The maximum-likelihood control parameters can be accessed through \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Genetic Algorithm}.

\begin{itemize}
    \item %help:100185
    \textbf{Name: } The name of Genetic Algorithm object. It can be ignored. %help:end
    \item %help:100193
    \textbf{Cross-over probability: } This indicates the probability of \textit{individuals} undergoing a cross-over to generate the \textit{off-springs}. The reminder of the \textit{individuals} selected for mating will be copied to the next generations with only \textit{mutation}. For example if the value of \item \textbf{Cross-over probability} is set to 0.8, 80\% of the selected individuals will undergo cross-over while 20\% will be directly copied to the next generation. %help:end
    \item %help:100194
    \textbf{GA output file: } The results of genetic algorithm optimization will be written in this file. The file that will be generated can be used for diagnosis of the GA performance. %help:end
    \item %help:100196
    \textbf{Initial GA population: } If a file name is provided here it will be considered as the initial population for the GA analysis. If this field is empty, the initial GA population will be created randomly. %help:end
    \item %help:100204
    {Mutation probability: } This indicates the probability of mutation of each bit when copying from one generation to the other.%help:end
    \item %help:100206
    {Number of generations: } Indicates the number of generation in the GA algorithm to obtain the optimal parameter set.%help:end
    \item %help:100211
    {Perform local sensitivity analysis: } Indicates whether a local sensitivity analysis should be performed based on the deterministic parameter obtained by the GA algorithm. The results of the local sensitivity analysis will be saved in a text file called "sensitivity\_mat\_lumped.txt" in the working path. %help:end
    \item %help:100213
    {Population: } Indicates the population number that will be used for the GA optimization.%help:end
    \item %help:100214
    {Read GA analysis from file: } This field is used when the GA analysis has been previously done and only the post-processing is intended to be done using the results of the previous inverse modeling. The file name that will be entered is where GIFMod will load the results of the previous GA analysis from.%help:end
    \item %help:100218
    {Shake scale: } When the maximum fitness in the population is not improved in three sequential generations, an offspring of the fittest individual is produced by adding a random noise to the parameter values. This scale indicate the magnitude of the random noise. The default value is 0.05 which indicate adding a normally distributed noise with a standard deviation equal to 5\% of the value of each parameter. The purpose of this \textit{shaking} is to find possible optimal solution in the neighborhood of the parameter set represented by the fittest individual. %help:end
    \item %help:100219
    {Shake scale reduction factor: } If adding the noise does not result in an improved fitness, the shake-scale is gradually reduced (so a closer neighborhood is searched). The shake scale reduction factor is the factor by which this reduction in the shake scale is done. %help:end
    \item %help:100220
    {Number of threads: } The number of CPU threads used for the GA and MCMC parameter estimation. %help:end
\end{itemize}

\section{Probabilistic Inverse Modeling Control Parameters}
This section describes the control parameters for the MCMC (stochastic) inverse modeling feature of GIFMod. The MCMC control parameters can be accessed through \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Markov chain Monte Carlo}.

\begin{itemize}
\item %help:100187
\textbf{Create output realization including observation errors} Switching this property to \textit{Yes} results in GIFMod to generate prediction confidence intervals while considering the observation error. %help:end
\item %help:100188
\textbf{Calculate posterior correlation: } Indicates whether GIFMod will calculate the posterior correlation matrix between model parameters. %help:end
\item %help:100189
\textbf{Calculate posterior distributions: } Indicates whether GIFMod will generate marginal distributions of posterior distributions for each parameter. %help:end
\item %help:100191
\textbf{Calculate realization percentiles: } Indicate the percentiles (credible intervals) of the output realizations that will be saved. %help:end
\item %help:100192
\textbf{Continue MCMC sampling: } In cases where additional MCMC sampling is intended to be performed or that MCMC sampling has stopped in the middle of a run and is intended to be continued, this switch can be turned to \textit{Yes} and MCMC sampling will be continued. %help:end
\item %help:100198
\textbf{MCMC burn-in: } Indicate the number of MCMC samples that will be discarded as burn-in. These samples will be discarded from the begning of chains. %help:end
\item %help:100199
\textbf{MCMC number of chains: } The number of MCMC chains. %help:end
\item %help:100200
\textbf{MCMC data file: } The name of the file where the MCMC sampled parameters will be saved. %help:end
\item %help:100202
\textbf{MCMC purturbation scale: } This is the initial increase/decrease rate of the perturbation scale when the acceptance rate is higher or lower than the desired acceptance rate.   %help:end
\item %help:100203
\textbf{MCMC sample output interval: } If a number other than 1 is entered here, the MCMC outputs will be saved with that interval. %help:end
\item %help:100205
\textbf{Number of bins used for calculating posterior distributions: } This indicates the number of bins used to extract posterior marginal distribution of the parameterrs. %help:end
\item %help:100207
\textbf{Number of MCMC samples: } The total number of MCMC samples generated. %help:end
\item %help:100208
\textbf{Number of MCMC post-processing: } This indicates the number of samples generated from the posterior distribution that will be used to generate prediction realization for calculating prediction credible intervals. %help:end
\item %help:100209
\textbf{Only read MCMC outputs from file: } Switching this property to \textit{Yes} will make GIFMod to just read a previous MCMC results and do post-processing. %help:end
\item %help:100195
\textbf{Generate output realizations: } Determines whether output realizations based on parameter samples from the posterior distribution should be generated. These realization will be used to determine confidence intervals of model predictions while accounting for parameter uncertainty. %help:end
\item %help:100197
\textbf{Initial perturbation: } Determines whether the initial MCMC parameter sets should be obtained by perturbing the deterministically estimated parameters using GA or by using the non-perturbed values. MCMC used the parameters estimated by the GA as the initial point wither after perturbing the parameters or not. %help:end
 \item %help:100195
 {Save realization outputs in a file: } Switching this property to \textit{Yes}, forces the program to create a file where the sampled parameter values from the posterior distribution to generate the posterior realizations are saved. %help:end
 \item %help:100210
 \textbf{Perform global sensitivity analysis: } Indicates whether a global sensitivity analysis to be done or not. %help:end
 \item %help:100212
 \textbf{Perform MCMC simulation: } Indicates whether MCMC simulation to be done or not. %help:end
 \item %help:100216
 \textbf{Sensitivity-based perturbation factor: } Indicates whether the initial perturbation factor for each parameter is determined based on the local sensitivity associated with the parameter. %help:end
 \item %help:100221
 \textbf{Realized parameter output file: } If given the sampled parameters for generating prediction realizations are saved in a file with this name. %help:end
 \item %help:100151
 \textbf{Acceptance rate parameter for MCMC sampling: } This indicates the desired acceptance rate for MCMC sampling. GIFMod adjust MCMC perturbation factor to achieve this acceptance rate.  %help:end
 
 
 
 
 
 In this chapter the main building blocks a GI hydraulic and water quality model are described. The chapter is organized based on the order objects are shown in the "Project Explorer" window. In the first section the items under the "Settings" branch are discussed. These are the settings that determines the general properties of a project including the simulation duration, global time-series data such as precipitation, relative humidity, light, temperature and wind that can affect all of the blocks in a model and also solver setting that are adjusting parameters of the solver engine. In the second section properties of block and connectors as the main building blocks of a model are discussed. In the third section different evapotranspiration models available in GIFMod are explained. In section four, setting up the water quality component are discussed and in section five the inverse modeling capabilities of GIFMod are described. 

\section{Settings}
There are three branches under the "Settings" main branch in Project Explorer including "Project Settings", "Climate Settings", and "Solver Settings". Below the properties under each of these categories are described. 
\subsection{Project Settings}
General required information about a project listed under this group. This includes the start and end times and project description. 

\begin{itemize}
\item %help:100144
\textbf{Simulation Start Time: } This indicates the start date of the simulation. If this number is not entered by the user a default value of zero (equivalent to 1/1/1900) will be assigned to the start time of the project. All time series data such as inflows, precipitation, temperature, ... should be organized in a consistent way with the project start and end time. %help:end
\item %help:100145
\textbf{Simulation End Time: } This indicates the simulation end time. If this number is not entered, the default value of 1 (equivalent to 1/2/1900) will be automatically assigned. 
\item \textbf{Project Description: } This item provides a space to enter a memo as a general description about the project. %help:end
\item %help:100159
\textbf{Working path: } This indicates the folder where the outputs of the simulation are saved in. All outputs of a simulation including hydraulics, particles, and water quality are saved in this folder as well as some information about the simulation performance that may be needed to debug a model setup. %help:end
\item %help:100317
\textbf{Steady-state hydraulics} Switching this option to Yes will result in a quasi steady-state solution of hydraulics. The quasi steady-state solution is based on the assumption of no changes in the storage of blocks and then calculating instantaneous flow rates between the blocks based on this assumption. This option is useful for example when an activated sludge simulation is meant to be performed using GIFMod. %help:end
\end{itemize}
\subsection{Climatic Settings}
This sub-branch allows introducing time-series containing external forcing that can be applied to all (or selected) blocks. These include precipitation, light, humidity, temperature and wind. Light is needed in some of the evapotranspiration models available in GIFMod but also can be included as a limiting factor in transformation processes (reactions) for example when algae growth is meant to be modeled. Humidity and wind also are needed in some of the evapotranspiration models while temperature not only is needed in calculating evaporation it can be specified to affect the value of reaction parameters as it is discussed in section (xx.xx). All of the time-series information in GIFMod must be provided as external text files with .csv format.
\begin{itemize}
\item %help:100132
\textbf{Precipitation: }  The file structure for precipitation data is a comma separated (.csv) text file with three columns. The first and second columns are respectively the start and end times over which the volume of precipitation is given in the third column. The time values should be consistent with the standard time format where the value is the number of days past 1/1/1900. The units of precipitation volume is in (m) units. Figure \ref{fig:8} shows an example precipitation input file. It should be noted that the program converts precipitations to inflow time-series according to the area of the blocks and then interpolate the values at the computational time-steps. So it is important that the dry periods to be included with zero precipitation volume. When the precipitation file is loaded the user can see the time-series graphically by right-clicking on the file-name and clicking on the "Data" item in the drop-down menu. 
\begin{figure}[!ht]\label{fig:8}
\begin{center}
\includegraphics[width=5cm]{Images/Figure8.png} \\
\caption{A sample precipitation file} 
\end{center}
\end{figure} %help:end
\item %help:100177
\textbf{Light: } Light is also provided in .csv text format. The time-series data should be arranged in two columns, when the first column represent time and the second light intensity in $(W/m^2)$ or other units as long as it is consistent with other parts of the model. Figure /ref{fig:9} shows an example light time series data. The name field in the first row is optional. 
\begin{figure}[!ht]\label{fig:9}
\begin{center}
\includegraphics[width=5cm]{Images/Figure9.png} \\
\caption{A sample light intensity time-series file} 
\end{center}
\end{figure} %help:end
\item %help:100178
\textbf{Humidity: } This is where the relative humidity (vapor pressure/saturation vapor pressure) time-series can be provided to the model. The format of the input file is a two column .csv text file similar to light. In most meteorological databases dew point temperature is provided instead of the relative humidity. In that case, the relative humidity can be calculated as:
\begin{equation}
\label{eq:6}
R_h=exp\big[17.62(\frac{T_d}{243.5+T_d}-\frac{T}{243.5+T}) \big]
\end{equation}
where $T$ and $T_d$ are respectively the actual temperature and dew-point temperature in $^oC$. %help:end  
\item %help:100240
\textbf{Temperature: } The format of the temperature time-series is the same as light and relative humidity. The values must be provided in $^oC$. %help:end
\item %help:100241
\textbf{Wind: } Wind time-series is needed in several of the evapotranspiration models such as the Penman model and the aerodynamic model (section xx.xx). The units should be consistent with the coefficients used in the evaporation model. The format of the wind time-series input data file is the same as temperature, humidity, and light. %help:end
\end{itemize}
\subsection{Solver Settings}
Using solver setting the user can adjust the parameters the solver engine uses to solve the governing equations of the model. In most cases the user can leave the default parameters unchanged. The optimal values of these parameters however are problem dependent and there is no unique setting that works for all model configurations. In the following, each parameter is described briefly:
\begin{itemize}
\item %help:100094
\textbf{Allow Negative Concentration: } This option specifies whether the solver allows constituent concentrations to become negative (due mainly to numerical errors) during the simulation. Sometimes small negative values for concentrations can cause problems in reactions while in some models a small negative concentration can be effectively interpreted as a zero concentration and may not affect other constituents. When the option is set to "no" the Newton-Raphson solver rejects any solution that contains a negative concentration and start over with a smaller time-step which may cause slowing down of the computation. %help:end
\item %help:100099
\textbf{Check Positive Definiteness: } This option specifies whether the solver should adjust the time-step size based on the level of positive-definiteness of the Jacobian matrix related to transport of particles and constituents. Maintaining a positive-definite Jacobian by limiting the time-step resulting in smaller oscillation in the solution but can result in a longer computational time.%help:end
\item %help:100104
\textbf{Time weighting factor: } This option allows specifying the time weighting factor user in temporal discretization. In other words, it determines the weights given to the weight given to the values of the right hand sides of the balance equations evaluated at the current and the previous time-steps. A value of 0 for the Time Weighting Factor indicates a fully implicit scheme while a value of 1 indicates a fully explicit scheme. The default value is 0.5 which results in Crank-Nichoson time weighting scheme.%help:end 
\item %help:100113
\textbf{Failure Criteria number of iterations: } This option indicates the maximum number of Newton-Raphson iterations to be considered a faiure in convergence. When this number of iterations is reached, the solver terminates the iterations, and start over with a smaller time-step and a newly calculated inverse Jacobian matrix. \item \textbf{Initial time step size: }  This value serves two purposes. First it is the time-step that is used initially by the solver engine. It may grow or shrink later depending on the success of the Newton-Raphson algorithm to converge and the number of iterations needed for convergence. The model outputs are also saved based on this time step size if the option "Uniform output interval" is set to yes.%help:end 
\item %help:100117
\textbf{Jacobian update interval: }  This indicate the number of time-steps that the Jacobian matrix is recalculated regardless of the convergence success of the Newton-Raphson method. %help:end
\item %help:100125
\textbf{Newton-Raphson acceptance tolerance: }  The Newton-Raphson is considered converged when the 2-norm of the residual vector is below this tolerance level. A smaller value results in a more accurate result but a longer simulation time.%help:end
\item %help:100129
\textbf{Perform mass-balance check: }  Setting this option to Yes results in a file being created in the folder specified in the "Working Path" showing the mass balance errors during the simulation period.%help:end 
\item %help:100130
\textbf{Perform particle transport simulation: } This specifies whether a particle transport simulation to be performed or not. If no particles are introduced, no simulation on particle transport is performed by the program regardless of this switch. If at least one particle type is introduced and the "Perform Water Quality Simulation" is set to Yes, particle transport simulation will also be conducted regardless of this option. %help:end
\item \textbf{Perform water quality simulation:} Determines whether water quality simulation should be performed or not when at least one constituent is introduced.
\item %help:100131
\textbf{Preferred lower limit of NR iteration:} The computational engine increases the time step size when the number of iterations needed to achieve convergence is below this number. %help:end
\item %help:100134
\textbf{Preferred upper limit of NR iteration:} The computational engine decreases the time step size when the number of iterations needed to achieve convergence is above this number. %help:end
\item %help:100139
\textbf{Restore Interval:} When a convergence is not achieved after twice reducing the time-step by "time step change coefficient in case of failure", the solution time goes back to a restore interval and continue with a smaller time-step. The "Restore interval" are the number of time-step increments at which restore points are recorded.%help:end
\item %help:100147
\textbf{Solution method:} Indicates the solution method used by the solver engine. The only method available at this time is Newton-Raphson. %help:end
\item \textbf{Solution oscillation tolerance: } This is a criteria that is used to assess whether the wiggles in the solution and to adjust the time-step accordingly. When the second time derivative of any of the state variables normalized by the maximum computed value for that state variable up a given time exceeds this value the time-step size is reduced and the iteration at that time is repeated.
\item %help:100148
\textbf{Time step change rate coefficient in case of failure: } This indicates the factor by which the time-step size is reduced if the number of iterations to achieve convergence by the Newton-Raphson algorithm exceeds the "Failure Criteria number of iterations" or that a concentration becomes negative when "Allow Negative Concentration" is set to No. This reduction factor is also used when the solution time goes back to a restore point.%help:end 
\item %help:100154
\textbf{Time step change rate coefficient: } The time step is increased or decreased by this factor respectively when the number of iterations to achieve convergence is below "Preferred lower limit of NR iteration" or above "Preferred upper limit of NR iteration". %help:end
\item %help:100156
\textbf{Uniform output export interval: } Indicates whether the outputs should be saved with uniform intervals given in "Initial time step size" or based on the computational time-steps determined by the adaptive time-step algorithm. Setting this option to yes makes the program to interpolate outputs at uniform intervals and save the uniformly timed outputs in the output files. %help:end
\item %help:100160
\textbf{Write solution details: } Switching this option to yes, results in the program creating a file named "Solution\_Details.txt" in the working path folder containing some details of the solver perform ace at every computational time-step. This file is useful to find possible bugs in the model structure defined by the user. %help:end
\item %help:100317
\textbf{Steady-state hydraulics} Switching this option to Yes will result in a quasi steady-state solution of hydraulics. The quasi steady-state solution is based on the assumption of no changes in the storage of blocks and then calculating instantaneous flow rates between the blocks based on this assumption. This option is useful for example when an activated sludge simulation is meant to be performed using GIFMod.%help:end 
\end{itemize}
\section{Properties of Blocks}
In this section different media types available in the model are described. Some properties of the blocks are only specific to some of the media types while others may be shared between different blocks. Figure \ref{fig:7} shows different types of media available in GIFMod. The head-storage relationship provided can be altered by the user on a need-based fashion. For example for a pond with a given bathymetry, non-linear head storage relationships may be more appropriate. 
\begin{figure}[!ht]\label{fig:7}
\begin{center}
\begin{tabular}{c c c}
Storage & Saturated Soil & Pond\\
\includegraphics[width=4cm]{Images/Figure7a.png} &
\includegraphics[width=4cm]{Images/Figure7b.png} &
\includegraphics[width=4cm]{Images/Figure7c.png} \\
$h=\frac{S}{A_s\theta_s}-\frac{\epsilon}{s_e^{n_e}}$\\$+pos(\theta-\theta_s)/S_s$ & $h=h_0 + \frac{\theta-\theta_S}{S_s}$ & $h=z_0+\frac{S}{A_s}$\\\hline
\\
Unsaturated Soil & Stream Segment & Overland flow \\
\includegraphics[width=4cm]{Images/Figure7d.png} &
\includegraphics[width=4cm]{Images/Figure7e.png} &
\includegraphics[width=4cm]{Images/Figure7f.png} \\
$h=z_0-\frac{H(\theta_s-\theta)}{\alpha}(s_e^{n/(1-n)}-1)^{1/n}$\\$+pos(\theta-\theta_s)/S_s$ & $h=z_0+\frac{S}{A_s}$ &  $h=z_0+\frac{S}{A_s}$\\
\end{tabular}
\caption{Media types and the head-storage relationship in GIFMod} 
\end{center}
\end{figure}
When two blocks are connected using a "Connector", GIFMod automatically assigns the a default connector by default. However, the connectors can be later altered by the user. When two blocks are of the same type the choice of connector type is consisted with the type of the blocks. For example when the two blocks connected are "Saturated Soil", the Darcy equation controls the flow rate between them. However, when the types of the blocks are not consistent the choice of the default connector sometimes depend on which one is at a higher elevation. Table \ref{table:1} shows the default governing equations assigned by GIFMod when two blocks of certain type are connected. 


\begin{table}[!ht]
\small
\begin{center}
\rotatebox{90}{
\begin{tabular}{c | c c c c c c}
bottom\setminus top & \multicolumn{1}{m{2.4cm}}{Unsaturated Soil} & Pond & Storage & \multicolumn{1}{m{2.4cm}}{Overland Flow} & \multicolumn{1}{m{2.2cm}}{Saturated Soil} & \multicolumn{1}{m{2.5cm}}{Stream Segment} \\
\hline
Unsaturated Soil & VGM $^*$ & VGM & VGM & VGM & VGM & VGM \\
Pond & NA$^{**}$ & DWM$^{***}$ & Darcy & DWM & Darcy & DWM \\
Storage & VGM & Darcy & Darcy & NA & Darcy & NA\\
Overland Flow & NA & NA & NA & DWM & NA & NA\\
Saturated Soil & VGM & Darcy & Darcy & NA & Darcy & Darcy\\
Stream Segment & NA & DWM & NA & DWM & NA & DWM \\
\end{tabular}
}
\caption{Default Q-H relationships based on the blocks connected, *-VGM: Van Genuchten-Maulem, **-NA: No default Q-H equation is available, ***- DWM: Diffusive Wave/Manning}\label{table:1}
\end{center}
\end{table}

In Table \ref{table:1}, "NA" indicates that no default relationship will be assigned if two blocks of the types in the row and column heading are connected. For example if a soil block is connected to an overland flow block when the soil block has a higher elevation GIFMod does not assign any Q-H relationship to the connector by default and the flow rate will be zero unless the user provides a Q-H relationship for the connector. VGM indicated Van Genuchten-Mualem equation for flow rate: 
\begin{equation}
\label{eq:1}
Q_{i,j}=A_sK_e\frac{h_i-h_j}{d}
\end{equation}
where $Q_{i,j}$ is the flow rate from block $i$ to block $j$ and 
\begin{equation}
\label{eq:2}
K_e=K_s s_e^{\lambda} [1-(1-s_e^{1/m})^m]^2
\end{equation}
DWM in Table \ref{table:1} refers to Diffusive Wave/Manning equation based on which the flow rate is calculated as: 
\begin{equation}
\label{eq:3}
Q_{i,j}=n_m \bar{y}^{1+\alpha_m}W\big(\frac{h_i-h_j}{d}\big)^{1/2}
\end{equation}
where $n_m$ is the Manning's roughness coefficient and $\alpha_m$ is the exponent for the hydraulic radius in Manning's equation which is by default set to $2/3$ in ponds and streams and $1/2$ for overland flow but can be altered by the user and $bar{y}=1/2(y_i+y_j)$ is the average water depth in the connector where $y_i=h_i-z_{0,i}$ is the water depth in block $i$. 
A dam can be added to surface water connectors (Stream and Pond) by entering a dam elevation the "Properties" of connectors in which case the Q-H equation becomes: 
\begin{equation}
\label{eq:4}
Q_{i,j}=n_m pos(\bar{y}-H_d)^{1+\alpha_m}W\big(\frac{h_i-h_j}{d}\big)^{1/2}
\end{equation}
The Darcy equation computes the flow as: 
\begin{equation}
\label{eq:5}
Q_{i,j}=A_sK_s\frac{h_i-h_j}{d}
\end{equation}
\subsection{Common properties of blocks}
In the following the properties that are shared between all block types are described: 
\begin{itemize}
\item %help:100001
\textbf{Name: } All components of the model have a name. When a component is added to the model, GIFMod automatically assigns a name to it which can be changed by the user. These names are used to refer to the components in other components and also in the output files generated by the program. The names in each sub-category must be unique. For example two blocks cannot have the same name. However a block and a constituent can have same names.%help:end 
\item \textbf{Type:} This indicates the type of the media the block represents. When the blocks are added the type is set according to the toolbar icon used to create the block, however it can be changed by the user. The applicable properties of the block then change according to the newly selected type. 
\item %help:100002
\textbf{SubType:} In soil blocks specifically, the subtype determines the soil type (e.g. loam, sand, etc.) based on which the program assigns default soil parameter values such as saturated hydraulic conductivity and other soil retention parameters. These parameters can be manually altered by the user. %help:end
\item %help:100006
\textbf{Bottom area:} This indicates the top or bottom area of blocks with media type soil, Darcy, overland flow and storage. For ponds and steams the by default the program assumes that the banks are vertical unless specified by the user through the Head-Storage relationship feature. When external fluxes are calculated for ponds and stream segments, this area is used as the interface area between water and air.  This value must be entered. %help:end
\item %help:100013
\textbf{Bottom Elevation: } Specifies the bottom elevation of a block. In the cases when the bottom of a block is thought to be sloped the mean bottom elevation can be used. %help:end
\item %help:100018
\textbf{Build-up: } Using this option, the user can select the contaminant build-up component (section xx.xx) to be assigned to a specific block. In which case the build-up will take place in the block according to the designated build-up component. %help:end
\item %help:100020
\textbf{Constituent initial concentration: } The initial concentration of concentrations of water quality constituents can be assigned to a block using this option. When clicking a window will show up that allows entering the initial concentration of constituents in dissolved or sorbed phases (to soil matrix or particles) to be specified. 
\begin{figure}[!ht]\label{fig:10}
\begin{center}
\includegraphics[width=8cm]{Images/Figure10.png} \\
\caption{Initial Concentration Window} 
\end{center}
\end{figure}%help:end
\item %help:100023
\textbf{External flux: } This indicates the external flux model to be assigned to this block. External flux components (section xx.xx) can be used to determine the rates at which constituents are entering to a block typically through atmospheric exchange (e.g aeration). %help:end
\item %help:100025
\textbf{Head-Storage Relationship: } An expression can be entered here to replace the default head-storage relationship for this type of block. %help:end
\item %help:100026
\textbf{Inflow time series: } The inflow rate and water quality characteristics are introduced using this option. An example showing the format of the text file containing the inflow time series is shown in Figure \ref{fig:5}. %help:end
\item %help:100040
\textbf{Particle initial concentration: } The initial concentration of particles in all phases available based on the model they are assigned to {Mobile, Reversibly Attached, Irreversibly Attached} can be entered here. By clicking on this box, a window appear where the user can enter the initial condition for all particle types in different phases (Figure \ref{fig:11}). It should be noted that the concentration of attached particles should be expressed as mass of particles per mass of solid phase (soil matrix) in the case of subsurface components (soil, Darcy, storage) and as mass per surface area in the case of surface components (pond, stream, overland flow). 
\begin{figure}[!ht]\label{fig:11}
\begin{center}
\includegraphics[width=8cm]{Images/Figure11.png} \\
\caption{Initial Particle Concentration Window} 
\end{center}
\end{figure}%help:end
\item %help:100041
\textbf{Precipitation: } Indicates whether precipitation will be directly applied to the block or not. By default, surface water blocks (pond, stream, and overland flow) receive direct precipitation while the subsurface blocks (soil, storage, and Darcy) do not. This option allows the user to change this rule. 
\item \textbf{Vapor diffusion: } The flux between the blocks are modeled by GIFMod is modeled based on the following equation:
\begin{equation}
\label{eq:7}
J_{v,i,j}=D_v(\bar{\theta_s}-\bar{\theta})\frac{\theta_i-\theta_j}{d}
\end{equation}
$D_v$ is the vapor diffusion coefficient and $\bar{\theta}=(\theta_i+\theta_j)/2$. 
\item \textbf{Evapotranspiration: } The evaportranspiration model that applies to the block is selected here. The evapotranspiration model should be first introduced as an Evportranspiration model (section \ref{section:3.3}) and then can be selected to be applied to specific blocks. %help:end
\item %help:100165
\textbf{Light: } Indicates whether light will be directly applied to the block or not. If the No option is selected the light intensity at the block will be considered zero throughout the simulation. By default, the option is selected as "Yes" for surface water blocks and "No" for subsurface blocks. %help:end
\item %help:100315
\textbf{Light reduction factor: } The values in the light time-series are multiplied by the value entered in this box to calculate the light intensity at the block. This feature is useful when applying light reduction to deeper layers of a pond for example when light is adsorbed partly at upper layers. The default value is 1. %help:end
\item %help:100316
\textbf{Conduct Reactions: } The user can turn off reactions in a particular block of the model using this option. 
\item \textbf{Length: } The value of this property is assigned to connectors when a array of the block is created if the length is not entered in the array dialog box. Otherwise it is ignored. 
\end{itemize}
In the following the specific properties of each media type is described. %help:end
\subsection{Pond: } This component can be used for any zone that can contain surface water even if it is dry during all or part of the simulation. So a surface water component of a bioretention system, a green roof or a permeable pavement can be modeled as pond. In other words any component where water ponding with free surface can occur can be modeled as a pond. Specific properties of a pond are described in the following:
\begin{itemize}
\item %help:100021
\textbf{Depression storage: } This is the depth of water that is needed to be reached before a flow from the pond to another pond or another surface water block (i.e. stream, catchment) can be initiated.%help:end 
\item %help:100028
\textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. %help:end
\item %help:100161
\textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.%help:end
\item %help:100163
\textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. 
\end{itemize}%help:end
\subsection{Soil: }
Specific properties related to blocks with soil media type are described in this sub-section: 
\begin{itemize}
\item %help:100003
\textbf{SubType} The soil texture can be selected here. When the soil texture is selected, default values for soil hydraulic properties including Van Genuchten $\lambda$, $n$, $\alpha$, Saturated Hydraulic Conductivity, $K_s$, and saturated and residual moisture contents $\theta_s$ and $\theta_r$ are automatically set based on it. The default values are based on \citep{carsel1988}. The values can be later changed by the user. %help:end
\item %help:100019
\textbf{Bulk Density: } Bulk density of soil. %help:end
\item %help:100027
\textbf{Moisture Content: } The user can enter the initial moisture content in the soil block here. %help:end
\item %help:
\textbf{Depth: } This indicates the vertical depth/thickness of the soil block. This value must be entered and must be non-zero. 
\item \textbf{Van Genuchten $\lambda$ parameter}: Van Genuchten $\lambda$ parameter Eq. \ref{eq:2} can be entered here. The default value for all soil types is 0.5.%help:end
\item %help:100179
\textbf{Storitivity: } The hydraulic head in a block when the soil is super saturated is calculated using the storitivity value. %help:end
\item %help:100047
\textbf{Residual moisture content: } Residual moisture content $\theta_r$ value. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the residual moisture content of the connector when calculating the flow rate using Eq. \ref{eq:2}. %help:end
\item %help:100048
\textbf{Saturated hydraulic conductivity: } Saturated hydraulic conductivity of the soil $K_s$. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:2}. Otherwise, it will be over-written by the value entered for the connector. %help:end
\item %help:100051
\textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:2}. %help:end
\item %help:100056
\textbf{Van Genuchten $\alpha$ parameter: } Van Genuchten $\alpha$ parameter used in equation under the unsaturated soil block in figure \ref{fig:7}. %help:end
\end{itemize}
\subsection{Darcy: }
Specific properties related to blocks with Darcy media (Saturated soil) type are described in this sub-section: 
\begin{itemize}
\item %help:100324
\textbf{Bulk Density: } Bulk density of soil. %help:end
\item %help:100325
\textbf{Initial Moisture Content: } The user can enter the initial moisture content in the soil block here. 
\item \textbf{Depth: } This indicates the vertical depth/thickness of the soil block. If not entered the initial moisture content is assigned to be equal to the saturated moisture content. It should be noted that entering values significantly different than the saturated moisture content can result in very large positive or negative hydraulic heads. %help:end
\item %help:100326
\textbf{Storitivity: } The hydraulic head in a block when the soil is super saturated is calculated using the storitivity value.%help:end 
\item %help:100327
\textbf{Saturated hydraulic conductivity: } Hydraulic conductivity of the soil $K_s$ used in Eq. \ref{eq:5}. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:5}. Otherwise, it will be over-written by the value entered for the connector. %help:end
\item %help:100328
\textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. Typically can be assumed equal to the porosity of the media. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:5}. %help:end
\end{itemize}
\subsection{Storage: }
Specific properties related to storage blocks are described in this sub-section: 
\begin{itemize}
\item %help:100329
\textbf{Bulk Density: } Bulk density of storage media. %help:end
\item %help:100330
\textbf{Initial water depth: } The user can enter the initial water depth of the storage block here.%help:end 
\item %help:100331
\textbf{Depth: } This indicates the vertical depth/thickness of the storage block. If not entered the initial moisture content is assigned to be equal to the saturated moisture content. It should be noted that entering values significantly different than the saturated moisture content can result in very large positive or negative hydraulic heads. %help:end
\item %help:100332
\textbf{Storitivity: } The hydraulic head in a block when the storage block is super-saturated is calculated using the storitivity value.%help:end 
\item %help:100333
\textbf{Saturated hydraulic conductivity: } Hydraulic conductivity of the soil $K_s$ used in Eq. \ref{eq:5}. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:5}. Otherwise, it will be over-written by the value entered for the connector. %help:end
\item %help:100334
\textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. Typically can be assumed equal to the porosity of the media. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:5}. %help:end
\item %help:100320
\textbf{Suction head coefficient under dry condition: } $\epsilon$ value in figure \ref{fig:7}.%help:end
\item %help:100321
\textbf{Suction head power under dry condition: } $n_e$ value in figure \ref{fig:7}.%help:end
\end{itemize}
\subsection{Catchment: }
Specific properties related to catchment blocks representing overland flow are described in this sub-section: 
\begin{itemize}
\item %help:100021
\textbf{Depression storage: } This is the depth of water that is needed to be reached before a flow from the pond to another pond or another surface water block (i.e. stream, catchment) can be initiated. %help:end
\item %help:100336
\textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. %help:end
\item %help:100337
\textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.%help:end
\item %help:100338
\textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. %help:end
\item %help:100339
\textbf{Length: } When arrays of catchment blocks are created, the value entered here will be assigned to the connector lengths created as part of the grid.%help:end
\end{itemize}
\subsection{Stream Segment: }
Specific properties related to stream segment are described in this sub-section: 
\begin{itemize}
\item %help:100340
\textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. %help:end
\item %help:100341
\textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.%help:end
\item %help:100342
\textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. %help:end
\end{itemize}

\section{Properties of Connectors}
In this section properties of connectors are described. Some of the properties of connectors are only available for non-default  connectors or when connector connect specific types of blocks. In the following first the properties of connectors common between all connectors are described and then properties specific to certain type of connectors are explained. 

\subsection{Common connector properties}
\begin{itemize}
\item %help:100004
\textbf{Name: } This field indicates the name of the connector. Name of a connector is used to refer to a connector by other objects in the model and also when generating outputs. By default when a connector a name consisting of the name of the two blocks being connected separated by a dash "-" will be assigned as its name which can be changed by the user. \\
    \textbf{Note: } It is important to note the direction of  connectors (i.e. the start and end blocks). When the flow rates in a block is reported a positive value means flow from the starting block to the target block while a negative value for the flow means flow in the opposite direction. %help:end
    \item %help:100005
    \textbf{Type: } Type of a connector dictates its flow-head relationship. When a connector is created the type will be assigned to be "Default". This means that the program automatically assigns a governing equation based on table \ref{table:1}. The non-default connectors include: 
    - \textbf{Darcy: } Indicates that the flow rate of the connector will be calculated based on Darcy's law regardless of the types of blocks being connected. \\
    - \textbf{Normal Flow: } Indicates that the flow rate will be calculated by assuming establishment of Normal flow based on Manning's equation. This means that the hydraulic head int the two blocks being connected will not play a role in determining flow rate but only the bottom slope of the connector will be considered:
    \begin{equation}
    \label{eq:8}
    Q_{i,j}=\frac{z_{0,i}-z_{0,j}}{n_m d}\bar{y}^{\alpha_m+1}W
    \end{equation}
    -\textbf{Pipe: } Hazen-Williams equation will be used to calculated the flow rate between the two connectors. Accommodations is considered for when the pipe is not fully under pressurized condition. 
    \begin{equation}
    \label{eq:9}
    Q_{i,j}=k_{hw}\pi C (\frac{D_p}{2})^{2.63} sgn(h_i-h_j) (\frac{max(h_i,z_{c,i})-max(h_j,z_{c,j}}{d})^{0.54} f_{hw}(\bar{y}_{pipe})
    \end{equation}
    where $y_{pipe}$ is the approximated average depth fraction of the pipe filled: 
    \begin{equation}
    \label{eq:10}
    y_{pipe}=max(\frac{1}{2 D_p}(h_i-z_{c,i}+h_j-z_{c,j}),1) 
    \end{equation}
    and $f$ is approximates the fraction filled area of a partially filled piped:
    \begin{equation}
    \label{eq:11}
    f_{hw}(x)=-2.0255 x^4 + 1.9813 x^3 +1.0318 x^2 + 0.0388 x 
    \end{equation}
 - \textbf{Rating curve: } This option allows using a power equation between head and flow rate to calculate the flow rate through a connector. The form of the equation is: 
    \begin{equation}
    \label{eq:12}
    Q_{i,j}=\alpha_{rc}(h_i-z_{rc})^{\beta_rc}H(h_i-h_j) - \\ \alpha_{rc}(h_j-z_{rc})^{\beta_rc}H(h_j-h_i);
    \end{equation}
- \textbf{User-defined: } The flow will be calculated based on the expression that user enters into the "Flow Expression" field.%help:end
\item %help:100067
\textbf{Interface/cross sectional area: } When a connector connects a subsurface block (Soil, Darcy, Storage) to another block, this value is needed and indicates the area of the interface between the two blocks being connected. When surface water blocks (Pond, Stream segment, Catchment) are connected together, the interface area is calculated automatically based on the depth of water but if a number is entered for this property, the area will be assumed constant and equal to the value entered. The interface area is used to calculate constituent fluxes as a result of diffusion and dispersion.   %help:end
\item %help:100070
\textbf{Dispersion Expression: } The expression used to calculate dispersion coefficient (different than the constitution-dependent diffusion coefficient) in a connector. If not entered the default expression $D_s = \alpha_D |v_{i,j}|$ will be used. %help:end
\item %help:100071
\textbf{Dispesivity: } The value of dispersivity. If left empty the dispersivity will be considered zero. 
%help:end
\item %help:100078
\textbf{Length: } This represent the distance between the centroids of blocks being connected. Length is used to calculate hydraulic gradients in flow relationships as well as concentration gradients needed to calculate diffusive and dispersive fluxes. %help:end
\item %help:100081
\textbf{Settling: } Indicates whether settling of particles or settlable constituents can occur through a connector. If set to "Yes"m the direction of settling will be determined based on the bottom elevations of the two blocks connected. 
%help:end
\item %help:100251
\textbf{Use prescribed flow: } Indicate whether the prescribed flow indicated in the property "Prescribed Flow" to be used as the flow rate or not. If set to "Yes" the flow rates will be taken from the time-series in the input file indicated as "Prescribed Flow". %help:end
\item %help:100252
\textbf{Prescribed flow: } The file containing the prescribed flow to be imposed on a connector will be entered here. The format if a prescribed flow file is the same as other single time-series such as temperature and light.
\end{itemize}
\subsection{Connector properties specific to surface water blocks}
\begin{itemize}%help:end
\item %help:100076
\textbf{Flow Exponent: } This indicates the value of $\alpha_m$ in equations \ref{eq:3} and \ref{eq:4}. If not entered a value of $2/3$ will be used by default consistent to Manning's equation. %help:end
\item %help:100079
\textbf{Manning's roughness coefficient: } The value of Manning's roughness coefficient $n_m$ in equations \ref{eq:3} and \ref{eq:4} are to be entered here.%help:end
\item %help:100063
\textbf{Width: } Width of the connector. The width is used in calculating flow and interface area between horizontally connected surface water blocks (Eqs. \ref{eq:3} and \ref{eq:4}). %help:end
\item %help:100064
\textbf{Dam elevation: } This property can be used to introduce dams between two blocks. The flow will not be initiated until the water level in one of the blocks exceed the dam elevation. The area of the interface between the two blocks connected will also be calculated as a difference between the hydraulic head and the dam elevation.  %help:end
\end{itemize}
\section{Evapotranspiration}\label{section:3.3} %help:100224
Five alternative evaporation and transpiration models are provided in GIFMod. In addition the user can provide potential evaporation time-series in form of external input files. The evaporation models include Penman, Priestly Taylor and Aerodynamic models and the two transpiration models limit the evaporation based on the soil water stress either based on soil suction head or moisture content. Below each model is described. 
\subsection{Priestly-Taylor model: }
In Priestly-Taylor model \citep{Priestley1972}, the potential evaporation is calculated as:
\begin{equation}
\label{eq:13}
E_a = 1.3\frac{\Delta}{\Delta+\gamma}E_r 
\end{equation}
where $\Delta$ is the gradient of vapor pressure curve:
\begin{equation}
\label{eq:14}
\Delta = \frac{d e_{as}}{dT} = (4098)611\frac{exp(\frac{17.27T}{237.3+T})}{(237.3+T)^2} 
\end{equation}
where $\gamma$ is the psychrometric constant (by default equal to 66.8 Pa/$^oC$) and and $E_r$ is calculated as:
\begin{equation}
\label{eq:15}
E_r = k_r\frac{R_n}{l_v \rho}
\end{equation}
where $l_v$ is the latent heat of evaporation, and $R_n$ is the solar radiation that will be taken from the light time-series. The coefficient $k_e$ is provided as a calibration coefficient to allow adjusting for shading and other effects. 

\subsection{Aerodynamic model: }
In aerodynamic model, the evaporation rate is calculated as: 
\begin{equation}
\label{eq:16}
E_a = k_a u_w e_{as} (1 - R_h)
\end{equation}
where $e_as$ is calculated as: 
\begin{equation}
\label{eq:17}
e_{as} = 611 exp(\frac{17.27T}{237.3+T})
\end{equation}

\subsection{Penman model: }
In Penman model, the potential evaporation is calculated as:
\begin{equation}
\label{eq:18}
E=\frac{\Delta}{\Delta+\gamma}E_r + \frac{\gamma}{\Delta+\gamma}E_a
\end{equation}
\subsection{Transpiration based on soil moisture content: }
The two transpiration models included in GIFMod are used for soils exposed to water uptake by plants and both are based on the aerodynamic model but they limit the transpiration rate based on the soil moisture content or soil matric potential (ref). In the model based on soil moisture content the transpiration through plants is calculated as: 
\begin{equation}
\label{eq:19}
E=E_a min(\frac{\theta-\theta_{wp}}{\theta_{fc}-\theta_{wp}},1)
\end{equation}
\subsection{Transpiration based on soil matric potential: }
In this model, the transpiration through plants is calculated as: 
\begin{equation}
\label{eq:20}
E=E_a min(\frac{h-h_{wp}}{h_{fc}-h_{wp}},1)
\end{equation}
It should be noted that the coefficient $k_a$ in the last two models should encompass the effect of leaf area index (LAI). 
\subsection{Time series: }
This option allows providing evaporation time-series data as external input file. The format of the input file is the same as other time-series data such as light and temperature. %help:end
\subsection{Evaporation model properties: }
\begin{itemize}
    \item %help:100225
    \textbf{Rate Expression: } This option allows the user to enter an expression to be used to calculate the evaporation rate. If an expression is entered here it will over-rule the default expression designated based on the selected evaporation model. %help:end
\item %help:100226
\textbf{Time Series: } If the evaporation model is set to "Time Series", the file containing the evaporation time-series data will be selected using this field. %help:end
\item %help:100227
\textbf{Uptake Constituents: } This option indicates whether the consitituents should be taken up with the evaporation or not. By default the value of this property is "No" for evaporation models including Penman, Priestly-Taylor, Aerodynamic and time-series and is yes for transpiration models. %help:end
\item %help:100233
\textbf{Coefficient: } In the aerodynamic, and transpiration models, this value represent the $k_a$ coefficient in Eq. \ref{eq:16}. In Priestly-Taylor model, it represents $k_r$, the calibration coefficient (Eq. \ref{eq:15}). %help:end
\item %help:100319
    \textbf{Psychrometric constant: } The psychrometric constant used in calculating radiation-based evaporation. The default value is 66.8 $Pa/^oC$. %help:end
\item %help:100321
    \textbf{Solar radiation coefficient: } When Penman model is selected, the value of $k_r$ in Eq. \ref{eq:15} can be entered here.%help:end
\item %help:100320
    \textbf{wind coefficient: } When Penman model is selected the value of $k_a$ in Eq. \ref{eq:16} in the Penman model, can be entered here.%help:end
 \end{itemize}Several particle types can be introduced in GIFMod each having different properties and different constitutive models can be assigned to each group. The transport of particles in a GI system is governed by the following general mass balance equation: 
\begin{equation}
\label{eq:20}
\begin{split}
\frac{d\Gamma_{i,l} G_{p,l,i}}{dt} =\\ \beta_{p,l} \bigg[\sum_{j=1}^{nj} pos \big(Q_{ij}+v_{s,p,ij}A_{ij}\big)G_{p,l,j}-\sum_{j=1}^{nj} pos \big(-Q_{ij}-v_{s,p,ij}A_{ij}\big)G_{p,l,i}\bigg]\\
-S_i \big(\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}G_{p,l,i}-\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}G_{p,l',i}\big) + \beta_{p,l} \sum_{j=1}^{nj} A_{ij}\frac{D_{p,ij}}{d_{ij}}(G_{p,l,j}-G_{p,l,i})
\end{split}
\end{equation}
In Eq. \ref{eq:20}, the first term on the right hand side is advection due to flow and settling, the second term represents the exchange of particles between phases (i.e. mobile, attached, etc.), and the last term represent dispersion and diffusion of particles. 
Three pre-defined models for particle transport are provided in GIFMod respectively named Single Phase, Dual Phase and Triple Phase. In the single phase model a particle is assumed to only reside in mobile phase with no interaction with the solid phases. If a particle type is designated to be controlled by a dual phase model, it can interact between mobile phase and attached phase. Finally a triple phase model means that particles can be in mobile, reversibly attached and irreversibly attached phases. 
\begin{itemize}
    \item \textbf{Single phase mode: } If a particle type is assigned to have a single phase model, there will be only one phase with $\alpha_{p,1}=1$ and there will be no mass exchange between phases. The interaction between aqueous particles and the air-water interface is assumed to occur instantaneously based on an aqueous -AWI partitioning coefficient $K_{aw}$. $\Gamma$ in Eq. \ref{eq:20} in this case will be a single member vector equal to $S_i + K_{aw} S_{aw}$. By default the air-water interface area is assumed to be proportional to the volume of air-phase (i.e. $S_aw = \sout{V}_i - S_i$) under unsaturated condition in the unsaturated soil block.  
    \item \textbf{Dual phase model: } In a dual phase models particles can be in two phases including mobile and attached. $\Gamma$, $\textbf{K}$ matrix and $\alpha_p$ will respectively be: 
    \begin{equation}
    \label{eq:21}
    \vec{\Gamma}_i = 
    \begin{bmatrix} 
    S_i \\ 
    \sout{V}_i \rho_i 
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:22}
    \vec{K}_p = 
    \begin{bmatrix} 
    0 & f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}}) \\ 
    f_i k_{p,rel}  pos(|v_i|-v_{crit}) & 0\\
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:23}
    \vec{\beta}_p = 
    \begin{bmatrix} 
    1 \\ 
    0 \\
    \end{bmatrix}
    \end{equation}
    
    \item \textbf{Triple phase model: } In a triple phase models particles can be in three phases including mobile and irreversibly attached and reversibly attached. $\Gamma$, $\textbf{K}$ matrix and $\alpha_p$ will respectively be: 
    \begin{equation}
    \label{eq:24}
    \vec{\Gamma}_i = 
    \begin{bmatrix} 
    S_i \\ 
    \sout{V}_i \rho_i \\
    \sout{V}_i \rho_i 
    \end{bmatrix}
    \end{equation}
    \\
    \noindent
    \begin{equation}
    \label{eq:25}
    \noindent
    \vec{K}_p = 
    \begin{bmatrix} 
    0 & \zeta_p f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}}) & (1-\zeta_p) f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}})\\ 
    0 & 0 & 0\\
    f_i k_{p,rel}  pos(|v_i|-v_{crit}) & 0 & 0\\
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:26}
    \vec{\beta}_p = 
    \begin{bmatrix} 
    1 \\ 
    0 \\
    0 \\
    \end{bmatrix}
    \end{equation}
\end{itemize}
\subsection{Particle properties}
\begin{itemize}
\item %help:100097
\textbf{Attachment efficiency: } or sticking efficiency $\alpha_p$ in Eqs. \ref{eq:22} and \ref{eq:25}. This is the probability of a particle encountering a collector to stick to it. Not available for single phase particle model. %help:end
\item %help:100101
\textbf{Collection efficiency: } or transport efficiency $\eta_p$ in Eqs. \ref{eq:22} and \ref{eq:25}. The probability of a particle approaching a collector to encounter it. Not available for single phase particle model. %help:end
\item %help:100105
\textbf{Critical velocity for release: } Attached particles will start getting released when the velocity exceeds this value. The rate of release of attached particles is proportional to difference between the velocity in a block and the critical velocity (Eqs. \ref{eq:22} and \ref{eq:25}. Not available for single phase particle model. %help:end
\item %help:100108
\textbf{Diffusion coefficient: } $D_c$, Diffusion coefficient of the particle type beind defined. %help:end
\item %help:100109
\textbf{Dispersivity: } Dispersivity of the particle type. The mechanical dispersion coefficient will be calculated as: $D_{p,ij} = \alpha_{D,p} |v_ij| + D_{c,p}$; %help:end
\item %help:100116
\textbf{Irreversible collection fraction: } $\zeta_p$; in Eq. \ref{eq:25}. Only availble for the triple-phase particle model. %help:end
\item %help:100120
\textbf{Medium bulk density: } if entered this over-writes the bulk density specified in block properties in particle transport module. %help:end
\item %help:100127
\textbf{Partitioning coefficient to air-water interface: } The value of $k_aw$. %help:end
\item %help:100143
\textbf{Settling velocity: } Settling velocity $v_{s,p}$ in Eq. \ref{eq:20}. %help:end
\item %help:100150
\textbf{Specific surface area: } $f$ in Eqs. \ref{eq:22} and \ref{eq:25}%help:end
\end{itemize}

\subsection{Example: Colloid transport in a one dimensional saturated soil column under steady flow condition: } 
In this example we show the creation of a simple model of multi-disperse particle transport and filtration in a one-dimensional column under steady-state flow condition using GIFMod. The column will be assumed to have $50cm$ lenght and an area of $100cm^2$ and it which is  descretized into 10 layers. A dummy reservoir will also be added a the bottom of the column to ease imposition of downstream boundary condition through prescribed flow feature.   
\begin{itemize}
\item \textbf{Create the first block and assign the properties: } Add a Darcy block from the top menu. Set the following properties: 
- \textbf{Bottom Area: }\textit{$0.01m^2$}
- \textbf{Depth: }\textit{$0.05m$}
- \textbf{Bulk Density: }\textit{$1600 kg/m^3$}
- \textbf{Saturated moisture content: } \textit{$0.4$}
- \textbf{Initial moisture content: } \textit{$0.4$}
- \textbf{storitivity: } \textit{1$m^{-1}$} 
\item \textbf{Create a vertical array: } Right-click on the block that was just created and then click on "Make grid of blocks" item. Select "Vertical 2D Grid" and then change the number of rows to 10. Click "Ok". \\
- \textbf{Note: } When a vertical grid is made the bottom area of the original block will be copied as the interface area of the connectors. 
\item \textbf{Introducing particles: } We will model three different particle types with three different sticking rate coefficients $alpha_p$ values. In order to introduce the particles, from the Project Explorer right-click on \textbf{Water Quality}$\rightarrow$\textbf{Particles} and then select "Add Particles" from the drop-down menu. 
\item \textbf{Setting particle properties: } Set the following properties for the particle: 
- \textbf{Name: } \textit{Particle I} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: } \textit{1e-6}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\\\\
Add two more particle types with the following properties:
- \textbf{Name: }\textit{Particle II} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: }\textit{1e-5}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\\\\
- \textbf{Name: }\textit{Particle III} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: }\textit{1e-4}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\item \textbf{Save: } It is now a good time to save the work. 
\item \textbf{Inflow file: } Here we create the inflow file. It is assumed that the flow rate is constant and equal to $0.01m^3/day$ which results in a velocity of $2.5m/day$ over the entire experiment which takes 1 day and the particle concentration for all three types of particles in $10mg/L$ for a period of 1hr and which is followed by no particles in the inflow. The inflow file will look like figure \ref{fig:12}. 
\begin{figure}[!ht]\label{fig:12}
\begin{center}
\includegraphics[width=8cm]{Images/Figure12.png} \\
\caption{Inflow file for particle transport in soil example} 
\end{center}
\end{figure}
Create or download "inflow.txt" from the example folder. Click on block \textbf{Darcy (1)} and choose the inflow file from inflow time series field in the properties dialog box. \\
Right-click on the \textbf{Darcy (1)} block and visualize the time series using \textbf{Plot Inflow Properties} menu item. The inflow concentration for particle I for example should look like Figure \ref{fig:13}
\begin{figure}[!ht]\label{fig:13}
\begin{center}
\includegraphics[width=8cm]{Images/Figure13.png} \\
\caption{Concentration of Particle I in the inflow} 
\end{center}
\end{figure}
\item \textbf{Outflow: } In order to impose the outflow boundary condition a dummy reservoir will be added to the bottom of the soil column. The type of the block used for this reservoir is not important because we will use the \textbf{prescribed flow} feature to control the outflow. Let's use a storage block to create the dummy outflow reservoir. Add a storage by clicking on the storage icon \includegraphics[width=0.5cm]{Icons/storage_icon.png} on the top tool bar. Move the newly added storage block to the bottom of the column and connect it to the block named \textbf{Darcy (10)}. \\
- Enter a non-zero \textbf{length} for the newly added connector and non-zero \textbf{bottom area} and  \textbf{depth} for the newly added storage block. These two values are required for the model to run. Also to prevent the storage block to become over-saturated enter a value of zero in the \textbf{Head-Storage relationship} property of the newly added storage block and set the bulk density of the storage block to \textit{1600$kg/m^3$}. //
\textbf{Note: } Note that if the value of \textbf{Medium Bulk Density} is entered in particle properties of a particle type, it will be used as the media density when performing the mass-balance for that particle class. 
\item \textbf{Outflow rate time-series: } We want the outflow rate to be equal to the inflow rate. This can be accomplished in two ways. One is to turn on the "Steady State Hydraulics" in the \textbf{Setting$\rightarrow$Project Settings} or by assigning a \textbf{prescribed flow} to the bottom connector. We are going to use the second approach here. The flow time series to be prescribed to the \textbf{Darcy (10)-Pond (1)} connector should look like Figure \ref{fig:14}. Name the file "outflow.txt". 
\begin{figure}[!ht]\label{fig:14}
\begin{center}
\includegraphics[width=8cm]{Images/Figure14.png} \\
\caption{Outflow file} 
\end{center}
\end{figure}
Please note that the heading file in figure \label{fig:14} is ignored by the program and is only necessary for user documentation. \\
- Click on the \textbf{Darcy (10)-Pond (1)} connector, and choose "outflow.txt" from the \textbf{Prescribed flow} property. \\
- Set \textbf{Use Prescribed Flow} to "Yes". \\
- Save the project. 
- Now the model is ready to run. Click on the run icon \includegraphics[width=0.5cm]{Icons/run_icon.png} on the left side tool bar and wait for the simulation to end. \\
- Right-click on the block named \textbf{Darcy (10)} and choose \textbf{Water Quality Results$\rightarrow$ Pericles I$\rightarrow$ Mobile} to see the breakthrough curve for particle type I \\
Do the same thing for \textbf{Particle II} and \textbf{Particle III}. 
Right-click on the graph containing particle II results and click on \textbf{Copy Curve} item, then click on the graph containing particle type I results, right-click and select \textbf{Paste} item. \\ - Do the same thing with particle III to see the three breakthrough curves for the three particle types in a single graph. You can change the format of each curve by right-clicking on the graph and selecting the name of each curve (fig \ref{fig:30}).
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure30.png} \\
\caption{Particle breakthrough curves for the three particle classes}\label{fig:30}
\end{center}
\end{figure}

\end{itemize}
\newpage
\subsection{Example: Particle settling in a one-dimensional water body: } 
In this example we create a simple model of particles settling in a one dimensional water column. Similar to the previous example, three particles classes will be considered but this time their settling velocities will be different. We will use an array of storage block to create water column. The water column is assumed to have a height of 1.5m which is descritized into 10 equally sized layers each represented by a single storage block. The particles are assumed to be initially uniformly distributed and are allowed to settle under gravity. 
\begin{itemize}
\item \textbf{Create a new project} \\
\item \textbf{Introducing particle classes: } 
From the \textbf{Project Explorer} right-click on \textbf{Water Quality}$\rightarrow$\textbf{Particles} and then select "Add Particles" from the drop-down menu. 
\item \textbf{Setting particle properties: } Set the following properties for the particle: 
- \textbf{Name: } \textit{Particle I} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{10$m/day$}
\\\\
Add two more particle types with the following properties:
- \textbf{Name: } \textit{Particle II} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{1$m/day$}
\\\\
- \textbf{Name: } \textit{Particle III} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{0.1$m/day$}

\item \textbf{Save: } It is now a good time to save the
\item \textbf{Create a storage block and set the properties: } Add a storage by clicking on the storage icon \includegraphics[width=0.5cm]{Icons/storage_icon.png} on the top tool bar. \\
- Set the following properties for the storage block:
- \textbf{Bottom Area: }\textit{10$m^2$}
- \textbf{Depth: }\textit{0.15m} \\
- \textbf{Initial water depth: }\textit{0.15m} \\
- \textbf{Saturated moisture content: } \textit{1} (There is no solid media in the storage blocks) \\ 
- \textbf{Initial particle concentration: } Click on the "..." symbol in front of the \textbf{Particle Initial Concentration} label in properties windows and enter a concentration of 10 for the three particle classes as is shown in figure \ref{fig:17}.  \\
\begin{figure}[!ht]\label{fig:17}
\begin{center}
\includegraphics[width=8cm]{Images/Figure17.png} \\
\caption{Particle initial concentration} 
\end{center}
\end{figure}
- \textbf{Creating an array of storage blocks: } Right-click on the storage block that was just created and choose \textbf{Make Grid of Blocks} item from the menu. Choose \textbf{vertical 2D grid} option and enter 10 in the \textbf{Number of rows} box. 
\item \textbf{Turn settling on for all the connectors: } By default the settling option for the connectors is set to \textbf{No}. In order to allow settling transport to occur via connectors the \textbf{Settling} option should be turned to \textbf{Yes}. Select all the connectors one by one and set the \textbf{Settling} property to \textbf{Yes}.
\item \textbf{Run the model: } Click on the run bottom on the left hand side tool bar \includegraphics[width=0.5cm]{Icons/run_icon.png} and wait for the simulation to end. 
\item \textbf{Checking the results: } Right click on the \textbf{Storage (10)} block and choose \textbf{Plot Water Quality Results}$\rightarrow$\textbf{Particle I}$\rightarrow$\textbf{Mobile} to see the temporal variation of \textbf{Particle I} particle class at the bottom of the column. Do the same thing for \textbf{Particle II} and \textbf{Particle III} particle groups. You can copy and paste all curves into one window to compare the results for each particle class (Figure \ref{fig:31}). 
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure31.png} \\
\caption{Particle initial concentration}\label{fig:31} 
\end{center}
\end{figure}
\item \textbf{Adding particle diffusion: } Change \textbf{Diffusion coefficient} for all the particles to 0.1$m^2/day$ by clicking on each particle size from \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Particles}$\rightarrow$ and changing the \textbf{diffusion coefficient} property of all particles to 0.1$m^2/day$ .Run the simulation again. The diffusion should prevent all particles to settle to the bottom block. 

\end{itemize}