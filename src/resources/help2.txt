\subsubsection{Example: BOD mineralization under rate-limited aeration: }
In this example we will model a batch system containing a aerobically degrading substrate that recieves dissolved oxygen through aeration. The parameters of the experiment are assumed to be as follows:
- \textbf{Area: } \textit{0.2 $m^2$}\\
- \textbf{Depth: } \textit{0.3 m}\\
- \textbf{Aeration model: } \textit{Rate limited} \\
- \textbf{Oxygen transfer rate coefficient: } \textit{2 $day^{-1}$}\\
- \textbf{Initial BOD concentration: } \textit{25 mg/L}\\
- \textbf{Initial DO concentration: } \textit{7 mg/L}\\
- \textbf{BOD mineralization rate, ($k_d$): } \textit{10 $day^-1$}\\
- \textbf{DO half saturation concentration: } \textit{2 mg/L}
- \textbf{BOD half saturation concentration: } \textit{5 mg/L}


Below are the steps to create the model:

\begin{itemize}

\item Start GIFMod or create a new project
\item \textbf{Add constitients: } Add two constituents called BOD and DO by right-clicking on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Constituents} and then clicking on \textbf{Add Constituents}
\item \textbf{Creating an external flux object: } Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{External Fluxes} and click on \textbf{Add External Flux} 
\item Set the following properties for the external flux object that was just added:  \\
- \textbf{Name: } \textit{Aeration} \\
- \textbf{Coefficient: } \textit{2 $day^{-1}$} \\
- \textbf{Constituent: } \textit{DO}\\
- \textbf{Model: } \textit{Constant rate} \\
- \textbf{Saturation: } \textit{8.5 mg/L}\\


\item \textbf{Add a pond: } A pond block is used to represent the batch system. From the top tool bar, click on the pond icon \includegraphics[width=0.5cm]{Icons/pond_icon.png}.
\item Set the following properties for the pond that was added. 
- \textbf{Bottom area: } \textit{0.2$m^2$} \\
- \textbf{Initial water depth: } \textit{0.3 m} \\
- \textbf{Constituent initial concentration: } \textit{BOD=25 mg/L, DO=7mg/L}\\
- \textbf{External Flux: } \textit{Aeration} \\

\item \textbf{Adding reactions parameters: } Add the following reaction parameters: 
- BOD maximum decay rate, k\_d, value = 10 $day^{-1}$\\
- DO half saturation constant, K\_o, value = 2 mg/L \\
- BOD half saturation constant, K\_s, value = 5 mg/L \\

\item \textbf{Setting reactions: } Set the reaction network as shown in Figure \ref{fig:28}.
\item \textbf{Setting simulation duration: } Set the simulation duration to 20 days by setting the \textbf{Simulation end time: } to Jan-10-1990 from \textbf{Project settings}. 
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{Images/Figure28.png} \\
\caption{Reaction network for the simple BOD model}\label{fig:28}
\end{center}
\end{figure}

\item \textbf{Running the model: }The model is ready to run. Click on the \textbf{forward run bottom} \includegraphics[width=0.5cm]{Icons/run_icon.png} and wait until the simulation ends. 

\item \textbf{Inspecting the results: } Right-click on the block identified as \textbf{Pond (1)} and choose \textbf{Plot Water Quality Results}$\rightarrow$\textbf{DO}. Similarly check the BOD results. The graphs should look like figure \ref{fig:29}.
\begin{figure}
\begin{center}
\begin{tabular}{c c}
a) \includegraphics[width=5cm]{Images/Figure29a.png} & b) \includegraphics[width=5cm]{Images/Figure29b.png}\\
\end{tabular}
\caption{Temporal variation of a) DO and b) BOD in the simple batch test with aeration example}\label{fig:29}
\end{center}
\end{figure}

\end{itemize}\subsection{Example: A simple activated sludge model: } 
 creation of a simple activated sludge model for BOD removal using GIFMod is demonstrated. Figure \ref{fig:21} shows the schematic of the activated sludge system. A two component model with substrate identified by $S$ and biomass identified by $X$ will be created. The parameters of the model are listed in table \ref{table:ASM}.  
 
\begin{figure}[!ht]\label{fig:21}
\begin{center}
\includegraphics[width=8cm]{Images/Figure21.png} \\
\caption{Activated Sludge System schematic} 
\end{center}
\end{figure}
 
 
\begin{table}
\caption{Parameters of the activated sludge model example}
\begin{tabular}{l l}\label{table:ASM}
parameter & value \\
\hline
Volume of aeration tank & 8468$m^3$ \\
Volume of the clarifier & 60$m^3$ \\
maximum growth rate ($\mu_{max}$) & 6$day^{-1}$ \\
Substrate half saturation constant ($k_s$) & 20mg-COD/L \\
Biomass decay rate ($k_d$) & 0.12$day^{-1}$ \\
Yield coefficient for heterotrophic growth ($Y$) & 0.4  mgVSS/mgCOD. \\
Inflow flow rate ($Q_{in})$ & 22464$m^3/day$ \\
Inflow substrate concentration ($S_{in}$) & 224$mgCOD/L$ \\
Wasting flow rate ($Q_{WAS}$) & 300 $m^3/day$ \\
Return flow rate ($Q_{RAS}$) & 13478 $m^3/day$ \\
Area of the clarifier & 3000$m^2$ \\
Depth of the clarifier & 2m \\
Settling velocity of biomass & 100$m/day$ \\
 \end{tabular}\\
\end{table}

Steps to create the simple activated sludge model:
\begin{itemize}
\item \textbf{Start GIFMod}
\item \textbf{Setting the duration of the simulation: } We want the simulation to run for 20 days so a 
steady-state solution is achieved. In order to do so go to \textbf{Project Explorer}$\rightarrow$\textbf{Project Setting} and from the \textbf{Properties} window set the simulation end date to January 20, 1900. This result in a period of simulation from 0 to 20days. 
\item \textbf{Add Aeration Tank: } We will use the \textbf{Pond} block to create the components of the model including the aeration tank, the clarifier and the reservoirs to hold the effluent and waste flow. Other blocks types could also be used as we will use the \textbf{quasi steady-state} method to calculate flows. \\
- Add a pond to represent the aeration pond. \\
- Set the following properties: 
- \textbf{Name: } \textit{Aeration Tank} \\
- \textbf{Bottom area: }\textit{8468$m^2$} \\
- \textbf{Initial water depth: }\textit{1m} \\
\textbf{Note: } As long as a depth and area result in the required volume of 8468$m^3$, the depth and bottom area will not influence the results. If aeration was to be considered, then the area could determine the rate of dissolved oxygen flux into the pond depending on the external flux model (See section \ref{sssec:ExtFlux}).\\ 
\item \textbf{Adding other ponds: } The clarifier will be modeled using two vertically connected ponds and two additional ponds will be used to retain waste and effluent flow. A larger number of layers could be used to represent the clarifier but to keep this example simple, it is limited to two ponds. \\
Add the following pond blocks:\\\\
\textbf{Clarifier top: }\\
- \textbf{Name: } \textit{Clarifier top} \\
- \textbf{Bottom area: }\textit{30$m^2$} \\
- \textbf{Initial water depth: }\textit{1m} \\\\
\textbf{Clarifier Bottom: }\\
- \textbf{Name: } \textit{Clarifier bottom} \\
- \textbf{Bottom area: }\textit{3000$m^2$} \\
- \textbf{Initial water depth: }\textit{1m} \\
- \textbf{Bottom elevation: }\textit{-1m}\\
\textbf{Note: } The bottom elevation of the lower compartment of the clarifier need to be below the bottom elevation of the top compartment for the settling of biomass to be appropriately calculated in the clarifier.\\\\ 
\textbf{Waste Storage: }\\
- \textbf{Name: } \textit{Waste Storage} \\
- \textbf{Bottom area: }\textit{3000$m^2$} \\
- \textbf{Initial water depth: }\textit{0} \\\\
\textbf{Effluent Storage: }\\
- \textbf{Name: } \textit{Effluent Storage} \\
- \textbf{Bottom area: }\textit{3000$m^2$} \\
- \textbf{Initial water depth: }\textit{0} \\
\item \textbf{Adding Connections: } Connect the following pond blocks together: \\
- \textbf{Aeration Tank} to \textbf{Clarifier top}\\
- \textbf{Clarifier Top} to \textbf{Clarifier bottom}\\
- \textbf{Clarifier Top} to \textbf{Effluent Storage}\\
- \textbf{Clarifier Bottom} to \textbf{Waste Storage}\\
- \textbf{Clarifier Bottom} to \textbf{Aeration Tank}\\
- Enter a length of 1 for all the connectors. 

\textbf{Note: } The length that is entered for the connectors is not actually used in calculations of flow because the quasi-steady state approach will be used. But GIFMod does not allow connectors with zero lengths so the value must be entered. After adding the connectors the model configuration should look like figure \ref{fig:22}.
- Select the connector from \textbf{Clarifier top} to \textbf{Clarifier bottom} and set the \textbf{Settling} property to \textbf{Yes}. This forces the model to consider settling advective transport in this connector. 

\begin{figure}
\begin{center}
\includegraphics[width=10cm]{Images/Figure22.png} \\
\caption{Activated sludge model configuration in GIFMod}\label{fig:22}
\end{center}
\end{figure}
\item \textbf{Adding constituents: } Two constituents  including substrate (S) and biomass (X) will be considered in the model.
- Add two constituents by right-clicking on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Constituents} and then choose \textbf{Add Constituents} from the drop-down menu. Change the name of the first constituent to \textbf{S} and the second one to \textbf{X}. 
- Change the settling velocity of the \textbf{X} constituent to 100m/day. 
\item \textbf{Inflow rate and characteristics: } The inflow characteristics input file looks like figure \ref{fig:23}. Create this file or upload it from the example folder and save it in a folder on your hard drive as inflow.csv or any other names you desire. 
//- Click on the aeration tank and from the \textbf{Inflow time-series} property in the properties window select the file containing the inflow time series. Note that only to time-point are needed because the flow rate and characteristics are assumed to be constant throughout the simulation. 
\begin{figure}
\begin{center}
\includegraphics[width=5cm]{Images/Figure23.png} \\
\caption{Inflow input file for the activated sludge example}\label{fig:23}
\end{center}
\end{figure}
The quasi steady state hydraulics mode solve the flow rates in each connector by assuming that the summation of inflows and outflows are equal. At this point if we consider a quasi-steady state flow there are 5 connectors while the inflow=outflow condition can only be applied to the three blocks that have more than one connectors connected to them (i.e. Aeration tank, Clarifier top, and Clarifier bottom) and so there is only three equations for five unknowns. However, in activated sludge systems typically the waste and return flows are controlled. We impose the flow rates in the RAS and WAS connectors using prescribed flow. The input prescribed flow files for the two connectors are shown in figure \ref{fig:24}. Create the files and save them respectively as return.csv and waste.csv. 
\begin{figure}
\begin{center}
\begin{tabular}{c c}
a) \includegraphics[width=5cm]{Images/Figure24.png} & b) \includegraphics[width=5cm]{Images/Figure24b.png}\\
\end{tabular}

\caption{a) return and b) waste flow input file for the activated sludge example}\label{fig:24}
\end{center}
\end{figure}
Note that the heading line for the prescribed flow input files are not necessary, so deleting the first line in the files will not affect the output. \\\\
- Click on connector connecting \textbf{Clarifier bottom} to the \textbf{Aeration tank} (i.e. return activated sludge connector). \\\\
- From the properties window, set \textbf{Use prescribed flow} to \textbf{Yes} and choose return.csv as the \textbf{Prescribed flow time series}. \\\\
- Do the same for the connector from \textbf{Clarifier bottom} to {Waste Storage} and pick waste.csv as the \textbf{Prescribed flow time series}. \\
\item \textbf{Biomass Settling in the clarifier: } In order to force the biomass in the clarifier the settling property of the connector connecting the top clarifier compartment to the lower clarifier compartment should be set to \textbf{Yes}. Click on the connector connecting \textbf{Clarifier top} to \textbf{Clarifier bottom} and from the properties window look for the \textbf{Settling} option and set it to \textbf{Yes}. 
\item \textbf{Biomass initial condition: } The should be some biomass in the clarifier initially for the biomass growth to be possible. We will start from a small (1$mg/L$) concentration of biomass. Click on the aeration tank and click on the box in front of \textbf{Constituent Initial Concentration}. From the window that will pop up, select X as the constituent and enter the value 1 under the value column and then close the window (Figure \ref{fig:26}). 
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{Images/Figure26.png} \\
\caption{Setting initial biomass concentration in the simple activated sludge model}\label{fig:26} 
\end{center}
\end{figure}

\item \textbf{Entering reaction parameters: }\\
- Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction parameters} and click on \textbf{Add reaction parameter} item from the drop-down menu. \\
- Type "$\sim mu\_max$" in the name field and enter a value of 6. 
- Similarly add the other reaction parameters including $k_d$, $Y$ and $K_s$ with values of respectively 0.12, 0.4, and 20. 
\item \textbf{Setting up reactions: }\\
- Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction network} and click on \textbf{Open Reaction Network Window}. \\
- Enter the processes names, rate expressions and stoichiometric constants as see in figure \ref{fig:27}.
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{Images/Figure27.png} \\
\caption{Reaction network for the simple activated sludge model}\label{fig:27}
\end{center}
\end{figure}
\item \textbf{Turning off reactions in clarifier and waste and effluent storage blocks}: In most activated sludge models the reactions in claifier is neglected. Also in order to use the waste storage and effluent storage to gain information about the characteristics of effluent and storage it may be desirable to preserve the mass balance in these two blocks by turning off reactions in them. \\
- Turn off reactions in \textbf{Clarifier top}, \textbf{Clarifier bottom}, \textbf{Waste Storage}, and \textbf{Effluent Storage} blocks by clicking on them and switching the value of \textbf{Conduct reactions} to \textbf{No}. \\
\item \textbf{Running the simulation} Now the model is ready. Click on the \textbf{forward run} icon icon \includegraphics[width=0.5cm]{Icons/run_icon.png} on the tool bar on the left side of the screen and wait for the simulation to end. 
\textbf{Inspecting the results: } Right-click on the \textbf{aeration tank} and click \textbf{Water quality results}$\rightarrow$\textbf{S} to see the variation of substrate in the aeration tank. Do the same thing for \textbf{X}. Similar to the previous example you can copy the two graphs unto each other (Figure \ref{fig:32}). 
\begin{figure}
\begin{center}
\includegraphics[width=8cm]{Images/Figure32.png} \\
\caption{S and X variation in the simple ASM model}\label{fig:32}
\end{center}
\end{figure}

\end{itemize}
\subsection{Example: Build-up and wash-off of contaminant from an urban catchment}

In this example we will build a model to simulate the build-up and wash-off of a hypothetical pollutant. For the simulation A 30m$\times$30m square shaped catchment descritized into a 3$\times$3 grid is considered. Table \ref{table:Build-up} shows the parameters of the model. The model can for example represent a squared shaped parking lot. For the sake of simplicity, no infiltration or evaporation over the catchment has been considered.  

\begin{table}
\caption{Parameters of build-up/wash-off example}
\begin{tabular}{l l}\label{table:Build-up}
parameter & value \\
\hline
Area of the catchment & $30m\times 30m$ \\
Build-up rate constant, $k_{bld}$ & $2mg/m^2 day$ \\
Saturation build-up concentration, $C_{bsat}$ & $10mg/m2$ \\
Slope of the catchment & 0.01 in both directions \\
\end{tabular}\\
\end{table}

Steps to create the build-up and wash-off example:
\begin{itemize}
   \item \textbf{Add a constituent: } Right-click on on \textbf{Project Explorer}$\rightarrow$\textbf{Water quality}$\rightarrow$\textbf{Constituents} and click on \textbf{Add constituent}. Change the name of the constituent to \textbf{Pb}.
    \item \textbf{Creating the build-up object: } Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water quality}$\rightarrow$\textbf{Build-ups} and click on \textbf{Add build-up}. 
    Set the following properties for the block that was just added: \\
    - \textbf{Accumulation rate: } 2\\
    - \textbf{Model: } Exponential \\
    - \textbf{Constituent: } Pb \\
    - \textbf{Sorbed/attached: } Yes \\
    - \textbf{Saturation: } 10 \\
    
    \textbf{Note: } Setting \textbf{Sorbed/attached} to yes indicates that the built-up Pb will be accumulated as sorbed to the solid phase (in this case pavement surface). So  solid-water exchange parameters for Pb needs to be adjusted to let the sorbed Pb to be released into the overland flow during rain events. \\
    \item \textbf{Add a catchment block: } From the top tool bar click on the \textbf{Add catchment} bottom \includegraphics[width=0.5cm]{Icons/catchment_icon.png}. Set the following properties for the catchment block: \\
    - \textbf{Area: } 100$m^2$ \\
    - \textbf{Manning's roughness coefficient: } 0.011$s  m^{-1/3}$. \\
    - \textbf{Width: } 10m \\
    - \textbf{Length: } 10m \\
    - \textbf{Build-up: } \textit{Build-up} \\
    \textbf{Note: } The \textbf{width} and \textbf{length} properties of a \textbf{Catchment} block will be used to assign length and width to the connectors that will be generated as a result of creating an array. 
   \item \textbf{Create an array of catchments: } Right-click on the catchment block and click on \textbf{Make grid of blocks}. Change \textbf{number of rows} and \textbf{number of columns} to the value of 3. Also enter a value of -0.3 into \textbf{Total bottom elevation change in x direction} and \textbf{Total bottom elevation change in y direction}. Change the values of \textbf{Horizontal distance between cells in x direction} and \textbf{Horizontal distance between cells in x direction} to 10m. 
   \item \textbf{Precipitation: } We will use a previously prepared precipitation input file (precipitation.txt) saved in the example folder. Make sure to download the precipitation file and save it somewhere on your hard-drive. 
   - From \textbf{Project Explorer}$\rightarrow$\textbf{Settings}$\rightarrow$\textbf{Climate Setting} select "precipitation.txt" as the \textbf{Precipitation time-series}. 
   - Right-click on the box where the name of the precipitation input file is written and click on \textbf{flow} from the drop-down menu. A graph similar to what is shown in Fig \ref{fig:33} will pop-up. 
   
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure33.png} \\
\caption{Precipitation time series for the build-up example}\label{fig:33} 
\end{center}
\end{figure}
   \item \textbf{Duration of simulation} Our duration of simulation will cover a portion of the period for which precipitation data is available. From \textbf{Project Setting}$\rightarrow$\textbf{Project Setting} set the start date of the project to \textbf{Sep 01 2012} and the end date to \textbf{Oct 01 2012}. 
   \item \textbf{Adding a Receiving water pond: } In order to impose the down stream boundary condition correctly and also to keep track of the runoff volume and pollutant load leaving the catchment a pond will be added to the model and will be connected to the lowest catchment (lower-right) block. Add a pond \includegraphics[width=0.5cm]{Icons/pond_icon.png} and move it to the lower left side of the screen. Then connect it to the lower left catchment block (Figure \ref{fig:34}).\\
   
   Assign the following properties to the pond block: -\textbf{Area: } \textit{1000$m^2$}, -\textbf{Bottom Elevation: }  \textit{-1m}, -\textbf{Precipitation: } \textit{No}. \\
   
   The reason for the last setting is to prevent precipitation to enter the pond in order to be able to use the pond's storage to keep track of runoff volume:
   
   Assign the following properties to the connector connecting \textbf{Catchment (9)} to \textbf{Pond (1)}: -\textbf{Manning's roughness coefficient: } \textit{0.011 $s  m^{-1/3}$}, -\textbf{Width: } \textit{10m}, -\textbf{Length: } \textit{5m}.  
   
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=10cm]{Images/Figure34.png} \\
\caption{Catchment and pond diagram for the build-up, wash-off example}\label{fig:34} 
\end{center}
\end{figure}   
   
\item Save the model and run it. After the simulation is done, check the hydraulic and water quality results by right-clicking on blocks or connectors (Figure \ref{fig:38}). 
    
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=7cm]{Images/Figure38.png} \\
\caption{Runoff rate leaving the catchment}\label{fig:38} 
\end{center}
\end{figure}  

\item Right-click on one of the catchment blocks and click on \textbf{Plot water quality results}$\rightarrow$\textbf{Sorbed/particle associated}$\rightarrow$\textbf{Pb}$\rightarrow$\textbf{Soil} to see the temporal variation of Pb accumulated on the surface. The results should look like Figure \ref{fig:39}. As it can be seen the concentration asymptotically approach $10mg/m^2$. The concentration of Pb in the runoff is zero due to the fact that no release properties have been attributed to Pb. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=7cm]{Images/Figure39.png} \\
\caption{Concentration of Pb accumulated on the surface for the case when solid-water exchange is inactive}\label{fig:39} 
\end{center}
\end{figure} 

\item \textbf{Setting solid-water exchange properties: } To set solid-water exchange properties for Pb, click on \textbf{Water Quality}$\rightarrow$\textbf{Constituents}$\rightarrow$\textbf{Pb} from the project explorer and then click on \textbf{Exchange rate} from the \textbf{Properties} menu. In the table, select \textbf{Soil} in the first column and type $0.1$ as the exchange rate and $0.1$ for the partitioning coefficient. This indicates that the release rate constant for the exchange between solid phase and aqueous phase is $0.1day^{-1}$ while the equilibrium partition coefficient $S/C$ is $0.01m^2/m^3$ (Figure \ref{fig:40}). Close the dialog. \\ 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=7cm]{Images/Figure40.png} \\
\caption{Entering exchange properties}\label{fig:40} 
\end{center}
\end{figure}

\item Run the model again. 

\item Right-click on one of the blocks to see the concentration of Pb in the runoff and the sorbed Pb concentrations. The results should look like Figure \ref{fig:41}. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=7cm]{Images/Figure41.png} \\
\caption{Aqueous phase (top) and surface-bound (bottom) Pb in \textbf{Catchment (9)} block}\label{fig:41} 
\end{center}
\end{figure}



\end{itemize}

Build-up objects allows modeling accumulation of contaminants on the surfaces throughout the simulation period. In order to assign build-up to an block object, the user first should introduce a build-up object by right-clicking \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Build-ups} and then clicking on \textbf{Add Build-up}. Build-up can be applied to both constituents and particles. Two pre-defined build-up models have been provided in the model including \textbf{Linear} and \textbf{Exponential} models: 

\begin{itemize}
\item \textbf{Linear build-up model: } In the linear model it is assumed that the build-up occurs at a constant rate. So the accumulation term in the mass-balance equation will be:
\begin{equation}
\label{eq:34}
\dot{m} = k_{bld} A_s 
\end{equation}

\item \textbf{Exponential build-up model: } This model is based on the widely accepted assumption based on several observations that the built-up mass on surfaces reaches a plateau after a certain times due to the resuspension of the accumulated pollutants as a result of wind or traffic \citep{alley1981}. The form of the equation is as follows: 
\begin{equation}
\label{eq:35}
\dot{m} = k_{bld} A_s (1-\frac{C}{C_{bsat}})
\end{equation}
in this equation $C$ is surface concentration of the accumulating contaminant typically considered as sorbed to the surface of a catchment segment and $C_{bsat}$ is the saturation accumulation concentration. 
\end{itemize}
\subsubsection{Properties of a build-up object: }
In this subsection the properties of build-up objects are described: 
\begin{itemize}
    
\item \textbf{Name: } This indicates the name of a build-up object. The name is used when assigning build-up to blocks. 
\item \textbf{Accumulation Rate: } The build-up rate constant $k_{bld}$ is entered here. 
\item \textbf{Constituent: } This indicate which constituent to be accumulated based on the build-up mode. Multiple build-up objects can be assigned to a single block. 
\item \textbf{Model: } Using this property, the user can specify what model to be used to model build-up. 
\item \textbf{Saturation: } The saturation concentration $C_{bsat}$ in Eq. \ref{eq:35}.
\item \textbf{Sorbed/Attached: } Indicates whether the build-up should be considered as sorbed to the solid phase. The recommendation is to set this property to \textit{Yes} since build-up typically occur during dry periods when there is no aqueous phase available. 
\end{itemize}
\input{build-up-ex.tex}Constituents are referred to any chemical compound or a group of chemical compounds with assumed effective transport parameters that can present in aqueous phase or be sorbed to soil matrix or particles. In addition some biological agents such as bacteria or algae can also be treated as constituents. There is no pre-defined constituents in GIFMod and the user should introduce them and assign transformation processes to them. In this section the governing equations and different processes that can be assigned to constituents in GIFMod will be described. The general mass balance equation for fate and transport of constituents in GIFMod is:
\begin{equation}
\label{eq:26}
\begin{split}
\frac{d\Gamma_{i,p,l} C_{p,l,i,k}}{dt} =\\ \beta_{p,l} \sum_{j=1}^{nj} pos \big(Q_{ij}+(v_{s,p,ij}+v_{c,k,ij})A_{ij}\big)\tilde G_{p,l,j}C_{p,l,j,k} \\ -\beta_{p,l} \sum_{j=1}^{nj} pos \big(-Q_{ij}-(v_{s,p,ij}+v_{c,p,ij})A_{ij}\big)\tilde G_{p,l,j}C_{p,l,j,k}\bigg]\\
-S_i \big(\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}\tilde G_{p,l,i}C_{p,l,i,k}-\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}\tilde G_{p,l',i}C_{p,l',i,k}\big)\\
+ \beta_{p,l} \sum_{j=1}^{nj} A_{ij}\frac{D_{p,ij,k}}{d_{ij}}(\tilde G_{p,l,j}C_{p,l,j,k}-\tilde G_{p,l,i}C_{p,l,i,k}) \\
+ S_i \sum_{p=-1}^{np} \sum_{l'=1}^{nl_p}\kappa_{k,p,p'}\bigg(\frac{C_{p',l',i,k}}{\phi_{k,p'}}-\frac{C_{p,l,i,k}}{\phi_{k,p}}\bigg)  \\ +S_i \sum_{r=1}^{nr} \psi_{r,k}R_r + S_i \xi_{p,l,i,k} \\
+ \sum_j^{ns} pos(Q_{s,j} \tilde G_{p,l,j,in} C_{p,l,j,k,in}) - \sum_j^{ns} pos(-\omega_{p,l,j} Q_{s,j} \tilde G_{p,l,j,in} C_{p,l,j,k,in}) + \dot{m}_{i,p,l,k}
\end{split}
\end{equation}
In Eq. \ref{eq:26}, the first two terms of the right hand side represent dissolved and particle-bound advective transport due to flux and settling, the third term is the mass exchange of constituents between phases due to exchange of particles, the forth term is dispersion due to the dispersion due to both dispersion of particle-bound and dissolved constituents, the fifth term is the mass exchange through adsorption and desroption, the six term represents biogeochemical transformation, the seventh term is external flux (such as aeration), and eight and night terms are respectively sources or sinks due to inflow and outflow or plant uptake. Subscript $p=-1$ represent the solid matrix and $p=0$ represent the aqueous phase while a $p>0$ refer to the particle class. $\tilde G_{p,l,j}$ is the same as $G_{p,l,j}$ in Eq. \ref{eq:20} for $p>0$, is equal to $1$ for $p=0$ (dissolved species) and equal to bulk density, $\rho_i$ for $p=-1$ (soil matrix). Subscript $in$ indicate the values in the inflow. Also in this equation $D_{p,ij,k}$ is the dispersion/diffusion coefficient for particles when $p>0$ (particles) and constituent's dispersion/diffusion coefficient when $p=0$ (dissolved species). Also Sorption capacity, $\phi_{k,p}$, is equal to partitioning coefficient $K_D$ for soil and particles ($p=-1$ and $p>0$ respectively) and equal to 1 for dissolved species ($p=0$).  

\subsection{Constituent properties}
In this section the properties of constituents are described. To  add a new constituent right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Constituents} and click on \textbf{Add Constituent}. \\
Below the properties of constituents are described.
\begin{itemize}
\item \textbf{Name: } This is the name of the constituent. Names of constituents should be unique. Constituent names will be used in producing outputs and also when entering the reaction network. 
\item \textbf{Diffusion coefficient: } This specifies the molecular diffusion coefficient of the constituent. When calculating the mechanical dispersion, this value will be added to the dispersion coefficient calculated based on the dispersivity value entered for each connector. 
\item \textbf{Exchange rate factor: } This bring a window where the user can enter the solid-aqueous phase rate $\kappa_{k,p,p'}$ in Eq. \ref{eq:26} and partitioning coefficient $K_D$ with respect to soil matrix and each particle class. 
\item \textbf{Partitioning coefficient: } This bring a window where the user can enter the solid-aqueous phase rate $\kappa_{k,p,p'}$ in Eq. \ref{eq:26} and partitioning coefficient $K_D$ with respect to soil matrix and each particle class. 
\item \textbf{Settling velocity: } The settling velocity of the constituent, $v_c$. 
\end{itemize}

\subsection{Reactions}
In order to define reactions two steps are needed. First some reaction parameters will be defined that can represent reaction rate constants, half-saturation coefficients, stoichiometric constants and other parameters needed in defining the reaction process. It shoule be noted that a user can define reactions by explicitly entering parameter values into reaction expressions however this approach is not advised. The second step is to enter reaction rate expressions and stoichiometric constants into a Petersen matrix \citep{russell2006}. 

\textit{Reactions Parameters: }\\
To add a reaction parameter right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction Parameters} and click on \textbf{Add Reaction Parameter} from the drop down menu. Select the reaction parameter that was added to change its properties.
\begin{itemize}
\item \textbf{Name: } Name of the reaction parameter to be used in defining reaction expressions. 
\item \textbf{Temperature correction factor: } Specifies the dependency of the value of the reaction rate parameter to temperature. Under variable temperature condition the value of the reaction parameter entered in the \textbf{Value} field represent the value of the parameter in $20^oC$. The value at other temperatures is calculated as: 
\begin{equation}
\label{eq:27}
k_T = k_{20} \Theta^{T-20}
\end{equation}
\item \textbf{Value: } The value of the parameter. Please note that the unit used for the parameter value should be consistent with other units used in the model. The time dimension of the value is always days. 
\end{itemize}
\textit{Reactions: }\\
In order to enter reaction rate expressions and stoichiometric constants right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction Parameters} and click on \textbf{Open Reaction Network Window} from the drop down menu. A window as shown in Figure \ref{fig:20}. The headings of this table consists of a process name, a process rate and columns each representing the stoichiometric constants for each of the constituents defined in the model. Additional processes (reactions) can be added using the \textbf{Add Processes} at the bottom of the window and existing processes can be removed using the \textbf{Remove Process} bottom. \textbf{Process Name} is were the user-assigned name of the process is entered. In the process rate column the user can enter the rate expression of the process. The rate expression can include concentrations of constituents, reaction parameters and also physical parameters such as light, temperature or even velocity. The values entered under the columns identified by name of constituents indicate how much of a constituent is produced or consumed as a result of a unit progress in the reaction. A negative stoichiometric constant is indicative of consumption of the constituent as a result of the reaction while a positive value results in production of the constituent. The following example shows how to set up a simple reaction in GIFMod. 
\begin{figure}[!ht]\label{fig:20}
\begin{center}
\includegraphics[width=8cm]{Images/Figure20.png} \\
\caption{Reaction window} 
\end{center}
\end{figure}

\input{ASM_ex.tex}In this section it is explained how to impose an external flux or atmospheric exchange of one or a few constituents into the model. This feature can be used to for example incorporate the flux of dissolved oxygen as a result of aeration in a water quality model or to model the influx of contaminant, organic matter and nutrients separate from the inflows. Several influx models are provided in GIFMod as described below: 
\begin{itemize}
\item \textbf{Constant influx model: } In this model the flux is assumed to be constant: 
\begin{equation}
\label{eq:28}
J_{ext} = k_{ext}
\end{equation}
So the external influx of a constituent will be calculated as: 
\begin{equation}
\label{eq:29}
\dot{m} = A_s k_{ext}
\end{equation}

\item \textbf{Constant rate model: } In this model the flux is assumed to be proportional to the difference between the concentration of a constituent and a saturation concentration $C_s$: 
\begin{equation}
\label{eq:30}
J_{ext} = k_{ext}(C_s-C)
\end{equation}
Which is applied volumetrically. So the external influx of a constituent will be calculated as: 
 \begin{equation}
\label{eq:30a}
\dot{m} = k_{ext}(C_s-C) \sout{V}
\end{equation}

\item \textbf{Free surface model: } The free surface model is used for open-channel reaeration where the flow depth and velocity affect the rate of aeration. The for of the flux equation is consistent with the forms suggested by \citep{oconnor1956,churchill1964,owens1964some,isaacs1968,langbein1967}:
\begin{equation}
\label{eq:31}
J_{ext} = k_{ext}v^{\alpha_{ext}}H^{\beta_{ext}}(C_s-C)
\end{equation}


\item \textbf{Soil model: } Aeration in soils is expected to be limited by the area of air-water interface. In this model it is assumed that the area of the air-water interface is proportional to the moisture content and air content of the soil. The external flux equation for soils is therefore considered as: 

\begin{equation}
\label{eq:32}
J_{ext} = k_{ext}\theta (\theta_s-\theta) (C_s-C)
\end{equation}
Which is applied volumetrically. So the external influx of a constituent will be calculated as: 
 \begin{equation}
\label{eq:33}
\dot{m} = k_{ext}\theta (\theta_s-\theta) (C_s-C) \sout{V}
\end{equation}
\end{itemize}
\subsubsection{External Flux Properties: }
An external flux model must be added by right-clicking \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{External Fluxes} and clicking on \textbf{Add External Flux} and then be assigned to individual blocks through the \textbf{External Flux} property of the block. 

Below properties that can be assigned to a \textbf{External flux} model are described: 

\begin{itemize}
\item \textbf{Name: } This is the name of the external flux model. The name is used to assign the model to individual blocks. 
\item \textbf{Coefficient: } Here the value of $k_{ext}$ in Eqs. (\ref{eq:28}, \ref{eq:30}, \ref{eq:31}, \ref{eq:32}) can be entered. This is needed for all external flux models. 
\item \textbf{Constituent: } This indicate the constituent that will be released as a result of the external flux. 
\item \textbf{Depth exponent: } The value of $\beta_{ext}$ in the free surface model. 
\item \textbf{Model: } Here the type of the model to be used for the external flux will be selected. 
\item \textbf{Saturation: } The value of saturation concentration $C_s$ used in the \textbf{constant rate}, \textbf{free surface}, \textbf{soil} will be entered here. 
\textbf{Solid: } Indicates the solid phase (soil or particles) that the external flux will be assigned to. If left empty the influx occur as dissolved. 
\item \textbf{Transfer Rate Expression: } This property allows the user to type in an expression to be used for the calculation of the external flux rates. 
\item \textbf{Velocity Exponent: } The value of $\alpha_{ext}$ in free surface model (Eq. \ref{eq:31}). 
\end{itemize}

\input{Aeration_ex.tex}
\documentclass[letter,11pt]{report}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{array}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Source: http://en.wikibooks.org/wiki/LaTeX/Hyperlinks %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage[english]{babel}
\usepackage{natbib}
\usepackage[normalem]{ulem}
\usepackage{longtable}
\bibliographystyle{apalike}
\usepackage{draftwatermark}
\SetWatermarkText{Working copy}
\SetWatermarkScale{1}
\renewcommand{\vec}[1]{\mathbf{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 'dedication' environment: To add a dedication paragraph at the start of book %
% Source: http://www.tug.org/pipermail/texhax/2010-June/015184.html            %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newenvironment{dedication}
{
   \cleardoublepage
   \thispagestyle{empty}
   \vspace*{\stretch{1}}
   \hfill\begin{minipage}[t]{0.66\textwidth}
   \raggedright
}
{
   \end{minipage}
   \vspace*{\stretch{3}}
   \clearpage
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Chapter quote at the start of chapter        %
% Source: http://tex.stackexchange.com/a/53380 %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\renewcommand{\@chapapp}{}% Not necessary...
\newenvironment{chapquote}[2][2em]
  {\setlength{\@tempdima}{#1}%
   \def\chapquote@author{#2}%
   \parshape 1 \@tempdima \dimexpr\textwidth-2\@tempdima\relax%
   \itshape}
  {\par\normalfont\hfill--\ \chapquote@author\hspace*{\@tempdima}\par\bigskip}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% First page of book which contains 'stuff' like: %
%  - Book title, subtitle                         %
%  - Book author name                             %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Book's title and subtitle
\title{\Huge \textbf{User's Manual for Green Infrastructure Flexible Model (GIFMod)}}
% Author

\author{
Arash Massoudieh\\
  \texttt{first1.last1@xxxxx.com}
  \and
  Sassan Aflaki\\
  \texttt{first2.last2@xxxxx.com}
  \and
   Srinivas Panguluri\\
  \texttt{first2.last2@xxxxx.com}
  \and
  Project Director: Christopher Nietch 
}




\begin{document}






\maketitle




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Auto-generated table of contents, list of figures and list of tables %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents
\listoffigures
\listoftables


%%%%%%%%%%%
% Preface %
%%%%%%%%%%%
\chapter*{Preface}

we will add short description about each chapter in this book.


\section*{About the companion websites}

\begin{itemize}
  \item GIFMod along with the examples presented in this manual can be downloaded at www.GIFMod.com.
  \item The source code of the program is available at https://github.com/USEPA/GIFMod.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Give credit where credit is due. %
% Say thanks!                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Acknowledgements}
\begin{itemize}
\item acknowledgments
\end{itemize}
\mbox{}\\
%\mbox{}\\
\noindent Acknowledgments go here \\



\newpage

\begin{abstract}
    
    GIFMod is an environment for building mechanistic models of hydraulics and water quality processes in various types of stormwater green infrastructure (GIs). This manual aims at 1- providing a detailed description about the features of the program 2- provide a description about different components available to construct a model and their properties 3- the underlying governing equations 4- to provide several tutorial examples that help learning how to construct a model. 
\end{abstract}

\section{About this Manual}
The instructions presented in this manual do not cover all details or variations of GIFMod's potential use. The information contained in this manual is subject to change periodically without notice. Any trademarks mentioned or contained in this document belong to their respective owners. The manual is organized as follows: \textbf{Chapter 1} provides an introduction about different capabilities of GIFMod, \textbf{Chapter 2} walks the reader through building a simple pond model, running the model and inspecting the results. this chapter aims at making the user familiar with the modeling environment. \textbf{Chapter 3} provides a detailed description of model setting and the properties that can be assigned to major components a GI model will be represented by namely \textbf{Blocks} and \textbf{Connectors}. \textbf{Chapter 4} covers how the water quality aspect of a model is set up in GIFMod. Water quality modeling in GIFMod is comprised of particle fate and transport and constituent reactive transport. \textbf{Chapter 5} describes the inverse modeling feature of GIFMod and \textbf{Chapter 6} is a tutorial that walks the user through constructing a model of a bio-retention system. 
\\
\\
\\
\textbf{Disclaimer: } GIFMod is an environment that allows users to construct models of green infrastructure systems. It gives the modeler significant amount of freedom in how to conceptualize and formulate the problem, and which processes to be included or not into the model. The fidelity of a model built using GIFMod depends on how realistic the conceptualization of the system is. 

\chapter{Introduction}
\input{Introduction.tex}




\chapter{A simple pond model}
\input{Simple_pond_model.tex}

\chapter{Model Components}
\input{Model_components.tex}

\chapter{Water Quality Modeling}
\input{Water_Quality_modeling.tex}
\chapter{Inverse Modeling}
\input{Inverse_modeling.tex}



\chapter{Example I: A simple bioretention model}
Step-by-step instructions for building a bioretention model will be presented here. 


\chapter*{Appendixes: }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Sample table                                        %
% Source: www1.maths.leeds.ac.uk/latex/TableHelp1.pdf %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{Notations.tex}
\bibliography{GIFMod}


\end{document}
Download GIFMod for Windows(TM) from
http:\\http://gifmod.com/ or https://github.com/USEPA/GIFMod/tree/master/Setup \\
The setup file in the github repository is identified by the date of release. Download the latest version. 
After downloading, when you launch the .msi Installer File, the following screen will appear: 

\begin{figure}[!ht]\label{fig:ins1}
\begin{center}
\includegraphics[width=7cm]{Images/Install_Figure1.png} \\
\caption{Security warning} 
\end{center}
\end{figure}

Click on “Run” to begin installation of the GIFMod Software. Please follow the onscreen instructions of the Setup program.


\begin{figure}[!ht]\label{fig:ins2}
\begin{center}
\includegraphics[width=7cm]{Images/Install_Figure2.png} \\
\caption{Welcome dialog} 
\end{center}
\end{figure}

When the above window appears… Click on “Next.” 

\begin{figure}[!ht]\label{fig:ins3}
\begin{center}
\includegraphics[width=7cm]{Images/Install_Figure3.png} \\
\caption{Installation} 
\end{center}
\end{figure}

Click on “Install” to begin installation of the GIFMod Software. A progress bar will appear while the software is loaded to your computer.

\begin{figure}[!ht]\label{fig:ins4}
\begin{center}
\includegraphics[width=7cm]{Images/Install_Figure4.png} \\
\caption{Installation} 
\end{center}
\end{figure}

Once installation of the GIFMod software has completed, click on the “Finish” button. Check the box to launch the program or launch it separately. When the program is launched the following screen appears:

\begin{figure}[!ht]\label{fig:ins5}
\begin{center}
\includegraphics[width=7cm]{Images/Install_Figure5.png} \\
\caption{GIFMod's main window} 
\end{center}
\end{figure}



GIFMod is a computer program that can be used to construct model for evaluation of the performance of stormwater green infrastructure (GIs) and other types of urban and agricultural best management practices (BMPs). The program is designed to provide a good level of flexibility to the users to set up the model configuration and to select the processes governing the hydraulics and water quality. Therefore, GIFMod can be applied to evaluate a wide variety of GI related water quality problems. A model build using GIFMod should be conceptualized as a interconnected set of different types of media ranging from surface water to vadose zone and groundwater. 

Modeling of GI performance in GIFMod can be done in three levels including hydraulics, particle transport and constituent fate and transport. A GI model can be constructed by a combination of blocks representing surface water ponds, streams, overland flow, unsaturated soil, saturated media and storage that are connected either through natural interfaces, pipes or other user-defined connectors. 

\section{Hydraulic Modeling Capabilities}
The hydraulic module solves water balance equations for the blocks comprising the model by using constitutive theories expressing the head-storage relationship for each type of block and hydraulic head-flow relationships for flow rates between connected blocks. Briefly, van Genutchten-Maulem \citep{Mualem1976,VanGenuchten1980} equation is used for unsaturated flow, Darcy equation is used for saturated porous media ans storage, and diffusive wave (DW) equation is used for all surface water components including streams, ponds and overland flow. Several options are provided for modeling evaporation and evapotranspiration including the Penman model \citep{allen1998} the Priestly-Taylor model \citep{Priestley1972} and the aerodynamic model \citep{mays2010}. In addition the use can introduce new equations for calculation of evaporation as a function of moisture content of blocks, light intensity, temperature, wind and humidity. The user is also able to introduce evaporation time-series to be imposed to blocks using external input files.  

\section{Particle Transport Modeling Capabilities}
The GIFMod particle transport modeling capability includes the ability to model multiple classes of particles with different transport properties. The particles are assumed to be affected by gravity settling and attachment to soil matrix and release from the soil matrix. Several alternative models are provided for particle transport in porous media that can be attributed to each particle type. Depending on the particle transport model used, the particles are assumed to be able to be present in several phases including mobile phase, reversibly attached phase, irreversibly attached phase and attached to air-water interface. Blocking can be modeled in attachment of mobile particles using a Langmuirian blocking function. The exchange rate of particles between phases can be indicated to be a function of flow velocity. 

\section{Coupled Dissolved and Particle-associated Reactive Transport Modeling Capability}
The following processes can be modeled in the multi-component constituent fate and transport module: 1) advective-dispersive of constituents both as dissolved species or as bound to mobile particles, 2) mass transfer between the aqueous phase and all solid phases including the soil matrix and all other mobile and immobile particulate phases. 3) user-define biogeochemical transformation processes. Introduction of biogeochemical process is done by first defining bio-kinetics and stoichiometric parameters and then filling in a Peterson matrix \citep{Russell2006} specifying the rates and stoichiometries of each process. Bio-kinetic and stoichiometric parameters can be specified to be a function of temperature through Arrhenius equation. Also physical parameters such as moisture content, light intensity and such can also be used as part of the process rate expressions and stoichiometric expressions. 

Constituents can be assigned to have settling velocities. This is particularly useful when modeling algal circulation, bacteria, particulate organic matter, or other particulate species that can can undergo settling or floatation. 

\section{Inverse Modeling and Parameter Estimation Capability}
GIFMod is equipped with both deterministic (using Genetic Algorithm) and probabilistic (using Markov Chain Monte-Carlo) parameter estimation capability. Any of the parameters used in a model can be treated as unknown  and multiple sets of observed data can be introduced to represent hydraulic and water quality outputs of the model. 

\section{Installing GIFMod}
\input{Installation.tex}

Typically, the following steps are performed when using the GIFMod to evaluate GI performance:

\begin{itemize}
    \item Create a project in solution explorer and set (or accept the default values) the basic project options (e.g., project setting, climate setting, and solver setting) for analysis .... (see Chapter 3)
    \item Draw a visual representation of the GI to be evaluated using blocks that represent spatial components of the GI (e.g., pond, stream, etc.) and connectors that represent interfaces between the spatial components. (see Chapter 3)
    \item Edit the properties of the blocks and connectors that make up the evaluated GI system (see Chapter 3)
    \item Add any available time series hydraulic and water quality data.
    \item Set up the water quality component of the model (see Chapter 4) if the model has a water quality aspect.
    \item If the model is intended to be used for parameter estimation set up the define parameters and observed data (see Chapter 5). 
    \item Run the model if forward (or inverse if parameter estimation is intended to be performed). 
    \item View the results of the analysis.
 
\end{itemize}
    



\section{Some theoretical background: } 

GIFMOD is equipped with two inverse modeling modules including a maximum-likelihood (deterministic) parameter estimation and a Bayesian probabilistic parameter estimation. The deterministic parameter estimation approach uses a Hybrid Genetic Algorithm to find combination of model parameters maximizing the likelihood of observing the measured data which the Bayesian approach uses Markov Chain Monte Carlo (MCMC) algorithm to produce samples of parameters representing the joint posterior distribution of model parameters designated to be estimated by the program. 

GIFMOD allows for any of the parameters in the model to be treated as unknown parameters and be estimated by providing their prior distributions while allowing the user to choose between three types of prior distributions: including normal, log-normal, and uniform. 
The observed data can be specified to represent any of the state variables in the model including hydraulic (i.e.  flow rates, head, cross- sectional areas), as well as particle and constituent concentrations at each block. As is typically done in Bayesian inference, the error here is defined as a quantity encompassing measurement error, model structural error, and all other errors resulting from the uncertainties associated with the external forcing (input data) such as weather data, inflow rates, and concentrations, etc. The general form of the model error structure can be expressed using the following equation: 

\begin{equation}
\label{eq:im1}
\tilde Y(t) = \xi^{-1}[\xi[Y(t)]+\epsilon]
\end{equation}
where $Y$ is the vector containing the model’s observed constituents, $\tilde Y(t)$ represents the observed data vector, $\xi$ represents the error structure function (e.g., for log-normal error structure, $\xi$ is the natural logarithm function, while for Gaussian error structure, $\xi$ is the identity function), and $\epsilon$ is a random vector containing transformed measurement, structural and external forcing errors, which is assumed to collectively follow a multivariate normal distribution. 
The Bayes’ theorem \citep{kaipio2006} can be used to obtain the joint probability distribution of parameters given the observed data, namely, the posterior distribution of the parameters as:
\begin{equation}
\label{eq:im2}
p(\vec{\Psi}|\vec{\tilde Y})=\frac{p(\vec{\tilde Y}|\vec{\Psi}) p(\vec{\Psi})}{p(\vec{\tilde Y})}
\end{equation}

where $p(\vec{\tilde Y}|\Psi)$ is the likelihood function that is the probability of observing the measured data $\vec{\tilde Y}$ given a parameter set $\vec{\Psi}$, $p(\vec{\Psi})$ represents the prior knowledge about the parameters and error structure, and $p(\vec{\tilde Y})$ is a normalizing factor. $\vec{\Psi}$ in Eq. (\ref{eq:im2}) contains all the parameters that are intended to be estimated using the observed data and the elements of the variance-covariance matrix for the random error term $\epsilon$ in eq. (\ref{eq:im1}). The likelihood of observing $\vec{\tilde Y}(t)$ given a parameter set $\vec{\Psi}$ or simply the likelihood function $p(\vec{\tilde Y}|\Psi) = p(\vec{\tilde Y}|\vec{Y},\vec{\Gamma})$ can be theoretically calculated based on the error structure. If the errors due to the uncertainties associated with the external forcing are considered part of the observation error, then the external forcing can be considered deterministically, and thus the model outputs become a function of only model parameters. In this case, the error function can be re-written as $p(\vec{\tilde Y}|\vec{\Phi},\vec{\Gamma})$. In theory, each element of the variance-covariance matrix $\vec{\Gamma}$ should be estimated as part of the parameter estimation. However, this makes the total number of parameters to be estimated very large and imposes a large computational burden. Therefore, observation errors of different constituents are typically assumed to be independent, and the correlations between observed concentration errors of different constituents are ignored \citep{walsh2012}. By making this assumption, the variance-covariance matrix becomes diagonal. If it is also assumed that errors of consecutive observations of individual data-sets used in parameter estimation are independent of each other, then the likelihood function of the observed vector can be computed as a function of the model parameters:
\begin{equation}
\label{eq:im3}
p(\vec{\tilde Y}|\vec{\Psi})=\frac{\prod_{i=1}^{NT} \prod_{j=1}^{NS_i} \xi'(\tilde y_{ij})}{(2 \pi \prod_{i=1}^{NT} \sigma_i^2)^{NS_i/2}}exp\bigg[-\sum_{i=1}^{NT} \sum_{j=1}^{NS_i} \frac{(y_{ij}-\tilde y_{ij})^2}{2 \sigma_i^2}\bigg]
\end{equation}

where $\tilde y_{ij}\in \vec{\tilde Y}$ is the $j^{th}$ data point of observed concentration of observed state variable $i$, $NT$ is the total number of different measured state variables, $j$ indicates the time and location of the measurement. $NS_i$ is the number of total samples (in time or location) of observed state variable $i$. The mapping function $\xi$ in the likelihood function can be assumed to be any transformation depending on the distribution of the observed data or by performing trial and error to find the best transformation by comparing the posterior residuals with the presumed error structure, and $\xi'$ is its derivative. For example, considering $\xi$ to be the identity function implies a normally distributed and additive error structure, while assuming $\xi$ to be the logarithm function results in a log-normally distributed and multiplicative error structure. Other error structures can be obtained by selecting a corresponding mapping function. $y_{ij}\in \vec{Y}$  is the predicted concentration of constituent $i$ at time/location $j$. $\sigma_i$ is the standard deviation of observed constituent $i$. When the deterministic parameter estimation approach based on maximum likelihood approach is to be applied to estimate the parameters, the values of parameters that maximize Eq. \ref{eq:im3} \citep{montgomery2010} are found  using a hybrid genetic algorithm. 
The second term in the numerator of Eq. \ref{eq:im2} represents the prior knowledge about the probability density of the parameters. This information can be obtained from literature reviews, experts’ experience, or independently performed experimental results.
In the probabilistic parameter estimation module, the MCMC algorithm \citep{gamerman2006} is used to generate random samples according to the posterior distribution in Eq. \ref{eq:im2}. The MCMC algorithm implemented in the program is based on the Metropolis-Hasting method \citep{metropolis1953}. MCMC algorithm that is implemented into GIFMOD automatically adjusts the perturbation factors to achieve an acceptance rate provided by the user. In the next section the way to set up an inverse problem in GIFMOD and the parameters adjusted by the user in order to do so are described.  
\section{Defining parameters and observed data}
In order to perform an inverse modeling, parameters and observed data should first be introduced. Parameters should be assigned to the specific properties of the model and each set of observed data should be attributed to a specific output of the model. 
\subsection{Defining parameters and adjusting their properties: }
In order to add a parameter to the model right click on \textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and then click on \textbf{Add parameters}. Each parameter has the following properties: 

\begin{itemize}
    \item \textbf{Name: } This indicates the name that is assigned to a parameter. The name of the parameter will be used to assign the parameter to specific properties of the model and when generating the results of inverse modeling.
    \item \textbf{Value: } This is the value that will be assigned to the parameter if the modeling is conducted in forward mode. 
    \item \textbf{Maximum Value: } In deterministic inverse modeling, this indicates the upper bound for the parameter (search domain). In probabilistic inverse modeling, it indicates the 97.5 percentile of the prior distribution for this parameter. 
    \item \textbf{Minimum Value: } In deterministic inverse modeling, this indicates the lower bound for the parameter (search domain). In probabilistic inverse modeling, it indicates the 2.5 percentile of the prior distribution for this parameter.
    \item \textbf{Prior distribution: } Indicates the mathematical form of the prior distribution of the parameters. The choices provided include \textbf{Normal}, and \textbf{Lognormal}. The mean and standard deviation of the prior distributions are calculated based on the maximum and minimum values. 
\end{itemize}

\subsection{Defining observed data and assigning their properties: }
Observed data can be added by right-clicking on \textbf{Inverse Modeling}$\rightarrow$\textbf{Observations} and then clicking on \textbf{Add observation}. Each observation includes a time-series representing an state variable of the model. Each observation has the following properties: 

\begin{itemize}
    \item \textbf{Name: } The name of an observation is used when generating results in deterministic and probabilistic inverse modeling. 
    \item \textbf{Standard Deviation ID: } This is an identification that is used to group observations that will be assigned the same standard deviation. The total number of groups of observations is equivalent to the parameter $NT$ in Eq. \ref{eq:im3}. The observations having the same \textbf{Standard Deviation ID} will be grouped together and a single observation error standard deviation, $\sigma_i$ will be assigned to them. 
    \item \textbf{Block/connector: } This indicates whether the state variable to the observation correspond to is a block or a connector state variable. Concentrations, storages, hydraulic heads are always block state variables, while flow rates and interface areas are connector state variables. 
    \item \textbf{Error distribution: } This indicates the error structure ($\xi$) in Eq. \ref{eq:im1} that is used when computing the likelihood value.
    \item \textbf{Location: } Indicate the block or the connector that this observed data corresponds to. 
    \item \textbf{Observed data: } This field allows loading the observed data time-series. The observed data time series is a .csv text file that should consist of two columns first representing times of measurement and the second the observed values. 
    \item \textbf{Quantity: } This field allows selecting the state variable that the observed data corresponds to. As for water quality and particles the drop-down menu containing the selectable state variables is populated depending on the constituents, phases, and particle types available. 
    
\end{itemize}
\subsection{Example: Estimation of bio-kinetic parameters of nitrification processes from an batch test: }
This case represent interpretation of an actual experiment to determine the rates of microbial activities during ammonia and nitrite oxidation. Four experiments were conducted using the same sludge sample. The variation of dissolved oxygen with respect to time was measured for each of the four experiments. The initial conditions for each of the experiments is shown in Table \ref{table:inverse_example} and the observed variation of DO for the four cases are shown in Figure \ref{fig:inverse_example1}. 

\begin{table}[]
    \centering
    \begin{tabular}{c|c c c c}
       Experiment  & $NO_3^{-1}(mg/L) $ & $NH_3(mg/L)$ & $DO(mg/L)$ & $VSS(mg/L)$ \\
    \hline
        No Spike & 0 & 0 & UK* &  730  \\
        $NO_2^{-1}$ Spike & 50 & 0 & UK & 695 \\
        $NH_3$ Spike & 0 & 50 & UK & 645 \\
        $NO_2^{-1}$ and $NH_3$ & 50 & 50 & UK & 660\\ 
    \end{tabular}
    \caption{Initial condition for the declining DO test aimed at estimating AOB and NOB biokinetics. *- UK: The initial condition for DO is treated as a parameter to be estimated by the model}
    \label{table:inverse_example}
\end{table}

The processes considered in the model are shown in table \ref{table:inverse_example2}. The only constituents that will be explicitly considered in the model include $DO$, $NH_3$, $NO_2^{-1}$, and $VSS$. $VSS$ is used as a surrogate for biomass (i.e. it is assumed to be proportional to AOB, NOB and OHO) and it is also assumed to stay unchanged throughout each experiment. the Petersen matrix is shown in table \ref{table:inverse_example3}.

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure35.png} \\
\caption{Temporal variation of DO for the four different experiments used to estimate nitrification bio-kinetics parameters}\label{fig:inverse_example1}
\end{center}
\end{figure}

\begin{table}[]
    \centering
    \begin{tabular}{l l}
       Process & Reaction Expression \\
    \hline
        Ammonia oxidation (AO) & $21.9O_2 + \frac{21.9}{3.43}NH_3 \rightarrow \frac{21.9}{3.43}NO_2^{-1}$  \\
        Nitrite oxidation (NO) & $11.7O_2 + \frac{11.7}{1.14}NO_2^{-1} \rightarrow \frac{11.7}{1.14}NO_3^{-1}$ \\
        Ordinary heterotrophic growth (OHO) & $BOD + O_2 \rightarrow CO_2$ \\
    \end{tabular}
    \caption{Reactions considered in the nitrification bio-kinetics parameter estimation example}
    \label{table:inverse_example2}
\end{table}


\begin{table}[]
    \centering
    \begin{tabular}{l|c |c c c c}
       Process & Rate Expression & $O_2$ & $NH_3$ & $NO_2^{-1}$ & VSS  \\
    \hline
        AO & $VSS \mu_{AOB} \frac{[O_2]}{(k_{OA} + [O_2]}\frac{[NH_3]}{[NH_3]+k_{NH3}}$ & -21.9 & $-\frac{21.9}{3.43}$ & $\frac{21.9}{3.43}$ &   \\
        NO & $VSS \mu_{NOB} \frac{[O_2]}{k_{ON} + [O_2]}\frac{[NO_2^{-1}]}{[NO_2^{-1}]+k_{NO2}}$ & $-11.7$ &  & $-\frac{11.7}{1.14}$ &   \\
        OHO & $VSS \mu_{OHO} \frac{[O_2]}{k_{OH}+[O_2]}$ & $-\frac{1-0.52}{0.52}$ & & &  \\
    \end{tabular}
    \caption{Petersen matrix for the nitrification bio-kinetics parameter estimation example}
    \label{table:inverse_example3}
\end{table}

\begin{table}[]
    \centering
    \begin{tabular}{l|c c c}
       Parameter & 2.5\% & 97.5\% & Distribution  \\
    \hline
        $\mu_{AOB}$ & 0.005 & 0.5 & lognormal \\
        $k_{OA}$ & 0.05 & 2.0 & lognormal \\
        $\mu_{NOB}$ & 0.005 & 0.5 & lognormal \\
        $k_{ON}$ & 0.05 & 2.0 & lognormal \\
        $k_{NH3}$ & & FIXED = 0.5 & \\
        $k_{NO2}$ & & FIXED = 0.5 & \\
        $\mu_{OHO}$ & 0.0001 & 0.1 & lognormal \\
        $k_{OH}$ & 0.00125 & 10 & lognormal \\
    \end{tabular}
    \caption{Prior range of parameters used in nitrification bio-kinetics example}
    \label{table:inverse_example4}
\end{table}

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=12cm]{Images/Figure36.png} \\
\caption{Reaction network for the nitrification parameter estimation example}\label{fig:inverse_example2}
\end{center}
\end{figure}    


Table \ref{table:inverse_example4} shows the prior 95\% ranges and the prior distributions of each of the parameters. In this particular case due to lack of information about $NH_3$ and $NO_2^{-1}$ concentration variation with time if $k_{NH3}$, and $k_{NO2}$ are considered unknown, there is a risk of problem becoming over-parametrized and therefore, we here assume the values of these two parameters to be fixed.   

\subsubsection{Steps to set-up the model: }
To construct the model in GIFMod follow the following steps: 
\begin{itemize}
    \item \textbf{Add a pond: } We will simulate the reactor using a \textbf{Pond} block. Other media types can also be used. Add a pond by clicking on the pond icon \includegraphics[width=0.5cm]{Icons/pond_icon.png} on the top tool bar. Set the following properties for the pond: \\
    - \textbf{Area: } 1$m^2$\\
    - \textbf{Initial water depth: } 1m\\
    \item \textbf{Add the constituents: } Add constituents ($DO$, $NH_3$, $NO_2^{-1}$, $VSS$) by right-clicking on \textbf{Water quality}$\rightarrow$\textbf{Constituents}. \item \textbf{Adding experiments: } The goal of this example is to infer the values of reaction parameters using four experiments in a holistic way. This means that the best parameter set that can collectively explain the results from the four experiments in sought for. There are two ways to consider four experiments in the model. The first way is to define four independent ponds with different initial conditions and the second way is to use \textbf{Experiments}. Here we will use the second approach. \\ To add experiments click on the \textbf{Add new experiment} button \includegraphics[width=0.3cm]{Icons/newexperiment_icon.png} three times to add three new experiments. 
    
    \item \textbf{Setting the duration of the simulation: } The duration of the experiments are all below 0.2 days. First from the experiment menu on the top tool bar select \textbf{All experiments}. This forces the program to apply any changes in the properties to all the experiments. To set the simulation duration to 0.2 from \textbf{Settings}$\rightarrow$\textbf{Project settings} and from the \textbf{Properties} window right-click on the label for \textbf{Simulation end time} and click on \textbf{Enter number} from the drop-down menu that appears. Enter 0.2 in the dialog box that appears. 
    
    \item \textbf{Adding reaction parameters: } Add the eight reaction parameters by right-clicking on \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction parameters} according to table \ref{table:inverse_example4}. For the two fixed parameters $k_{NH3}$ and $k_{NO2}$, enter a value of 0.5. 
    \textbf{Add reaction network: } Right click on reaction  \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction network}. Enter the processes according to the Petersen matrix shown in table \ref{table:inverse_example3}. The finished reaction network window should look like figure \ref{fig:inverse_example2}.\\
    \item \textbf{Setting initial conditions: } From the \textbf{Experiments} drop-down menu on the top tool bar, select \textbf{Experiment1}. Click on the pond block and then from the \textbf{Properties} window choose \textbf{Constituent initial conditions}. Enter the initial conditions for experiment 1 according to Table \ref{tab:inv_ini_cond}.
   \begin{table}[]
    \centering
    \begin{tabular}{l|c c c c}
       Experiment & $DO(mg/L)$ & $NH_3(mg/L)$ & $NO_2^{-1}(mg/L)$ & VSS (mg/L) \\
    \hline
        1 & 7.78 & 0 & 0 & 730 \\
        2 & 7.76 & 50 & 0 & 645 \\
        3 & 8.02 & 0 & 50 & 695 \\
        4 & 7.8 & 50 & 50 & 660 \\
    \end{tabular}
    \caption{Initial conditions for the four experiments used for estimation of bio-kinetics and stoichiometric parameters of nitrification}
    \label{tab:inv_ini_cond}
\end{table} 
    
    The initial condition window for the first experiment should look like Figure \ref{fig:42}. 
    
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure42.png} \\
\caption{Initial conditions for the nitrification inverse modeling example}\label{fig:42}
\end{center}
\end{figure}  

Change the experiment to experiment2 from the \textbf{experiments} drop down menu and similarly set the initial condition according to the second row of table \ref{tab:inv_ini_cond}. 

Similarly assign the initial conditions for experiment 3 and 4. 
    
    \item \textbf{Setting up parameters to be estimated: } Add a parameter representing $\mu_{AOB}$ by right-clicking of \textbf{Inverse modeling}$\rightarrow$\textbf{Parameters} and clicking on \textbf{Add parameters} from the drop-down menu. Assign the following parameter to the newly added parameter:\\
    - \textbf{Name:} $\mu_{AOB}$\\
    - \textbf{Maximum value: } \textit{0.5}\\
    - \textbf{Minimum value: } \textit{0.005}\\
    - \textbf{Distribution: } \textit{Log-Normal}\\
    Repeat for the other parameters to be estimated including $k_{OA}$, $\mu_{NOB}$, $k_{ON}$, $\mu_{OHO}$,
and $k_{OH}$ and assign the ranges and the distribution according to table \ref{table:inverse_example4}. As for the \textbf{Value} of the parameters respectively use $\mu_{AOB}=0.05$, $k_{OA}=0.31$, $\mu_{NOB}=0.05$, $k_{ON}=0.31$, $\mu_{OHO}=0.003162$, $k_{OH}=0.111$. These values are used when the model is run in forward mode. \\Please note that the name of the parameters should not be identical to their corresponding reaction parameters. \\


\item \textbf{Assigning the parameters to the corresponding model properties: } The parameters defined in the previous step should not be assigned to their corresponding properties in the model. Choose the reaction parameter $\mu_{AOB}$ from \textbf{Water quality}$\rightarrow$\textbf{Reactions}$\rightarrow$\textbf{Reaction parameters}, and the right click on the label of \textbf{Value} property and from the drop-down menu select \textbf{Parameters}$\rightarrow$\textbf{$\mu_{AOB}$} figure \ref{fig:inverse_example3}.

\item \textbf{Setting observations: } Here we specify the properties of the observed data used to perform the parameter estimation. \\ Right-click on \textbf{Project explorer}$\rightarrow$\textbf{Inverse modeling}$\rightarrow$\textbf{Observations} and click on \textbf{Add Observation}.\\ 
Set the following properties for the first observation: \\
\underline{observation 1:} \\
- \textbf{Name: } \textit{DO\_no\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment1} \\
- \textbf{Observed data: }  \textit{Obs\_nospike.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

Add three more observation and set the properties as follows: 

\underline{observation 2:} \\
- \textbf{Name: } \textit{DO\_NH3\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment2} \\
- \textbf{Observed data: }  \textit{Obs\_NH3.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\underline{observation 3:} \\
- \textbf{Name: } \textit{DO\_NO2\_spike}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment3} \\
- \textbf{Observed data: }  \textit{Obs\_NO2.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\underline{observation 4:} \\
- \textbf{Name: } \textit{DO\_both}\\
- \textbf{Standard deviation ID: } \textit{std} \\
- \textbf{Block/Connector: } \textit{Block} \\
- \textbf{Error Distribution: } \textit{Normal} \\
- \textbf{Location: } \textit{Pond (1)} \\
- \textbf{Experiment: } \textit{experiment3} \\
- \textbf{Observed data: }  \textit{Obs\_both.txt} \\
\textbf{Quantity} \textit{DO:Aqueous} \\

\textbf{Note: } Entering the same \textbf{Standard deviation ID} for all the observation forces the program to find a single observation error standard deviation for all the observation. In this case because the measured quantity for all observations is dissolved oxygen it is expected that the measurement error for all observation to have the same statistical distribution. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=6cm]{Images/Figure37.png} \\
\caption{Assigning parameters to model properties}\label{fig:inverse_example3}
\end{center}
\end{figure}    

Repeat for the other parameters to be estimated including $k_{OA}$, $\mu_{NOB}$, $k_{ON}$, $\mu_{OHO}$,
and $k_{OH}$. 

\item \textbf{Running in forward mode: } When the model is run in forward mode, the values of the parameters as specified in the \textbf{Value} field are used and a single simulation is performed. Click on the forward run icon \includegraphics[width=0.3cm]{Icons/run_icon.png} and wait for the simulation to end. Choose an experiment from the \textbf{Experiments} drop-down menu and then right click on the block and choose \textbf{Plot water quality results}$\rightarrow$\textbf{DO}. \\

- Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse modeling}$\rightarrow$ \textbf{Observations}$\rightarrow$ \textit{DO\_NH3\_spike} and then click on \textbf{Plot modeled data}. This shows the corresponding model prediction to observations for experiment 2. You can also check the agreement plot. 

\item \textbf{Change the initial time-step: } The model results that are used to calculate the likelihood are interpolated at time-intervals specified in the \textbf{initial time-step field}. Because the experiments in this example are short (0.1 day), the default initial time-step of 0.01 day is not adequate. From the project exploder choose \textbf{Settings}$\rightarrow$\textbf{Solver Settings} and then from the \textbf{Properties} window find \textbf{Initial time step size} and change the value to 0.001 day. 

\item{Inverse modeling: }\\ - Choose \textbf{number of generations} from \textbf{Inverse modeling}$\rightarrow$\textbf{Genetic Algorithm} and change the value to 100. This makes the number of generations in the Genetic Algorithm to 100. Keep the rest of the parameters unchanged.

 - Choose \textbf{number of realizations} from \textbf{Inverse modeling}$\rightarrow$\textbf{Markov chain Monte Carlo} and change the value to 1000. This makes the number of posterior prediction realizations to 1000. Keep the rest of the parameters unchanged. 

- Click on the inverse modeling icon \includegraphics[width=0.5cm]{Icons/inverse_icon.png} on the left side tool bar. Inverse simulation can take up to one hour depending on the number and speed of the CPUs of the computer being used for the simulation. Wait until the deterministic inverse modeling and the MCMC is finished. The progress bars on the \textbf{Simulation} window shows the percentage of each stage on inverse modeling being completed (Figures \ref{fig:43} and \ref{fig:44}). 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure43.png} \\
\caption{Inverse modeling progress window during deterministic parameter estimation stage}\label{fig:43}
\end{center}
\end{figure}  

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure44.png} \\
\caption{Inverse modeling progress window during probabilistic parameter estimation}\label{fig:44}
\end{center}
\end{figure}  



\item \textbf{Estimated values of the parameters: } To see the estimated values of the parameters select a parameter from \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and look at the \textbf{Value} field. The value should be replaced by the estimated parameter value. 

\item \textbf{Checking the model vs. observed agreement: } Right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Observations}$\rightarrow$\textit{DO\_nospike} and the choose \textbf{Plot modeled data}. A graph will appear that will show observed data and the model prediction based on the estimated parameters. Do the same for other observation data (Figure \ref{fig:48}).

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=10cm]{Images/Figure48.png} \\
\caption{Observed and predicted DO variation in all four experiments}\label{fig:48}
\end{center}
\end{figure}  



\item \textbf{Checking the posterior distributions of the parameters: }\\ - From \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} right-click on $\mu_{NOB}$ and select \textbf{Plot posterior distribution histogram}. A graph will appear that shows the posterior distribution of parameter $\mu_{NOB}$ (Figure \ref{fig:45}). Similarly inspect the posterior distribution for other parameters. (Figure \ref{fig:46}). In this figure the box plot shows the 95\% credible interval for the parameter while the solid line shows the median and the dot shows the expected value of the parameter. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=11cm]{Images/Figure45.png} \\
\caption{Posterior distribution of $k_{OH}$,  $\mu_{OHO}$, $k_{ON}$,  $\mu_{NOB}$}\label{fig:45}
\end{center}
\end{figure}  


\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure46.png} \\
\caption{Posterior credible interval for }\label{fig:46}
\end{center}
\end{figure}  


- To see the 95\% credible intervals for all the parameters right-click on \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} and select \textbf{Plot Percentile data} (Figure \ref{fig:47}). 


-  From \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Parameters} right-click on $\mu_{NOB}$ and select \textbf{Plot percentiles}. 

\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure47.png} \\
\caption{Posterior credible interval for all parameters}\label{fig:47}
\end{center}
\end{figure} 

\end{itemize}
\section{Maximum-likelihood Inverse Modeling Control Parameters}

This section describes the control parameters for the maximum-likelihood (deterministic) inverse modeling feature of GIFMod. The maximum-likelihood control parameters can be accessed through \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Genetic Algorithm}.

\begin{itemize}
    \item \textbf{Name: } The name of Genetic Algorithm object. It can be ignored. 
    \item \textbf{Cross-over probability: } This indicates the probability of \textit{individuals} undergoing a cross-over to generate the \textit{off-springs}. The reminder of the \textit{individuals} selected for mating will be copied to the next generations with only \textit{mutation}. For example if the value of \item \textbf{Cross-over probability} is set to 0.8, 80\% of the selected individuals will undergo cross-over while 20\% will be directly copied to the next generation. 
    \item \textbf{GA output file: } The results of genetic algorithm optimization will be written in this file. The file that will be generated can be used for diagnosis of the GA performance. 
    \item \textbf{Initial GA population: } If a file name is provided here it will be considered as the initial population for the GA analysis. If this field is empty, the initial GA population will be created randomly. 
    \item{Mutation probability: } This indicates the probability of mutation of each bit when copying from one generation to the other.
    \item{Number of generations: } Indicates the number of generation in the GA algorithm to obtain the optimal parameter set.
    \item{Perform local sensitivity analysis: } Indicates whether a local sensitivity analysis should be performed based on the deterministic parameter obtained by the GA algorithm. The results of the local sensitivity analysis will be saved in a text file called "sensitivity\_mat\_lumped.txt" in the working path. 
    \item{Population: } Indicates the population number that will be used for the GA optimization.
    \item{Read GA analysis from file: } This field is used when the GA analysis has been previously done and only the post-processing is intended to be done using the results of the previous inverse modeling. The file name that will be entered is where GIFMod will load the results of the previous GA analysis from.
    \item{Shake scale: } When the maximum fitness in the population is not improved in three sequential generations, an offspring of the fittest individual is produced by adding a random noise to the parameter values. This scale indicate the magnitude of the random noise. The default value is 0.05 which indicate adding a normally distributed noise with a standard deviation equal to 5\% of the value of each parameter. The purpose of this \textit{shaking} is to find possible optimal solution in the neighborhood of the parameter set represented by the fittest individual. 
    \item{Shake scale reduction factor: } If adding the noise does not result in an improved fitness, the shake-scale is gradually reduced (so a closer neighborhood is searched). The shake scale reduction factor is the factor by which this reduction in the shake scale is done. 
    \item{Number of threads: } The number of CPU threads used for the GA and MCMC parameter estimation. 
\end{itemize}

\section{Probabilistic Inverse Modeling Control Parameters}
This section describes the control parameters for the MCMC (stochastic) inverse modeling feature of GIFMod. The MCMC control parameters can be accessed through \textbf{Project Explorer}$\rightarrow$\textbf{Inverse Modeling}$\rightarrow$\textbf{Markov chain Monte Carlo}.

\begin{itemize}
\item \textbf{Create output realization including observation errors} Switching this property to \textit{Yes} results in GIFMod to generate prediction confidence intervals while considering the observation error. 

\item \textbf{Generate output realizations: } Determines whether output realizations based on parameter samples from the posterior distribution should be generated. These realization will be used to determine confidence intervals of model predictions while accounting for parameter uncertainty. 
\item \textbf{Initial perturbation: } Determines whether the initial MCMC parameter sets should be obtained by perturbing the deterministically estimated parameters using GA or by using the non-perturbed values. MCMC used the parameters estimated by the GA as the initial point wither after perturbing the parameters or not. 
 \item{Save realization outputs in a file: } Switching this property to \textit{Yes}, forces the program to create a file where the sampled parameter values from the posterior distribution to generate the posterior realizations are saved. 
 
 In this chapter the main building blocks a GI hydraulic and water quality model are described. The chapter is organized based on the order objects are shown in the "Project Explorer" window. In the first section the items under the "Settings" branch are discussed. These are the settings that determines the general properties of a project including the simulation duration, global time-series data such as precipitation, relative humidity, light, temperature and wind that can affect all of the blocks in a model and also solver setting that are adjusting parameters of the solver engine. In the second section properties of block and connectors as the main building blocks of a model are discussed. In the third section different evapotranspiration models available in GIFMod are explained. In section four, setting up the water quality component are discussed and in section five the inverse modeling capabilities of GIFMod are described. 

\section{Settings}
There are three branches under the "Settings" main branch in Project Explorer including "Project Settings", "Climate Settings", and "Solver Settings". Below the properties under each of these categories are described. 
\subsection{Project Settings}
General required information about a project listed under this group. This includes the start and end times and project description. 

\begin{itemize}
\item %help:100144
\textbf{Simulation Start Time: } This indicates the start date of the simulation. If this number is not entered by the user a default value of zero (equivalent to 1/1/1900) will be assigned to the start time of the project. All time series data such as inflows, precipitation, temperature, ... should be organized in a consistent way with the project start and end time. %help:end
\item %help:100145
\textbf{Simulation End Time: } This indicates the simulation end time. If this number is not entered, the default value of 1 (equivalent to 1/2/1900) will be automatically assigned. 
\item \textbf{Project Description: } This item provides a space to enter a memo as a general description about the project. %help:end
\item %help:100159
\textbf{Working path: } This indicates the folder where the outputs of the simulation are saved in. All outputs of a simulation including hydraulics, particles, and water quality are saved in this folder as well as some information about the simulation performance that may be needed to debug a model setup. %help:end
\item %help:100317
\textbf{Steady-state hydraulics} Switching this option to Yes will result in a quasi steady-state solution of hydraulics. The quasi steady-state solution is based on the assumption of no changes in the storage of blocks and then calculating instantaneous flow rates between the blocks based on this assumption. This option is useful for example when an activated sludge simulation is meant to be performed using GIFMod. %help:end
\end{itemize}
\subsection{Climatic Settings}
This sub-branch allows introducing time-series containing external forcing that can be applied to all (or selected) blocks. These include precipitation, light, humidity, temperature and wind. Light is needed in some of the evapotranspiration models available in GIFMod but also can be included as a limiting factor in transformation processes (reactions) for example when algae growth is meant to be modeled. Humidity and wind also are needed in some of the evapotranspiration models while temperature not only is needed in calculating evaporation it can be specified to affect the value of reaction parameters as it is discussed in section (xx.xx). All of the time-series information in GIFMod must be provided as external text files with .csv format.
\begin{itemize}
\item %help:100132
\textbf{Precipitation: }  The file structure for precipitation data is a comma separated (.csv) text file with three columns. The first and second columns are respectively the start and end times over which the volume of precipitation is given in the third column. The time values should be consistent with the standard time format where the value is the number of days past 1/1/1900. The units of precipitation volume is in (m) units. Figure \ref{fig:8} shows an example precipitation input file. It should be noted that the program converts precipitations to inflow time-series according to the area of the blocks and then interpolate the values at the computational time-steps. So it is important that the dry periods to be included with zero precipitation volume. When the precipitation file is loaded the user can see the time-series graphically by right-clicking on the file-name and clicking on the "Data" item in the drop-down menu. 
\begin{figure}[!ht]\label{fig:8}
\begin{center}
\includegraphics[width=5cm]{Images/Figure8.png} \\
\caption{A sample precipitation file} 
\end{center}
\end{figure} %help:end
\item %help:100177
\textbf{Light: } Light is also provided in .csv text format. The time-series data should be arranged in two columns, when the first column represent time and the second light intensity in $(W/m^2)$ or other units as long as it is consistent with other parts of the model. Figure /ref{fig:9} shows an example light time series data. The name field in the first row is optional. 
\begin{figure}[!ht]\label{fig:9}
\begin{center}
\includegraphics[width=5cm]{Images/Figure9.png} \\
\caption{A sample light intensity time-series file} 
\end{center}
\end{figure} %help:end
\item %help:100178
\textbf{Humidity: } This is where the relative humidity (vapor pressure/saturation vapor pressure) time-series can be provided to the model. The format of the input file is a two column .csv text file similar to light. In most meteorological databases dew point temperature is provided instead of the relative humidity. In that case, the relative humidity can be calculated as:
\begin{equation}
\label{eq:6}
R_h=exp\big[17.62(\frac{T_d}{243.5+T_d}-\frac{T}{243.5+T}) \big]
\end{equation}
where $T$ and $T_d$ are respectively the actual temperature and dew-point temperature in $^oC$. %help:end  
\item %help:100240
\textbf{Temperature: } The format of the temperature time-series is the same as light and relative humidity. The values must be provided in $^oC$. %help:end
\item %help:100241
\textbf{Wind: } Wind time-series is needed in several of the evapotranspiration models such as the Penman model and the aerodynamic model (section xx.xx). The units should be consistent with the coefficients used in the evaporation model. The format of the wind time-series input data file is the same as temperature, humidity, and light. %help:end
\end{itemize}
\subsection{Solver Settings}
Using solver setting the user can adjust the parameters the solver engine uses to solve the governing equations of the model. In most cases the user can leave the default parameters unchanged. The optimal values of these parameters however are problem dependent and there is no unique setting that works for all model configurations. In the following, each parameter is described briefly:
\begin{itemize}
\item \textbf{Allow Negative Concentration: } This option specifies whether the solver allows constituent concentrations to become negative (due mainly to numerical errors) during the simulation. Sometimes small negative values for concentrations can cause problems in reactions while in some models a small negative concentration can be effectively interpreted as a zero concentration and may not affect other constituents. When the option is set to "no" the Newton-Raphson solver rejects any solution that contains a negative concentration and start over with a smaller time-step which may cause slowing down of the computation. 
\item \textbf{Check Positive Definiteness: } This option specifies whether the solver should adjust the time-step size based on the level of positive-definiteness of the Jacobian matrix related to transport of particles and constituents. Maintaining a positive-definite Jacobian by limiting the time-step resulting in smaller oscillation in the solution but can result in a longer computational time.
\item \textbf{Time weighting factor: } This option allows specifying the time weighting factor user in temporal discretization. In other words, it determines the weights given to the weight given to the values of the right hand sides of the balance equations evaluated at the current and the previous time-steps. A value of 0 for the Time Weighting Factor indicates a fully implicit scheme while a value of 1 indicates a fully explicit scheme. The default value is 0.5 which results in Crank-Nichoson time weighting scheme. 
\item \textbf{Failure Criteria number of iterations: } This option indicates the maximum number of Newton-Raphson iterations to be considered a faiure in convergence. When this number of iterations is reached, the solver terminates the iterations, and start over with a smaller time-step and a newly calculated inverse Jacobian matrix. \item \textbf{Initial time step size: }  This value serves two purposes. First it is the time-step that is used initially by the solver engine. It may grow or shrink later depending on the success of the Newton-Raphson algorithm to converge and the number of iterations needed for convergence. The model outputs are also saved based on this time step size if the option "Uniform output interval" is set to yes. 
\item \textbf{Jacobian update interval: }  This indicate the number of time-steps that the Jacobian matrix is recalculated regardless of the convergence success of the Newton-Raphson method. 
\item \textbf{Newton-Raphson acceptance tolerance: }  The Newton-Raphson is considered converged when the 2-norm of the residual vector is below this tolerance level. A smaller value results in a more accurate result but a longer simulation time. 
\item \textbf{Perform mass-balance check: }  Setting this option to Yes results in a file being created in the folder specified in the "Working Path" showing the mass balance errors during the simulation period. 
\item \textbf{Perform particle transport simulation: } This specifies whether a particle transport simulation to be performed or not. If no particles are introduced, no simulation on particle transport is performed by the program regardless of this switch. If at least one particle type is introduced and the "Perform Water Quality Simulation" is set to Yes, particle transport simulation will also be conducted regardless of this option. 
\item \textbf{Perform water quality simulation:} Determines whether water quality simulation should be performed or not when at least one constituent is introduced.
\item \textbf{Preferred lower limit of NR iteration:} The computational engine increases the time step size when the number of iterations needed to achieve convergence is below this number. 
\item \textbf{Preferred upper limit of NR iteration:} The computational engine decreases the time step size when the number of iterations needed to achieve convergence is above this number. 
\item \textbf{Restore Interval:} When a convergence is not achieved after twice reducing the time-step by "time step change coefficient in case of failure", the solution time goes back to a restore interval and continue with a smaller time-step. The "Restore interval" are the number of time-step increments at which restore points are recorded.
\item \textbf{Solution method:} Indicates the solution method used by the solver engine. The only method available at this time is Newton-Raphson. 
\item \textbf{Solution oscillation tolerance: } This is a criteria that is used to assess whether the wiggles in the solution and to adjust the time-step accordingly. When the second time derivative of any of the state variables normalized by the maximum computed value for that state variable up a given time exceeds this value the time-step size is reduced and the iteration at that time is repeated.
\item \textbf{Time step change rate coefficient in case of failure: } This indicates the factor by which the time-step size is reduced if the number of iterations to achieve convergence by the Newton-Raphson algorithm exceeds the "Failure Criteria number of iterations" or that a concentration becomes negative when "Allow Negative Concentration" is set to No. This reduction factor is also used when the solution time goes back to a restore point. 
\item \textbf{Time step change rate coefficient: } The time step is increased or decreased by this factor respectively when the number of iterations to achieve convergence is below "Preferred lower limit of NR iteration" or above "Preferred upper limit of NR iteration". 
\item \textbf{Uniform output export interval: } Indicates whether the outputs should be saved with uniform intervals given in "Initial time step size" or based on the computational time-steps determined by the adaptive time-step algorithm. Setting this option to yes makes the program to interpolate outputs at uniform intervals and save the uniformly timed outputs in the output files. 
\item \textbf{Write solution details: } Switching this option to yes, results in the program creating a file named "Solution\_Details.txt" in the working path folder containing some details of the solver perform ace at every computational time-step. This file is useful to find possible bugs in the model structure defined by the user. 
\item \textbf{Steady-state hydraulics} Switching this option to Yes will result in a quasi steady-state solution of hydraulics. The quasi steady-state solution is based on the assumption of no changes in the storage of blocks and then calculating instantaneous flow rates between the blocks based on this assumption. This option is useful for example when an activated sludge simulation is meant to be performed using GIFMod. 
\end{itemize}
\section{Properties of Blocks}
In this section different media types available in the model are described. Some properties of the blocks are only specific to some of the media types while others may be shared between different blocks. Figure \ref{fig:7} shows different types of media available in GIFMod. The head-storage relationship provided can be altered by the user on a need-based fashion. For example for a pond with a given bathymetry, non-linear head storage relationships may be more appropriate. 
\begin{figure}[!ht]\label{fig:7}
\begin{center}
\begin{tabular}{c c c}
Storage & Saturated Soil & Pond\\
\includegraphics[width=4cm]{Images/Figure7a.png} &
\includegraphics[width=4cm]{Images/Figure7b.png} &
\includegraphics[width=4cm]{Images/Figure7c.png} \\
$h=\frac{S}{A_s\theta_s}-\frac{\epsilon}{s_e^{n_e}}$\\$+pos(\theta-\theta_s)/S_s$ & $h=h_0 + \frac{\theta-\theta_S}{S_s}$ & $h=z_0+\frac{S}{A_s}$\\\hline
\\
Unsaturated Soil & Stream Segment & Overland flow \\
\includegraphics[width=4cm]{Images/Figure7d.png} &
\includegraphics[width=4cm]{Images/Figure7e.png} &
\includegraphics[width=4cm]{Images/Figure7f.png} \\
$h=z_0-\frac{H(\theta_s-\theta)}{\alpha}(s_e^{n/(1-n)}-1)^{1/n}$\\$+pos(\theta-\theta_s)/S_s$ & $h=z_0+\frac{S}{A_s}$ &  $h=z_0+\frac{S}{A_s}$\\
\end{tabular}
\caption{Media types and the head-storage relationship in GIFMod} 
\end{center}
\end{figure}
When two blocks are connected using a "Connector", GIFMod automatically assigns the a default connector by default. However, the connectors can be later altered by the user. When two blocks are of the same type the choice of connector type is consisted with the type of the blocks. For example when the two blocks connected are "Saturated Soil", the Darcy equation controls the flow rate between them. However, when the types of the blocks are not consistent the choice of the default connector sometimes depend on which one is at a higher elevation. Table \ref{table:1} shows the default governing equations assigned by GIFMod when two blocks of certain type are connected. 


\begin{table}[!ht]
\small
\begin{center}
\rotatebox{90}{
\begin{tabular}{c | c c c c c c}
bottom\setminus top & \multicolumn{1}{m{2.4cm}}{Unsaturated Soil} & Pond & Storage & \multicolumn{1}{m{2.4cm}}{Overland Flow} & \multicolumn{1}{m{2.2cm}}{Saturated Soil} & \multicolumn{1}{m{2.5cm}}{Stream Segment} \\
\hline
Unsaturated Soil & VGM $^*$ & VGM & VGM & VGM & VGM & VGM \\
Pond & NA$^{**}$ & DWM$^{***}$ & Darcy & DWM & Darcy & DWM \\
Storage & VGM & Darcy & Darcy & NA & Darcy & NA\\
Overland Flow & NA & NA & NA & DWM & NA & NA\\
Saturated Soil & VGM & Darcy & Darcy & NA & Darcy & Darcy\\
Stream Segment & NA & DWM & NA & DWM & NA & DWM \\
\end{tabular}
}
\caption{Default Q-H relationships based on the blocks connected, *-VGM: Van Genuchten-Maulem, **-NA: No default Q-H equation is available, ***- DWM: Diffusive Wave/Manning}\label{table:1}
\end{center}
\end{table}

In Table \ref{table:1}, "NA" indicates that no default relationship will be assigned if two blocks of the types in the row and column heading are connected. For example if a soil block is connected to an overland flow block when the soil block has a higher elevation GIFMod does not assign any Q-H relationship to the connector by default and the flow rate will be zero unless the user provides a Q-H relationship for the connector. VGM indicated Van Genuchten-Mualem equation for flow rate: 
\begin{equation}
\label{eq:1}
Q_{i,j}=A_sK_e\frac{h_i-h_j}{d}
\end{equation}
where $Q_{i,j}$ is the flow rate from block $i$ to block $j$ and 
\begin{equation}
\label{eq:2}
K_e=K_s s_e^{\lambda} [1-(1-s_e^{1/m})^m]^2
\end{equation}
DWM in Table \ref{table:1} refers to Diffusive Wave/Manning equation based on which the flow rate is calculated as: 
\begin{equation}
\label{eq:3}
Q_{i,j}=n_m \bar{y}^{1+\alpha_m}W\big(\frac{h_i-h_j}{d}\big)^{1/2}
\end{equation}
where $n_m$ is the Manning's roughness coefficient and $\alpha_m$ is the exponent for the hydraulic radius in Manning's equation which is by default set to $2/3$ in ponds and streams and $1/2$ for overland flow but can be altered by the user and $bar{y}=1/2(y_i+y_j)$ is the average water depth in the connector where $y_i=h_i-z_{0,i}$ is the water depth in block $i$. 
A dam can be added to surface water connectors (Stream and Pond) by entering a dam elevation the "Properties" of connectors in which case the Q-H equation becomes: 
\begin{equation}
\label{eq:4}
Q_{i,j}=n_m pos(\bar{y}-H_d)^{1+\alpha_m}W\big(\frac{h_i-h_j}{d}\big)^{1/2}
\end{equation}
The Darcy equation computes the flow as: 
\begin{equation}
\label{eq:5}
Q_{i,j}=A_sK_s\frac{h_i-h_j}{d}
\end{equation}
\subsection{Common properties of blocks}
In the following the properties that are shared between all block types are described: 
\begin{itemize}
\item \textbf{Name: } All components of the model have a name. When a component is added to the model, GIFMod automatically assigns a name to it which can be changed by the user. These names are used to refer to the components in other components and also in the output files generated by the program. The names in each sub-category must be unique. For example two blocks cannot have the same name. However a block and a constituent can have same names. 
\item \textbf{Type:} This indicates the type of the media the block represents. When the blocks are added the type is set according to the toolbar icon used to create the block, however it can be changed by the user. The applicable properties of the block then change according to the newly selected type. 
\item \textbf{SubType:} In soil blocks specifically, the subtype determines the soil type (e.g. loam, sand, etc.) based on which the program assigns default soil parameter values such as saturated hydraulic conductivity and other soil retention parameters. These parameters can be manually altered by the user. 
\item \textbf{Bottom area:} This indicates the top or bottom area of blocks with media type soil, Darcy, overland flow and storage. For ponds and steams the by default the program assumes that the banks are vertical unless specified by the user through the Head-Storage relationship feature. When external fluxes are calculated for ponds and stream segments, this area is used as the interface area between water and air.  This value must be entered. 
\item \textbf{Bottom Elevation: } Specifies the bottom elevation of a block. In the cases when the bottom of a block is thought to be sloped the mean bottom elevation can be used. 
\item \textbf{Build-up: } Using this option, the user can select the contaminant build-up component (section xx.xx) to be assigned to a specific block. In which case the build-up will take place in the block according to the designated build-up component. 
\item \textbf{Constituent initial concentration: } The initial concentration of concentrations of water quality constituents can be assigned to a block using this option. When clicking a window will show up that allows entering the initial concentration of constituents in dissolved or sorbed phases (to soil matrix or particles) to be specified. 
\begin{figure}[!ht]\label{fig:10}
\begin{center}
\includegraphics[width=8cm]{Images/Figure10.png} \\
\caption{Initial Concentration Window} 
\end{center}
\end{figure}
\item \textbf{External flux: } This indicates the external flux model to be assigned to this block. External flux components (section xx.xx) can be used to determine the rates at which constituents are entering to a block typically through atmospheric exchange (e.g aeration). 
\item \textbf{Head-Storage Relationship: } An expression can be entered here to replace the default head-storage relationship for this type of block. 
\item \textbf{Inflow time series: } The inflow rate and water quality characteristics are introduced using this option. An example showing the format of the text file containing the inflow time series is shown in Figure \ref{fig:5}. 
\item \textbf{Particle initial concentration: } The initial concentration of particles in all phases available based on the model they are assigned to {Mobile, Reversibly Attached, Irreversibly Attached} can be entered here. By clicking on this box, a window appear where the user can enter the initial condition for all particle types in different phases (Figure \ref{fig:11}). It should be noted that the concentration of attached particles should be expressed as mass of particles per mass of solid phase (soil matrix) in the case of subsurface components (soil, Darcy, storage) and as mass per surface area in the case of surface components (pond, stream, overland flow). 
\begin{figure}[!ht]\label{fig:11}
\begin{center}
\includegraphics[width=8cm]{Images/Figure11.png} \\
\caption{Initial Particle Concentration Window} 
\end{center}
\end{figure}
\item \textbf{Precipitation: } Indicates whether precipitation will be directly applied to the block or not. By default, surface water blocks (pond, stream, and overland flow) receive direct precipitation while the subsurface blocks (soil, storage, and Darcy) do not. This option allows the user to change this rule. 
\item \textbf{Vapor diffusion: } The flux between the blocks are modeled by GIFMod is modeled based on the following equation:
\begin{equation}
\label{eq:7}
J_{v,i,j}=D_v(\bar{\theta_s}-\bar{\theta})\frac{\theta_i-\theta_j}{d}
\end{equation}
$D_v$ is the vapor diffusion coefficient and $\bar{\theta}=(\theta_i+\theta_j)/2$. 
\item \textbf{Evapotranspiration: } The evaportranspiration model that applies to the block is selected here. The evapotranspiration model should be first introduced as an Evportranspiration model (section \ref{section:3.3}) and then can be selected to be applied to specific blocks. 
\item \textbf{Light: } Indicates whether light will be directly applied to the block or not. If the No option is selected the light intensity at the block will be considered zero throughout the simulation. By default, the option is selected as "Yes" for surface water blocks and "No" for subsurface blocks. 
\item \textbf{Light reduction factor: } The values in the light time-series are multiplied by the value entered in this box to calculate the light intensity at the block. This feature is useful when applying light reduction to deeper layers of a pond for example when light is adsorbed partly at upper layers. The default value is 1. 
\item \textbf{Conduct Reactions: } The user can turn off reactions in a particular block of the model using this option. 
\item \textbf{Length: } The value of this property is assigned to connectors when a array of the block is created if the length is not entered in the array dialog box. Otherwise it is ignored. 
\end{itemize}
In the following the specific properties of each media type is described. 
\subsection{Pond: } This component can be used for any zone that can contain surface water even if it is dry during all or part of the simulation. So a surface water component of a bioretention system, a green roof or a permeable pavement can be modeled as pond. In other words any component where water ponding with free surface can occur can be modeled as a pond. Specific properties of a pond are described in the following:
\begin{itemize}
\item \textbf{Depression storage: } This is the depth of water that is needed to be reached before a flow from the pond to another pond or another surface water block (i.e. stream, catchment) can be initiated. 
\item \textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. 
\item \textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.
\item \textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. 
\end{itemize}
\subsection{Soil: }
Specific properties related to blocks with soil media type are described in this sub-section: 
\begin{itemize}
\item \textbf{SubType} The soil texture can be selected here. When the soil texture is selected, default values for soil hydraulic properties including Van Genuchten $\lambda$, $n$, $\alpha$, Saturated Hydraulic Conductivity, $K_s$, and saturated and residual moisture contents $\theta_s$ and $\theta_r$ are automatically set based on it. The default values are based on \citep{carsel1988}. The values can be later changed by the user. 
\item \textbf{Bulk Density: } Bulk density of soil. 
\item \textbf{Moisture Content: } The user can enter the initial moisture content in the soil block here. 
\item \textbf{Depth: } This indicates the vertical depth/thickness of the soil block. This value must be entered and must be non-zero. 
\item \textbf{Van Genuchten $\lambda$ parameter}: Van Genuchten $\lambda$ parameter Eq. \ref{eq:2} can be entered here. The default value for all soil types is 0.5.
\item \textbf{Storitivity: } The hydraulic head in a block when the soil is super saturated is calculated using the storitivity value. 
\item \textbf{Residual moisture content: } Residual moisture content $\theta_r$ value. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the residual moisture content of the connector when calculating the flow rate using Eq. \ref{eq:2}. 
\item \textbf{Saturated hydraulic conductivity: } Saturated hydraulic conductivity of the soil $K_s$. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:2}. Otherwise, it will be over-written by the value entered for the connector. 
\item \textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:2}. 
\item \textbf{Van Genuchten $\alpha$ parameter: } Van Genuchten $\alpha$ parameter used in equation under the unsaturated soil block in figure \ref{fig:7}. 
\end{itemize}
\subsection{Darcy: }
Specific properties related to blocks with Darcy media (Saturated soil) type are described in this sub-section: 
\begin{itemize}
\item \textbf{Bulk Density: } Bulk density of soil. 
\item \textbf{Initial Moisture Content: } The user can enter the initial moisture content in the soil block here. 
\item \textbf{Depth: } This indicates the vertical depth/thickness of the soil block. If not entered the initial moisture content is assigned to be equal to the saturated moisture content. It should be noted that entering values significantly different than the saturated moisture content can result in very large positive or negative hydraulic heads. 
\item \textbf{Storitivity: } The hydraulic head in a block when the soil is super saturated is calculated using the storitivity value. 
\item \textbf{Saturated hydraulic conductivity: } Hydraulic conductivity of the soil $K_s$ used in Eq. \ref{eq:5}. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:5}. Otherwise, it will be over-written by the value entered for the connector. 
\item \textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. Typically can be assumed equal to the porosity of the media. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:5}. 
\end{itemize}
\subsection{Storage: }
Specific properties related to storage blocks are described in this sub-section: 
\begin{itemize}
\item \textbf{Bulk Density: } Bulk density of storage media. 
\item \textbf{Initial water depth: } The user can enter the initial water depth of the storage block here. 
\item \textbf{Depth: } This indicates the vertical depth/thickness of the storage block. If not entered the initial moisture content is assigned to be equal to the saturated moisture content. It should be noted that entering values significantly different than the saturated moisture content can result in very large positive or negative hydraulic heads. 
\item \textbf{Storitivity: } The hydraulic head in a block when the storage block is super-saturated is calculated using the storitivity value. 
\item \textbf{Saturated hydraulic conductivity: } Hydraulic conductivity of the soil $K_s$ used in Eq. \ref{eq:5}. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturate hydraulic conductivity of the connector when calculating the flow rate using Eq. \ref{eq:5}. Otherwise, it will be over-written by the value entered for the connector. 
\item \textbf{Saturated moisture content: } Saturated moisture content $\theta_s$ value. Typically can be assumed equal to the porosity of the media. If this value is not entered for the connectors connecting the block to other blocks, this value will be used as the saturated moisture content of the connector when calculating the flow rate using Eq. \ref{eq:5}. 
\item \textbf{Suction head coefficient under dry condition: } $\epsilon$ value in figure \ref{fig:7}.
\item \textbf{Suction head power under dry condition: } $n_e$ value in figure \ref{fig:7}.
\end{itemize}
\subsection{Catchment: }
Specific properties related to catchment blocks representing overland flow are described in this sub-section: 
\begin{itemize}
\item \textbf{Depression storage: } This is the depth of water that is needed to be reached before a flow from the pond to another pond or another surface water block (i.e. stream, catchment) can be initiated. 
\item \textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. 
\item \textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.
\item \textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. 
\item \textbf{Dimension: } When arrays of catchment blocks are created, the value entered here will be assigned to the connector lengths created as part of the grid.
\end{itemize}
\subsection{Stream Segment: }
Specific properties related to stream segment are described in this sub-section: 
\begin{itemize}
\item \textbf{Initial water depth: } The initial depth of water at the start time of the simulation is provided here. If left empty, the initial water depth is assumed to be zero. 
\item \textbf{Manning's roughness coefficient: } This indicates the Manning's roughness coefficient for the block. If Manning's roughness coefficient is given for the connectors connecting the block to other blocks, the value given for the connector overwrites the value given for the block when the flow in that particular connector is being calculated. When a grid of blocks is created the value of Manning's roughness coefficient of the block is automatically copied to all the connectors being created in the grid.
\item \textbf{Width: } In case connectors connecting the block to other blocks lacks a value for the width property, the value entered here will be used as its width. When grids of blocks are created, the value entered here will be assigned to the connectors created as part of the grid. 
\end{itemize}

\section{Properties of Connectors}
In this section properties of connectors are described. Some of the properties of connectors are only available for non-default  connectors or when connector connect specific types of blocks. In the following first the properties of connectors common between all connectors are described and then properties specific to certain type of connectors are explained. 

\subsection{Common connector properties}
\begin{itemize}
    \item \textbf{Name: } This field indicates the name of the connector. Name of a connector is used to refer to a connector by other objects in the model and also when generating outputs. By default when a connector a name consisting of the name of the two blocks being connected separated by a dash "-" will be assigned as its name which can be changed by the user. \\
    \textbf{Note: } It is important to note the direction of  connectors (i.e. the start and end blocks). When the flow rates in a block is reported a positive value means flow from the starting block to the target block while a negative value for the flow means flow in the opposite direction. 
    \item \textbf{Type: } Type of a connector dictates its flow-head relationship. When a connector is created the type will be assigned to be "Default". This means that the program automatically assigns a governing equation based on table \ref{table:1}. The non-default connectors include: 
    - \textbf{Darcy: } Indicates that the flow rate of the connector will be calculated based on Darcy's law regardless of the types of blocks being connected. \\
    - \textbf{Normal Flow: } Indicates that the flow rate will be calculated by assuming establishment of Normal flow based on Manning's equation. This means that the hydraulic head int the two blocks being connected will not play a role in determining flow rate but only the bottom slope of the connector will be considered:
    \begin{equation}
    \label{eq:8}
    Q_{i,j}=\frac{z_{0,i}-z_{0,j}}{n_m d}\bar{y}^{\alpha_m+1}W
    \end{equation}
    -\textbf{Pipe: } Hazen-Williams equation will be used to calculated the flow rate between the two connectors. Accommodations is considered for when the pipe is not fully under pressurized condition. 
    \begin{equation}
    \label{eq:9}
    Q_{i,j}=k_{hw}\pi C (\frac{D_p}{2})^{2.63} sgn(h_i-h_j) (\frac{max(h_i,z_{c,i})-max(h_j,z_{c,j}}{d})^{0.54} f_{hw}(\bar{y}_{pipe})
    \end{equation}
    where $y_{pipe}$ is the approximated average depth fraction of the pipe filled: 
    \begin{equation}
    \label{eq:10}
    y_{pipe}=max(\frac{1}{2 D_p}(h_i-z_{c,i}+h_j-z_{c,j}),1) 
    \end{equation}
    and $f$ is approximates the fraction filled area of a partially filled piped:
    \begin{equation}
    \label{eq:11}
    f_{hw}(x)=-2.0255 x^4 + 1.9813 x^3 +1.0318 x^2 + 0.0388 x 
    \end{equation}
 - \textbf{Rating curve: } This option allows using a power equation between head and flow rate to calculate the flow rate through a connector. The form of the equation is: 
    \begin{equation}
    \label{eq:12}
    Q_{i,j}=\alpha_{rc}(h_i-z_{rc})^{\beta_rc}H(h_i-h_j) - \\ \alpha_{rc}(h_j-z_{rc})^{\beta_rc}H(h_j-h_i);
    \end{equation}
- \textbf{User-defined: } The flow will be calculated based on the expression that user enters into the "Flow Expression" field.
\item \textbf{Interface area: } When a connector connects a subsurface block (Soil, Darcy, Storage) to another block, this value is needed and indicates the area of the interface between the two blocks being connected. When surface water blocks (Pond, Stream segment, Catchment) are connected together, the interface area is calculated automatically based on the depth of water but if a number is entered for this property, the area will be assumed constant and equal to the value entered. The interface area is used to calculate constituent fluxes as a result of diffusion and dispersion.   
\item \textbf{Dispersion Expression: } The expression used to calculate dispersion coefficient (different than the constitution-dependent diffusion coefficient) in a connector. If not entered the default expression $D_s = \alpha_D |v_{i,j}|$ will be used. 
\item \textbf{Dispesivity: } The value of dispersivity. If left empty the dispersivity will be considered zero. 
\item \textbf{Length: } This represent the distance between the centroids of blocks being connected. Length is used to calculate hydraulic gradients in flow relationships as well as concentration gradients needed to calculate diffusive and dispersive fluxes. 
\item \textbf{Settling: } Indicates whether settling of particles or settlable constituents can occur through a connector. If set to "Yes"m the direction of settling will be determined based on the bottom elevations of the two blocks connected. 
\item \textbf{Use prescribed flow: } Indicate whether the prescribed flow indicated in the property "Prescribed Flow" to be used as the flow rate or not. If set to "Yes" the flow rates will be taken from the time-series in the input file indicated as "Prescribed Flow". 
\item \textbf{Prescribed flow: } The file containing the prescribed flow to be imposed on a connector will be entered here. The format if a prescribed flow file is the same as other single time-series such as temperature and light.
\end{itemize}
\subsection{Connector properties specific to surface water blocks}
\begin{itemize}
\item \textbf{Flow Exponent: } This indicates the value of $\alpha_m$ in equations \ref{eq:3} and \ref{eq:4}. If not entered a value of $2/3$ will be used by default consistent to Manning's equation. 
\item \textbf{Manning's roughness coefficient: } The value of Manning's roughness coefficient $n_m$ in equations \ref{eq:3} and \ref{eq:4} are to be entered here.
\item \textbf{Width: } Width of the connector. The width is used in calculating flow and interface area between horizontally connected surface water blocks (Eqs. \ref{eq:3} and \ref{eq:4}). 
\item \textbf{Dam elevation: } This property can be used to introduce dams between two blocks. The flow will not be initiated until the water level in one of the blocks exceed the dam elevation. The area of the interface between the two blocks connected will also be calculated as a difference between the hydraulic head and the dam elevation.  
\end{itemize}
\section{Evapotranspiration}\label{section:3.3}
Five alternative evaporation and transpiration models are provided in GIFMod. In addition the user can provide potential evaporation time-series in form of external input files. The evaporation models include Penman, Priestly Taylor and Aerodynamic models and the two transpiration models limit the evaporation based on the soil water stress either based on soil suction head or moisture content. Below each model is described. 
\subsection{Priestly-Taylor model: }
In Priestly-Taylor model \citep{Priestley1972}, the potential evaporation is calculated as:
\begin{equation}
\label{eq:13}
E_a = 1.3\frac{\Delta}{\Delta+\gamma}E_r 
\end{equation}
where $\Delta$ is the gradient of vapor pressure curve:
\begin{equation}
\label{eq:14}
\Delta = \frac{d e_{as}}{dT} = (4098)611\frac{exp(\frac{17.27T}{237.3+T})}{(237.3+T)^2} 
\end{equation}
where $\gamma$ is the psychrometric constant (by default equal to 66.8 Pa/$^oC$) and and $E_r$ is calculated as:
\begin{equation}
\label{eq:15}
E_r = k_r\frac{R_n}{l_v \rho}
\end{equation}
where $l_v$ is the latent heat of evaporation, and $R_n$ is the solar radiation that will be taken from the light time-series. The coefficient $k_e$ is provided as a calibration coefficient to allow adjusting for shading and other effects. 

\subsection{Aerodynamic model: }
In aerodynamic model, the evaporation rate is calculated as: 
\begin{equation}
\label{eq:16}
E_a = k_a u_w e_{as} (1 - R_h)
\end{equation}
where $e_as$ is calculated as: 
\begin{equation}
\label{eq:17}
e_{as} = 611 exp(\frac{17.27T}{237.3+T})
\end{equation}

\subsection{Penman model: }
In Penman model, the potential evaporation is calculated as:
\begin{equation}
\label{eq:18}
E=\frac{\Delta}{\Delta+\gamma}E_r + \frac{\gamma}{\Delta+\gamma}E_a
\end{equation}
\subsection{Transpiration based on soil moisture content: }
The two transpiration models included in GIFMod are used for soils exposed to water uptake by plants and both are based on the aerodynamic model but they limit the transpiration rate based on the soil moisture content or soil matric potential (ref). In the model based on soil moisture content the transpiration through plants is calculated as: 
\begin{equation}
\label{eq:19}
E=E_a min(\frac{\theta-\theta_{wp}}{\theta_{fc}-\theta_{wp}},1)
\end{equation}
\subsection{Transpiration based on soil matric potential: }
In this model, the transpiration through plants is calculated as: 
\begin{equation}
\label{eq:20}
E=E_a min(\frac{h-h_{wp}}{h_{fc}-h_{wp}},1)
\end{equation}
It should be noted that the coefficient $k_a$ in the last two models should encompass the effect of leaf area index (LAI). 
\subsection{Time series: }
This option allows providing evaporation time-series data as external input file. The format of the input file is the same as other time-series data such as light and temperature. 
\subsection{Evaporation model properties: }
\begin{itemize}
    \item \textbf{Rate Expression: } This option allows the user to enter an expression to be used to calculate the evaporation rate. If an expression is entered here it will over-rule the default expression designated based on the selected evaporation model. 
    \item \textbf{Time Series: } If the evaporation model is set to "Time Series", the file containing the evaporation time-series data will be selected using this field. 
    \item \textbf{Uptake Constituents: } This option indicates whether the consitituents should be taken up with the evaporation or not. By default the value of this property is "No" for evaporation models including Penman, Priestly-Taylor, Aerodynamic and time-series and is yes for transpiration models. 
    \item \textbf{Coefficient: } In the aerodynamic, and transpiration models, this value represent the $k_a$ coefficient in Eq. \ref{eq:16}. In Priestly-Taylor model, it represents $k_r$, the calibration coefficient (Eq. \ref{eq:15}). 
    \item \textbf{Psychrometric constant: } The psychrometric constant used in calculating radiation-based evaporation. The default value is 66.8 $Pa/^oC$. 
    \item \textbf{Solar radiation coefficient: } When Penman model is selected, the value of $k_r$ in Eq. \ref{eq:15} can be entered here.
    \item \textbf{wind coefficient: } When Penman model is selected the value of $k_a$ in Eq. \ref{eq:16} in the Penman model, can be entered here.
 \end{itemize}\begin{longtable}{| p{.20\textwidth} | p{.80\textwidth} |}
\caption{Notations} % title of Table
\hline\\
Parameter & Description\\
\hline % inserts single horizontal line
$A_s$ & Bottom area of a block \\
$A_{ij}$ & Interface area of connector $ij$ \\
$C$ & Hazen-Williams roughness coefficient \\
$C_{p,l,i,k}$ & Concentration of constituent $k$ in attached to particle type $p$ in phase $l$ in block $i$ \\
$C_s$ & Saturation concentration \\
$C_{bsat}$ & Saturated surface concentration in build-up \\
$d$ & Effective distance between two blocks \\
$D_{c,p}$ & Diffusion coefficient of particle type $p$\\
$D_s$ & Dispersion coefficient \\
$D_p$ & Pipe diameter \\
$D_{p,ij}$ & Dispersion coefficient for particle type $p$ in connector $ij$\\
$D_{p,ij,k}$ & Effective dispersion coefficient of particle-bound or dissolved constituents \\
$D_v$ & vapor diffusion coefficient \\
$e_{as}$ & Saturated vapor pressure \\
$f_i$ & specific surface area in block $i$ \\
$G_{p,l,i}$ & Particle concentration of particle type $p$ in phase $l$ in block $i$ \\
$G_{s,max}$ & Limiting attached particle concentration \\
$h$ & Hydraulic Head \\
$h_{wp}$ & Wilting point hydraulic head \\
$h_{fc}$ & Field capacity hydraulic head \\
$H_d$ & Dam elevation\\
$J_{v,i,j}$ & vapor flux from block $i$ to block $j$\\
$J_{ext}$ & External flux rate \\ 
$K_{aw}$ & Air-water interface partitioning coefficient for particles \\
$k_a$ & Aerodynamic evaporation coefficient \\
$k_{bld}$ & Build-up rate coefficient \\
$K_e$ & Effective Hydraulic Conductivity \\
$k_{p,rel}$ & release rate coefficient for particle type $p$ \\
$K_s$ & Saturated Hydraulic Conductivity \\
$\textbf{K}_{p,l,l'}$ & Exchange rate coefficient between phase $l$ and $l'$ for particle type $p$ \\
$k_{hw}$ & Unit conversion factor for the Hazen-Williams equation \\
$k_r$ & calibration parameter for light effect in evaporation \\
$k_{ext}$& External flux rate constant \\
$m$ & Van Genuchten $m$ parameter \\
$\dot{m}_{i,p,l,k}$ & External flux or build-up of constituent $k$ in block $i$ \\
$n$ & Van Genuchten $n$ parameter \\
$n_e$ & Suction head power at low moisture conditions for storage blocks \\
$n_m$ & Manning's roughness coefficient\\
$nj$ & number of connectors connected to a block \\
$nl_p$ & number of phases for particle type $p$\\
$np$ & number of particle types + 2 for soil matrix and dissolved phase \\
$nr$ & number of reactions \\
$l_v$ & Latent heat of evaporation \\
$Q_{i,j}$ & Flow rate from block $i$ to $j$\\
$R_h$ & Relative humidity \\
$R_r$ & Reaction rate of reaction $r$ \\
$S$ & Storage\\
$S_{aw}$ & Air-water interface area \\
$S_i$ & Storage of block $i$ \\
$s_e$ & Relative moisture content = $(\theta_s-\theta)/(\theta_r-\theta_s)$ \\ 
$S_s$ & Storativity \\
$T$ & Temperature \\
$\vec{Y}$ & Vector of corresponding predicted model outputs with observed data points\\
$\vec{\tilde Y}$ & Vector of measured values \\
$u_w$ & Wind Speed \\
$\sout{V}$ & Volume of a block \\
$v_i$ & root mean squared velocity in block $i$\\
$v_{i,j}$ & Flow velocity from block $i$ to block $j$ \\
$v_{crit}$ & Critical velocity for particle release \\
$v_{s,p,ij}$ & The projected settling velocity of particle type $p$ in connector $ij$ \\
$v_{c,ij,k}$ & The projected settling velocity of constituent $k$ in connector $ij$ \\
$W$ & Width\\
$z_0$ & Bottom elevation of a block\\
$z_{c,i}$ & The bottom elevation of pipe at block $i$ \\
$z_{rc}$ & Rating curve datum \\
$\alpha$ & Van Genuchten $\alpha$ parameter \\
$\alpha_d$ & Dispersivity \\
$\alpha_m$ & The exponent for hydraulic radius in Manning's equation\\
$\alpha_p$ & Sticking efficiency for particle type $p$ \\
$\alpha_{rc}$ & Rating curve coefficient \\
$\alpha_{ext}$ & Velocity exponent in free surface reaeration model \\
$\beta_{p,l}$ & Mobility factor in phase $l$ for particle type $p$\\
$\beta_{rc}$ & Rating curve power \\
$\beta_{ext}$ & Depth exponent in free surface reaeration model \\
$\Delta$ & Gradient of vapor pressure curve\\
$\epsilon$ & Suction head parameter for storage\\ 
$\phi_{k,p}$ & Sorption capacity of phase or particle type $p$\\
$\gamma$ & psychometric constant \\
$\Gamma_{i,l}$ & Particle capacity of phase $l$ in block $i$ \\
$\Gamma_{i,p,l}$ & Constituent capacity of particle type $p$ in phase $l$ \\
$\vec{\Gamma}$ & Variance-covariance matrix for the observation error \\
$\eta_p$ & collision efficiency for particle type $p$ \\
$\kappa_{k,p,p'}$ & mass exchange rate between particle type $p$ and $p'$ for constituent $k$ \\
$\lambda$ & Van Genuchten $\lambda$ parameter \\
$\theta$ & Moisture content = $S/\sout{V}$ \\
$\theta_s$ & Saturated moisture content \\
$\theta_r$ & Residual moisture content \\
$\theta_{wp}$ & Wilting point moisture content \\
$\theta_{fc}$ & Field capacity moisture content \\
$\Theta$ & Temperature correction factor \\
$\psi_{r,k}$ & Stoichiometric constant for constituent $k$ in reaction $r$ \\
$\vec{\Psi}$ & Vector of unknown model parameters \\
$\rho$ & Water density \\
$\xi_{p,l,i,k}$ & External flux of constituent $k$ into block $i$ as dissolved or particle-bound \\
$\zeta_p$ & Irreversibly collection fraction for particle type $p$ \\
$H()$ & Heaviside function \\
$pos()$ & $pos(x)=x$ if $>0, otherwise = 0$\\
$sgn()$ & $sgn(x)=1$ if $>0, otherwise = -1$ \\
%\hline %inserts single line
\label{table:2} % is used to refer this table in the text
\end{longtable}Several particle types can be introduced in GIFMod each having different properties and different constitutive models can be assigned to each group. The transport of particles in a GI system is governed by the following general mass balance equation: 
\begin{equation}
\label{eq:20}
\begin{split}
\frac{d\Gamma_{i,l} G_{p,l,i}}{dt} =\\ \beta_{p,l} \bigg[\sum_{j=1}^{nj} pos \big(Q_{ij}+v_{s,p,ij}A_{ij}\big)G_{p,l,j}-\sum_{j=1}^{nj} pos \big(-Q_{ij}-v_{s,p,ij}A_{ij}\big)G_{p,l,i}\bigg]\\
-S_i \big(\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}G_{p,l,i}-\sum_{l'=1}^{nl_p}\textbf{K}_{p,l,l'}G_{p,l',i}\big) + \beta_{p,l} \sum_{j=1}^{nj} A_{ij}\frac{D_{p,ij}}{d_{ij}}(G_{p,l,j}-G_{p,l,i})
\end{split}
\end{equation}
In Eq. \ref{eq:20}, the first term on the right hand side is advection due to flow and settling, the second term represents the exchange of particles between phases (i.e. mobile, attached, etc.), and the last term represent dispersion and diffusion of particles. 
Three pre-defined models for particle transport are provided in GIFMod respectively named Single Phase, Dual Phase and Triple Phase. In the single phase model a particle is assumed to only reside in mobile phase with no interaction with the solid phases. If a particle type is designated to be controlled by a dual phase model, it can interact between mobile phase and attached phase. Finally a triple phase model means that particles can be in mobile, reversibly attached and irreversibly attached phases. 
\begin{itemize}
    \item \textbf{Single phase mode: } If a particle type is assigned to have a single phase model, there will be only one phase with $\alpha_{p,1}=1$ and there will be no mass exchange between phases. The interaction between aqueous particles and the air-water interface is assumed to occur instantaneously based on an aqueous -AWI partitioning coefficient $K_{aw}$. $\Gamma$ in Eq. \ref{eq:20} in this case will be a single member vector equal to $S_i + K_{aw} S_{aw}$. By default the air-water interface area is assumed to be proportional to the volume of air-phase (i.e. $S_aw = \sout{V}_i - S_i$) under unsaturated condition in the unsaturated soil block.  
    \item \textbf{Dual phase model: } In a dual phase models particles can be in two phases including mobile and attached. $\Gamma$, $\textbf{K}$ matrix and $\alpha_p$ will respectively be: 
    \begin{equation}
    \label{eq:21}
    \vec{\Gamma}_i = 
    \begin{bmatrix} 
    S_i \\ 
    \sout{V}_i \rho_i 
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:22}
    \vec{K}_p = 
    \begin{bmatrix} 
    0 & f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}}) \\ 
    f_i k_{p,rel}  pos(|v_i|-v_{crit}) & 0\\
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:23}
    \vec{\beta}_p = 
    \begin{bmatrix} 
    1 \\ 
    0 \\
    \end{bmatrix}
    \end{equation}
    
    \item \textbf{Triple phase model: } In a triple phase models particles can be in three phases including mobile and irreversibly attached and reversibly attached. $\Gamma$, $\textbf{K}$ matrix and $\alpha_p$ will respectively be: 
    \begin{equation}
    \label{eq:24}
    \vec{\Gamma}_i = 
    \begin{bmatrix} 
    S_i \\ 
    \sout{V}_i \rho_i \\
    \sout{V}_i \rho_i 
    \end{bmatrix}
    \end{equation}
    \\
    \noindent
    \begin{equation}
    \label{eq:25}
    \noindent
    \vec{K}_p = 
    \begin{bmatrix} 
    0 & \zeta_p f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}}) & (1-\zeta_p) f_i \alpha_p \eta_p \  |v_i| \ (1-\frac{G_{p,s}}{G_{s,max}})\\ 
    0 & 0 & 0\\
    f_i k_{p,rel}  pos(|v_i|-v_{crit}) & 0 & 0\\
    \end{bmatrix}
    \end{equation}
    \\
    \begin{equation}
    \label{eq:26}
    \vec{\beta}_p = 
    \begin{bmatrix} 
    1 \\ 
    0 \\
    0 \\
    \end{bmatrix}
    \end{equation}
\end{itemize}
\subsection{Particle properties}
\begin{itemize}
\item \textbf{Attachment efficiency: } or sticking efficiency $\alpha_p$ in Eqs. \ref{eq:22} and \ref{eq:25}. This is the probability of a particle encountering a collector to stick to it. Not available for single phase particle model. 
\item \textbf{Collection efficiency: } or transport efficiency $\eta_p$ in Eqs. \ref{eq:22} and \ref{eq:25}. The probability of a particle approaching a collector to encounter it. Not available for single phase particle model. 
\item \textbf{Critical velocity for release: } Attached particles will start getting released when the velocity exceeds this value. The rate of release of attached particles is proportional to difference between the velocity in a block and the critical velocity (Eqs. \ref{eq:22} and \ref{eq:25}. Not available for single phase particle model. 
\item \textbf{Diffusion coefficient: } $D_c$, Diffusion coefficient of the particle type beind defined. 
\item \textbf{Dispersivity: } Dispersivity of the particle type. The mechanical dispersion coefficient will be calculated as: $D_{p,ij} = \alpha_{D,p} |v_ij| + D_{c,p}$; 
\item \textbf{Irreversible collection fraction: } $\zeta_p$; in Eq. \ref{eq:25}. Only availble for the triple-phase particle model. 
\item \textbf{Medium bulk density: } if entered this over-writes the bulk density specified in block properties in particle transport module. 
\item \textbf{Partitioning coefficient to air-water interface: } The value of $k_aw$. 
\item \textbf{Settling velocity: } Settling velocity $v_{s,p}$ in Eq. \ref{eq:20}. 
\item \textbf{Specific surface area: } $f$ in Eqs. \ref{eq:22} and \ref{eq:25}
\end{itemize}

\subsection{Example: Colloid transport in a one dimensional saturated soil column under steady flow condition: } 
In this example we show the creation of a simple model of multi-disperse particle transport and filtration in a one-dimensional column under steady-state flow condition using GIFMod. The column will be assumed to have $50cm$ lenght and an area of $100cm^2$ and it which is  descretized into 10 layers. A dummy reservoir will also be added a the bottom of the column to ease imposition of downstream boundary condition through prescribed flow feature.   
\begin{itemize}
\item \textbf{Create the first block and assign the properties: } Add a Darcy block from the top menu. Set the following properties: 
- \textbf{Bottom Area: }\textit{$0.01m^2$}
- \textbf{Depth: }\textit{$0.05m$}
- \textbf{Bulk Density: }\textit{$1600 kg/m^3$}
- \textbf{Saturated moisture content: } \textit{$0.4$}
- \textbf{Initial moisture content: } \textit{$0.4$}
- \textbf{storitivity: } \textit{1$m^{-1}$} 
\item \textbf{Create a vertical array: } Right-click on the block that was just created and then click on "Make grid of blocks" item. Select "Vertical 2D Grid" and then change the number of rows to 10. Click "Ok". \\
- \textbf{Note: } When a vertical grid is made the bottom area of the original block will be copied as the interface area of the connectors. 
\item \textbf{Introducing particles: } We will model three different particle types with three different sticking rate coefficients $alpha_p$ values. In order to introduce the particles, from the Project Explorer right-click on \textbf{Water Quality}$\rightarrow$\textbf{Particles} and then select "Add Particles" from the drop-down menu. 
\item \textbf{Setting particle properties: } Set the following properties for the particle: 
- \textbf{Name: } \textit{Particle I} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: } \textit{1e-6}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\\\\
Add two more particle types with the following properties:
- \textbf{Name: }\textit{Particle II} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: }\textit{1e-5}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\\\\
- \textbf{Name: }\textit{Particle III} 
- \textbf{Attachment Efficiency: }\textit{1}
- \textbf{Collection Efficiency: }\textit{1e-4}
- \textbf{Model: }\textit{Dual Phase}
- \textbf{Specific Surface Area: }\textit{10000$m^-1$}
\item \textbf{Save: } It is now a good time to save the work. 
\item \textbf{Inflow file: } Here we create the inflow file. It is assumed that the flow rate is constant and equal to $0.01m^3/day$ which results in a velocity of $2.5m/day$ over the entire experiment which takes 1 day and the particle concentration for all three types of particles in $10mg/L$ for a period of 1hr and which is followed by no particles in the inflow. The inflow file will look like figure \ref{fig:12}. 
\begin{figure}[!ht]\label{fig:12}
\begin{center}
\includegraphics[width=8cm]{Images/Figure12.png} \\
\caption{Inflow file for particle transport in soil example} 
\end{center}
\end{figure}
Create or download "inflow.txt" from the example folder. Click on block \textbf{Darcy (1)} and choose the inflow file from inflow time series field in the properties dialog box. \\
Right-click on the \textbf{Darcy (1)} block and visualize the time series using \textbf{Plot Inflow Properties} menu item. The inflow concentration for particle I for example should look like Figure \ref{fig:13}
\begin{figure}[!ht]\label{fig:13}
\begin{center}
\includegraphics[width=8cm]{Images/Figure13.png} \\
\caption{Concentration of Particle I in the inflow} 
\end{center}
\end{figure}
\item \textbf{Outflow: } In order to impose the outflow boundary condition a dummy reservoir will be added to the bottom of the soil column. The type of the block used for this reservoir is not important because we will use the \textbf{prescribed flow} feature to control the outflow. Let's use a storage block to create the dummy outflow reservoir. Add a storage by clicking on the storage icon \includegraphics[width=0.5cm]{Icons/storage_icon.png} on the top tool bar. Move the newly added storage block to the bottom of the column and connect it to the block named \textbf{Darcy (10)}. \\
- Enter a non-zero \textbf{length} for the newly added connector and non-zero \textbf{bottom area} and  \textbf{depth} for the newly added storage block. These two values are required for the model to run. Also to prevent the storage block to become over-saturated enter a value of zero in the \textbf{Head-Storage relationship} property of the newly added storage block and set the bulk density of the storage block to \textit{1600$kg/m^3$}. //
\textbf{Note: } Note that if the value of \textbf{Medium Bulk Density} is entered in particle properties of a particle type, it will be used as the media density when performing the mass-balance for that particle class. 
\item \textbf{Outflow rate time-series: } We want the outflow rate to be equal to the inflow rate. This can be accomplished in two ways. One is to turn on the "Steady State Hydraulics" in the \textbf{Setting$\rightarrow$Project Settings} or by assigning a \textbf{prescribed flow} to the bottom connector. We are going to use the second approach here. The flow time series to be prescribed to the \textbf{Darcy (10)-Pond (1)} connector should look like Figure \ref{fig:14}. Name the file "outflow.txt". 
\begin{figure}[!ht]\label{fig:14}
\begin{center}
\includegraphics[width=8cm]{Images/Figure14.png} \\
\caption{Outflow file} 
\end{center}
\end{figure}
Please note that the heading file in figure \label{fig:14} is ignored by the program and is only necessary for user documentation. \\
- Click on the \textbf{Darcy (10)-Pond (1)} connector, and choose "outflow.txt" from the \textbf{Prescribed flow} property. \\
- Set \textbf{Use Prescribed Flow} to "Yes". \\
- Save the project. 
- Now the model is ready to run. Click on the run icon \includegraphics[width=0.5cm]{Icons/run_icon.png} on the left side tool bar and wait for the simulation to end. \\
- Right-click on the block named \textbf{Darcy (10)} and choose \textbf{Water Quality Results$\rightarrow$ Pericles I$\rightarrow$ Mobile} to see the breakthrough curve for particle type I \\
Do the same thing for \textbf{Particle II} and \textbf{Particle III}. 
Right-click on the graph containing particle II results and click on \textbf{Copy Curve} item, then click on the graph containing particle type I results, right-click and select \textbf{Paste} item. \\ - Do the same thing with particle III to see the three breakthrough curves for the three particle types in a single graph. You can change the format of each curve by right-clicking on the graph and selecting the name of each curve (fig \ref{fig:30}).
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure30.png} \\
\caption{Particle breakthrough curves for the three particle classes}\label{fig:30}
\end{center}
\end{figure}

\end{itemize}
\newpage
\subsection{Example: Particle settling in a one-dimensional water body: } 
In this example we create a simple model of particles settling in a one dimensional water column. Similar to the previous example, three particles classes will be considered but this time their settling velocities will be different. We will use an array of storage block to create water column. The water column is assumed to have a height of 1.5m which is descritized into 10 equally sized layers each represented by a single storage block. The particles are assumed to be initially uniformly distributed and are allowed to settle under gravity. 
\begin{itemize}
\item \textbf{Create a new project} \\
\item \textbf{Introducing particle classes: } 
From the \textbf{Project Explorer} right-click on \textbf{Water Quality}$\rightarrow$\textbf{Particles} and then select "Add Particles" from the drop-down menu. 
\item \textbf{Setting particle properties: } Set the following properties for the particle: 
- \textbf{Name: } \textit{Particle I} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{10$m/day$}
\\\\
Add two more particle types with the following properties:
- \textbf{Name: } \textit{Particle II} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{1$m/day$}
\\\\
- \textbf{Name: } \textit{Particle III} 
- \textbf{Model: }\textit{Single Phase}
- \textbf{Settling velocity: }\textit{0.1$m/day$}

\item \textbf{Save: } It is now a good time to save the
\item \textbf{Create a storage block and set the properties: } Add a storage by clicking on the storage icon \includegraphics[width=0.5cm]{Icons/storage_icon.png} on the top tool bar. \\
- Set the following properties for the storage block:
- \textbf{Bottom Area: }\textit{10$m^2$}
- \textbf{Depth: }\textit{0.15m} \\
- \textbf{Initial water depth: }\textit{0.15m} \\
- \textbf{Saturated moisture content: } \textit{1} (There is no solid media in the storage blocks) \\ 
- \textbf{Initial particle concentration: } Click on the "..." symbol in front of the \textbf{Particle Initial Concentration} label in properties windows and enter a concentration of 10 for the three particle classes as is shown in figure \ref{fig:17}.  \\
\begin{figure}[!ht]\label{fig:17}
\begin{center}
\includegraphics[width=8cm]{Images/Figure17.png} \\
\caption{Particle initial concentration} 
\end{center}
\end{figure}
- \textbf{Creating an array of storage blocks: } Right-click on the storage block that was just created and choose \textbf{Make Grid of Blocks} item from the menu. Choose \textbf{vertical 2D grid} option and enter 10 in the \textbf{Number of rows} box. 
\item \textbf{Turn settling on for all the connectors: } By default the settling option for the connectors is set to \textbf{No}. In order to allow settling transport to occur via connectors the \textbf{Settling} option should be turned to \textbf{Yes}. Select all the connectors one by one and set the \textbf{Settling} property to \textbf{Yes}.
\item \textbf{Run the model: } Click on the run bottom on the left hand side tool bar \includegraphics[width=0.5cm]{Icons/run_icon.png} and wait for the simulation to end. 
\item \textbf{Checking the results: } Right click on the \textbf{Storage (10)} block and choose \textbf{Plot Water Quality Results}$\rightarrow$\textbf{Particle I}$\rightarrow$\textbf{Mobile} to see the temporal variation of \textbf{Particle I} particle class at the bottom of the column. Do the same thing for \textbf{Particle II} and \textbf{Particle III} particle groups. You can copy and paste all curves into one window to compare the results for each particle class (Figure \ref{fig:31}). 
\begin{figure}[!ht]
\begin{center}
\includegraphics[width=8cm]{Images/Figure31.png} \\
\caption{Particle initial concentration}\label{fig:31} 
\end{center}
\end{figure}
\item \textbf{Adding particle diffusion: } Change \textbf{Diffusion coefficient} for all the particles to 0.1$m^2/day$ by clicking on each particle size from \textbf{Project Explorer}$\rightarrow$\textbf{Water Quality}$\rightarrow$\textbf{Particles}$\rightarrow$ and changing the \textbf{diffusion coefficient} property of all particles to 0.1$m^2/day$ .Run the simulation again. The diffusion should prevent all particles to settle to the bottom block. 

\end{itemize}This chapter is intended to serve as a quick start guide by showing the steps needed to create a simple model of a pond with a simple water quality process consisting of a single hypothetical contaminant (named PCB) undergoing first order decay. The pond is assumed to be divided into two compartments where one of the compartments receive contaminants from a stream and the second compartment discharges into an imaginary adjacent receiving water body (conceptually represented in Figure \ref{fig:1}a). Figure \ref{fig:1}b shows the temporal variation of water flow rate and PCB concentration in the inflow. The outflow rate is assumed to be controlled by a weir with a given rating curve to be discussed later. \\

\begin{figure}[!ht]
\begin{center}
\begin{tabular}{c c}
a) \includegraphics[width=7cm]{Images/Figure1a.png} \\
b) \includegraphics[width=7cm]{Images/Figure1b.png} \\
\end{tabular}
\caption{a) Schematic of the single two compartment pond model, b) Temporal variation of the hypothetical water flow and contaminant concentration into the pond} \label{fig:1}
\end{center}
\end{figure}

Below are the steps to set up the model:
1- \textbf{Launching the program and creating a project: } Launch GIFMod program through the start menu by first choosing the GIFMod folder and clicking on GIFMod icon or the icon on the desktop.\\
\begin{figure}[!ht]\label{fig:2}
\begin{center}
\includegraphics[width=5cm]{Images/Figure2.png} \\
\caption{GIFMod icon in the start menu} 
\end{center}
\end{figure}
2) \textbf{Setting the duration of the project: }
\begin{itemize}
\item From the Project Explorer window on the right hand side of the screen select \textbf{Settings} and then click on \textbf{Project Setting}. 
\item Scroll down the "Property" window on the bottom right side of the screen until you see the item labeled "Simulation End Time", and pick 4/9/1900 as the end date of the project from the date picker. This essentially makes the duration of simulation to be 100 days starting from day zero and ending at day 100.  
\end{itemize}
3) \textbf{Add a pond to the model: } Add a pond by clicking on the pond icon on the top toolbox (Figure \ref{fig:2}).
4) \textbf{Assigning the properties of the pond: }
Click on the pond object added to the project so it's properties appear in the \textbf{Properties} window on the lower right side of the screen. 
\begin{itemize}
\item From the "Property" window change the name of the object from the default "Pond (1)" to "Main Pond".  
\item Change the bottom area to $1000 m^2$. \\
\textbf{Note:} Most physical properties can be entered using multiple units provided in the drop-down menu adjacent to the text boxes where they are entered. 
\begin{figure}[!ht]\label{fig:3}
\begin{center}
\includegraphics[width=8cm]{Images/Figure3.png} \\
\caption{Adding a pond} 
\end{center}
\end{figure}
\item Using the properties window, set "Initial Water Depth" to 2m. 
You can now run the model. Click on the "forward run" icon \includegraphics[width=0.5cm]{Icons/run_icon.png} on the left side of the screen. 
\item The run window should appear and you can see the simulation as it progresses. The graph in the run window shows the time step sizes being used during the simulation. Because the model in this case is very simple, the time step size keeps linearly increasing. 
\item To see the results right click on the "Main Pond" block and select "Water Depth" from the "Plot Hydraulic Results" menu. As it is expected the water depth remains constant at 2m since no inflows are entering the pond and now outflows are leaving it. 
\end{itemize}
5) \textbf{Adding the second pond: }
The second pond can be added similarly to the first pond but another feature of the program called "Grid" can also be used to create it. Let's explore that here. 
\begin{itemize}
\item Right click on the "Main Pond" and select "Make Grid of Blocks" from the drop-down menu. 
\begin{figure}[!ht]\label{fig:4}
\begin{center}
\includegraphics[width=6cm]{Images/Figure4.png} \\
\caption{Grid Dialog Box} 
\end{center}
\end{figure}
\item Leave the "Horizontal 2D grid" checked and change the "Number of Columns" to 2. 
\item Type 50 in the text box labeled as "Horizontal distance between cells in x direction". This distance is the presumed distance between the centroids of each pond that will be used to calculated the hydraulic gradient for flow and concentration gradients for calculating diffusive/dispersive flux. Press "OK" to generate the grid. The grid feature automatically connects the blocks that are generated together. It is assumed that the bottom elevation of the two compartments are equal. 


\textbf{Notes:}
\begin{itemize}
\item The newly created block also will have the same properties as the original block. 
\item The connector connecting two blocks will by default gets its name as the combination of the blocks being connected.
\end{itemize}
\item Now we need to set up the properties of the connector and the newly generated block. Click on the newly generated block and from the "Properties" window, change the name to "Embayment".
- Click to select the connector connecting the two blocks. Because the name of the second block at the time of creation has been "Main Pond (1)", the name of the connector will be assigned as "Main Pond - Main Pond (1)", however the name can now be changed to anything else. Let's call it "Main-Embayment". 
\item From the "Properties" dialog change the "Manning Roughness coefficient" to 0.11 and "Width" to 30 m. The width represent the cross sectional width of the pond at the interface between the two compartments. 
\end{itemize}
6) \textbf{Adding the receiving water body:}
Adding a dummy block to represent the receiving water body is useful from several points of view. First it make imposing the downstream boundary easy and secondly it can help obtaining information about the flow volume and total contaminant loading into the receiving water body. 
\begin{itemize}
\item Add another pond. Change the name of the pond to "Receiving water". Assign an "Bottom Area" of 10000 $m^2$. This is not important as we will fix the head of the receiving water body later to make sure there will be no back-flow from it into the ponds. In order to do that type -1 or any other negative value for the property called "Head-Storage relationship". The "Head-Storage relationships" box provides a way for the user to specify a user defined Head-Storage relationship to replace the default hydrostatic relationship. By typing the -1 value the hydraulic head of the receiving water body will be -1 regardless of its storage. 
\item Connect the "Embayment" block to the receiving water block by clicking on the edge of the first and dragging to the second when the cursor sign turns to a cross. 
\item Set the lenght of the newly added connector to 1.0. The value entered here does not affect the result of the simulation because we 
\end{itemize}

7) \textbf{Setting the connector to the "receiving water" to behave as a weir: }
Click on the "Embayment-Receiving water" connector. From the "properties" window change the type to "Rating curve". The following equation is used for rating curves: $Q=Coefficient(h-Datum)^{Exponent}$. Set the exponent to 2.0 and coefficient to 200 and the datum to 1.8m. This means the flow will occur only if the water depth is above 1.8m. 

8) \textbf{Setting the inflow time-series}:
The inflow files are provided as text files with .csv format. Flow rate and concentration of constituents or particles are provided in a single file for each inflow. Two columns for each constituent is needed, the first one indicating time and the second, the value of the constituent. This allows introducing flow and each constituent with it's own time increment. The time increments in the inflow file do not need to be uniform as the program interpolate the values at the computational time step. When the length of time series for different constituents are different, the terminated time-series should be filled with ", ,". The inflow files should have a heading line specifying the nature of each pair of columns. Figure \ref{fig:5} shows an example inflow file structure. The "names" keyword in the heading indicates that the names of the constituents in the inflow are indicated in that line. The inflow file used in this tutorial is provided in the example folder. Here we include PCB concentration in the inflow although as long as the constituent PCB has not been indicated in the model, the entries related to PCB will be ignored. As it is seen in Figure \ref{fig:5} the PCB concentration time-series in the inflow is shorter than the flow rate and the empty cells corresponding PCB are left blank. 
\begin{figure}[!ht]\label{fig:5}
\begin{center}
\includegraphics[width=5cm]{Images/Figure5.png} \\
\caption{A sample inflow input file} 
\end{center}
\end{figure}
\begin{itemize}
\item To add the inflow to the main pond first select the "Main Pond" and then click on the box labeled "Inflow Time Series" in the "Properties" window.
\item Select the file called "inflow.txt" using the file dialog box and click Ok. 
\item Right-click on the "Main Pond" block and choose "Plot Inflow Properties" and then click on the "Flow" item. A graph window will appear where the flow rate is shown. \\
The hydraulic component of the model is ready and now the model can be run.
\end{itemize}
9) \textbf{Running the hydraulic module: }
\begin{itemize}
\item Click on the run icon \includegraphics[width=0.5cm]{Icons/run_icon.png} on the left hand side tool bar. And wait until the simulation is over. You can also check the warnings show in the "Log Window". 
\item when the simulation is done, right-click on the main pond and choose "Plot Hydraulic Results" and the click on "Water Depth". A graph showing the water depth variation in the "Main Pond" over the course of simulation will appear. 
\item Right click on the connector connecting the Embayment to the "Receiving Water" and choose "Flow". A graph showing the discharge flow rate variation vs. time will appear. You can inspect other results available for other blocks or connectors similarly. 
\end{itemize}
10) \textbf{Adding a water quality constituent: }
\begin{itemize}
\item Click on the "Water Quality" item in the "Project Explorer" window, then right-click on the "Constituents" item and click on "Add Constituent" from the drop-down menu.
\item Click on the "Constituent" that was just added.
\item Change the name of the constituent to "PCB" from the Properties window. 
\item Leave the other properties unchanged. At this time we will ignore diffusive exchange of PCB between the blocks. 
\end{itemize}
11) \textbf{Adding a reaction: }
\begin{itemize}
\item Right click on "Reaction Parameters" item from \textbf{Project Explorer $\rightarrow$ Water Quality $\rightarrow$ Reactions $\rightarrow$ Reaction Parameters} and click on "Add Reaction Parameters". 
\item Using the "Properties" window, change the name of the parameter to "kd" (decay rate) and change the value to 0.02 meaning 0.02 $day^{-1}$. \\
\textbf{Note: } The time dimension for all reaction parameters is day.\\
\item Right-click on reaction network under \textbf{Water Quality$\rightarrow$Reactions}. The window shown in Figure \ref{fig:6} will appear. This window allows entering Peterson's matrix representing the reactions between the constituents. 
\begin{figure}[!ht]\label{fig:6}
\begin{center}
\includegraphics[width=9cm]{Images/Figure6.png} \\
\caption{Reactions Window} 
\end{center}
\end{figure}
\item Enter "Decay" under "Process Name".
\item Enter "kd*PCB" under "Process Rate" heading. This means that PCB is undergoing a first-order decay with a rate constant of "kd". \\
\textbf{Note: } Any other expression including numerical values can be used both for process rates and stoichiometries. So in this case typing $0.02*PCB$ as the process rate would have the same effect. \\
\item Enter -1 under the column with heading "PCB". This indicates the stoichiometric coefficient of PCB in this process. The negative sign indicates that PCB is being consumed as the reaction proceeds and the value of 1 means that for each unit of process proceeding, one unit concentration of PCB is being consumed. 
\item Close the reactions window. 
\item Click on "Solver" under "Setting" in the Project Explorer window make sure that the property "Perform Water Quality Simulation" is set to "Yes". 
\item Run the model. 
\item After the simulation is done, right click on the "Main Pond" block and click on "PCB" under "Water Quality Results" item. Similarly you can inspect the temporal variation of PCB concentration in any other blocks. 
\end{itemize}
The water quality model in GIFMod has two major components including particle fate transport and constituent transport. The physical processes affecting each of these classes of water quality constituents are different but some processes are also shared between them. Constituents can be set to interact with particles through rate-limited sorption-desorption processes. In this chapter, first the governing equations for the transport of particles and constituents are presented and then the properties that can be assigned to "Particle" and "Constituent" group in GIFMod are described. 
\section{Transport of Solid Particles}
\input{Particles.tex}

\section{Transport and Transformation of Dissolved and Solid-Associated Water Quality Constituents}
\input{Constituents.tex}

\subsection{External flux and aeration}\label{sssec:ExtFlux}
\input{External_Flux.tex}

\subsection{Build-up}\label{sssec:Buildup}
\input{Build-up.tex}
